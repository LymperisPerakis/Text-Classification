                                                                                             EVALUATION KIT AVAILABLE
MAX35104                                                                              Gas Flow Meter SoC
General Description                                          Benefits and Features
The MAX35104 is a gas flow meter system-on-chip (SoC)        ●● High Accuracy Flow Measurement for Billing and
targeted as an analog front-end solution for the ultrasonic     Leak Detection
gas meter and medical ventilator markets. With a time           • Time-to-Digital Accuracy Down to 700ps
measurement accuracy of 700ps and automatic differen-              Measurement Range Up to 8ms
tial time of flight (TOF), the device makes for simplified      • 2 Channels: Single-Stop Channel
computation of gaseous flow.                                 ●● High Accuracy Temperature Measurement for Precise
Power consumption is the lowest available with ultra-low        Flow Calculations
62µA time-of-flight measurement and 125nA duty-cycled           • One 2-Wire Sensor: PT1000, PT500 RTD, and
temperature measurement. Multi-hit (up to six per wave)            Thermistor Support
capability with stop-enable windowing allows the device to   ●● Maximizes Battery Life with Low Device and Overall
be fine-tuned for the application. Internal analog switches,    System Power
a configurable three-stage integrated operational ampli-        • Ultra-Low 62µA TOF Measurement and 125nA
fier chain amplifier, and an ultra-low input offset compara-       Duty-Cycled Temperature Measurement
tor provide the analog interface and control for a minimal      • Event Timing Mode with Randomizer Reduces
electrical bill of material solution. A programmable high-         Host μC Overhead to Minimize System Power
voltage (up to 30V) pulse launcher provides up to 19dB of          Consumption
transducer launch amplitude adjustment to compensate            • 2.3V to 3.6V Single-Supply Operation
for transducer aging and temperature, pressure, humidity
                                                             ●● High Integration Solution Minimizes Parts Count and
affects. Early edge detection ensures measurements are
                                                                Reduces BOM Cost
made with consistent wave patterns to greatly improve
                                                                • Built-In Real-Time Clock
accuracy and eliminate erroneous measurements. Built-in
                                                                • Small, 5mm x 5mm, 40-Pin TQFN Package
arithmetic logic unit provides TOF difference measure-
                                                                • -40°C to +85°C Operation
ments and programmable receiver hit accumulators to
minimize the host microprocessor access. For tempera-
ture measurement, the device supports a single 2-wire
PT1000 platinum resistive temperature detector (RTD) or
NTC thermistor. A simple 4-wire SPI interface allows any
microcontroller to effectively configure the device for its  Ordering Information appears at end of data sheet.
intended measurement.
Applications
●● Ultrasonic Gas Meters
●● Medical Ventilators
19-8501; Rev 3; 12/17


MAX35104                                                                                                                              Gas Flow Meter SoC
                                                           TABLE OF CONTENTS
General Description  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1
Benefits and Features . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1
Absolute Maximum Ratings  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 6
Package Thermal Characteristics . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 6
Recommended Operating Conditions . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 6
Electrical Characteristics . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 6
Recommended External Crystal Characteristics  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 11
Timing Diagrams . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 11
Pin Configuration . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 13
Pin Description  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 13
Block Diagram . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 16
Detailed Description  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 16
   Time-of-Flight (TOF) Measurement Operations  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .  17
       Pulse Echo TOF Mode . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .  19
       Early Edge Detect . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .  19
       TOF Error Handling . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .  20
   Step-Up DC-DC Controller  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .  20
       Control and Operation  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .  20
       Compensation Component Values . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .  21
       RSENSE . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .  21
       Kelvin Sense . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .  21
       Power Transistor . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .  21
       Inductor (L)  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .  23
       Diode . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .  23
       Output Filter Capacitor . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .  23
   Piezo Driver Regulator . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .  23
       Output Capacitor Selection . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .  23
   Transducer Driver . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .  23
   Analog Front-End . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .  24
   Temperature Measurement Operations . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .  26
       Temperature Error Handling . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .  26
   Event Timing Operation . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .  27
       Continuous Event Timing Operation . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .  27
       Continuous Interrupt Timing Operation  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .  27
       TOF Sample Randomizer . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .  27
       Event Timing Mode 2  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .  28
       Event Timing Mode 3  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .  30
       Event Timing Mode 1  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .  30
www.maximintegrated.com                                                                                                                                  Maxim Integrated │ 2


MAX35104                                                                                                                             Gas Flow Meter SoC
                                            TABLE OF CONTENTS (continued)
   Calibration Operation . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .  30
       Error Handling during Calibration . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .  32
   RTC, Alarm, Watchdog, and Tamper Operation . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .  32
       RTC Operation  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .  32
       Alarm Operation . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .  32
       Watchdog Operation . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .  34
       Tamper Detect Operation . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .  34
   Device Interrupt Operations . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .  34
       Interrupt Status Register . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .  34
       INT Pin  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .  34
   Serial Peripheral Interface Operation  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .  34
   Opcode Commands . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .  34
Execution Opcode Commands . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 35
   TOF_UP Command (00h)  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .  35
   TOF_Down Command (01h)  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .  35
   TOF_DIFF Command (02h) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .  35
   Temperature Command (03h)  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .  36
   Reset Command (04h) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .  36
   Initialize Command (05h) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .  36
   Bandpass Calibrate Command (06h) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .  36
   EVTMG1 Command (07h) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .  36
   EVTMG2 Command (08h) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .  36
   EVTMG3 Command (09h) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .  36
   HALT Command (0Ah) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .  36
   Calibrate Command (0Eh) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .  36
Register Opcode Commands . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 37
   Read Register Command . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .  37
   Write Register Command . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .  37
   Register Memory Map . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .  39
   RTC and Watchdog Register Descriptions  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .  45
   Configuration Register Descriptions  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .  48
   Conversion Results Register Descriptions  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .  73
Ordering Information . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 79
Chip Information  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 79
Package Information . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 79
Revision History  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 80
www.maximintegrated.com                                                                                                                                 Maxim Integrated │ 3


MAX35104                                                                                                                   Gas Flow Meter SoC
                                                      LIST OF FIGURES
Figure 1. SPI Timing Diagram Read . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 11
Figure 2. SPI Timing Diagram Write . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 12
Figure 3. Time-of-Flight Up Measurement Sequence  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 17
Figure 4. Start/Stop for Time-to-Digital Timing  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 18
Figure 5A. Pulse Echo Measurement Mode . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 19
Figure 5B. Early Edge Detect Received Wave Example  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 20
Figure 6. Boost Circuits Components . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 21
Figure 7. Kelvin Sense Connection Layout Example . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 22
Figure 8. Piezo Driver Connection . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 24
Figure 9. Analog Front-End  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 25
Figure 10. Temperature Command Execution Cycle Example . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 28
Figure 11. EVTMG2 Command . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 29
Figure 12. EVTMG2 Pseudo Code . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 29
Figure 13. EVTMG3 Command  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 31
Figure 14. EVTMG3 Pseudo Code . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 31
Figure 15. EVTMG1 Pseudo Code . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 32
Figure 16. EVTMG1 Command . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 33
Figure 17. Execution Opcode Command Protocol . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 35
Figure 18. Read Register Opcode Command Protocol  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 37
Figure 19. Continuous Read Register Opcode Command Protocol . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 38
Figure 20. Write Register Opcode Command Protocol  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 38
Figure 21. Continuous Write Register Opcode Command Protocol . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 39
                                                       LIST OF TABLES
Table 1. Two’s Complement TOF_DIFF Conversion Example . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 18
Table 2. RSENSE Example Values . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 22
Table 3. Example Gain Settings . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 26
Table 4. Randomizer Sampling . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 27
Table 5. Opcode Commands  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 35
Table 6. Register Memory Map . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 40
Table 7. RTC Seconds Register  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 45
Table 8. RTC Mins_Hrs Register  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 45
Table 9. RTC Day_Date Register . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 46
Table 10. RTC Month_Year Register . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 46
www.maximintegrated.com                                                                                                                       Maxim Integrated │ 4


MAX35104                                                                                                                      Gas Flow Meter SoC
                                           LIST OF TABLES (continued)
Table 11. Watchdog Alarm Counter Register . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 47
Table 12. Alarm Register . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 47
Table 13. Switcher 1 Register . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 48
Table 14. Switcher 2 Register . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 50
Table 15. AFE 1 Register  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 52
Table 16. AFE 2 Register  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 53
Table 17. TOF1 Register . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 54
Table 18. TOF2 Register . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 56
Table 19. TOF3 Register . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 58
Table 20. TOF4 Register . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 59
Table 21. TOF5 Register . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 60
Table 22. TOF6 Register . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 61
Table 23. TOF7 Register . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 63
Table 24. Event Timing 1 Register  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 65
Table 25. Event Timing 2 Register  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 66
Table 26. TOF Measurement Delay Register . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 67
Table 27. Calibration and Control Register . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 68
Table 28. Real-Time Clock Register . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 70
Table 29. Interrupt Status Register . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 71
Table 30. Control Register  . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 72
Table 31. Conversion Results Registers Description . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 73
www.maximintegrated.com                                                                                                                          Maxim Integrated │ 5


MAX35104                                                                                                                                       Gas Flow Meter SoC
Absolute Maximum Ratings
(Voltage relative to ground.)                                                                         Operating Temperature Range.............................-40ºC to +85ºC
Voltage Range on VCC Pins.................................-0.5V to +4.0V                              Junction Temperature....................................................... +150ºC
Voltage Range on All Other                                                                            Storage Temperature Range..............................-55ºC to +125ºC
    Pins (not to exceed 4.0V)...................... -0.5V to (VCC + 0.3V)                             Soldering Temperature (reflow)........................................ +260ºC
Voltage Range on High Voltage Pins.....................................32V                            Lead Temperature (soldering, 10s).................................. +300ºC
Continuous Power Dissipation (TA = +70ºC)                                                             ESD Protection (All Pins, Human Body Model).................±500V
    TQFN (derate 35.70mW/ºC above +70ºC)............2857.10mW
Stresses beyond those listed under “Absolute Maximum Ratings” may cause permanent damage to the device. These are stress ratings only, and functional operation of the device at these
or any other conditions beyond those indicated in the operational sections of the specifications is not implied. Exposure to absolute maximum rating conditions for extended periods may affect
device reliability.
Package Thermal Characteristics (Note 1)
TQFN
    Junction-to-Ambient Thermal Resistance (θJA)...........28°C/W                                         Junction-to-Case Thermal Resistance (θJC)..................2°C/W
Note 1: Package thermal resistances were obtained using the method described in JEDEC specification JESD51-7, using a four-layer
             board. For detailed information on package thermal considerations, refer to www.maximintegrated.com/thermal-tutorial.
Recommended Operating Conditions
(TA = -40°C to +85°C, unless otherwise noted.) (Notes 2, 3)
                PARAMETER                           SYMBOL                                   CONDITIONS                                   MIN           TYP             MAX         UNITS
 Supply Voltage                                        VCC                                                                                  2.3          3.3             3.6           V
 Input Logic 1 (RST, CSW, SCK,
                                                        VIH                                                                            VCC x 0.7                   VCC + 0.3           V
 DIN, CE)
 Input Logic 0 (RST, CSW, SCK,
                                                        VIL                                                                                -0.3                    VCC x 0.3           V
 DIN, CE)
 Input Logic 1 (32KX1)                              VIH32KX1                                                                           VCC x 0.85                  VCC + 0.3           V
 Input Logic 0 (32KX1)                              VIL32KX1                                                                               -0.3                  VCC x 0.15            V
Electrical Characteristics
(VCC = +2.3V to +3.6V, TA = -40°C to +85°C, unless otherwise noted. Typical values are at VCC = 3.3V and TA = +25°C.) (Notes 2, 3)
                PARAMETER                           SYMBOL                                   CONDITIONS                                   MIN           TYP             MAX         UNITS
 Input Leakage (CSW, RST,
                                                         IL                                                                               -0.1                          +0.1          µA
 SCK, DIN, CE, CIP, CIN)
 Output Leakage (INT, WDO,
                                                        OL                                                                                -0.1                          +0.1          µA
 T1,T2)
 Output Voltage Low (32KOUT)                         VOL32K            2mA                                                                                         0.2 x VCC           V
 Output Voltage High (32KOUT)                        VOH32K            -1mA                                                            0.8 x VCC                                       V
 Output Voltage High
                                                       VOH             -4mA                                                            0.8 x VCC                                       V
 (DOUT, CMP_OUT/UP_DN)
 Output Voltage High (TC)                             VOHTC            VCC = 3.6V, IOUT = -4mA                                             3.4                                         V
 Output Voltage Low (WDO,
                                                        VOL            4mA                                                                                         0.2 x VCC           V
 INT, DOUT, MP_OUT/UP_DN)
 Pulldown Resistance (TC)                              RTC             ITC                                                                650          1000             1750           Ω
www.maximintegrated.com                                                                                                                                           Maxim Integrated │ 6


MAX35104                                                                                         Gas Flow Meter SoC
Electrical Characteristics (continued)
(VCC = +2.3V to +3.6V, TA = -40°C to +85°C, unless otherwise noted. Typical values are at VCC = 3.3V and TA = +25°C.) (Notes 2, 3)
          PARAMETER                SYMBOL                      CONDITIONS                    MIN       TYP      MAX       UNITS
 Input Voltage Low (TC)               VILTC                                                         0.36 x VCC               V
 Pulldown (RXP, RXN)                            AFE_BP = 0, pins disabled                               80                  µA
 Resistance (T1, T2)                   RON                                                              1.5                 Ω
 Input Capacitance (CE, SCK,
                                        CIN     Not tested                                               7                  pF
 DIN, RST, CSW)
 RST Low Time                          tRST                                                                      100        ns
 CURRENT
 Standby Current                       IDDQ     No oscillators running                                            10        µA
 32kHz OSC Current                   I32KHZ     32kHz oscillator only, VCC = 3.6V                      0.42        1        µA
 4MHz OSC Current                     I4MHZ     4MHz oscillator only, VCC = 3.6V                        82       135        µA
 Time Measurement Unit
                                    ICCTMU      VCC = 3.3V                                              4.3        8        mA
 Current
 Calculator Current                 ICCCPU                                                              1.2        3        mA
                                                VCC = 3.3V, TOF_DIFF = 2 per second,
 Device Current Drain                   ICC                                                             62                  µA
                                                temperature = 1 per 30 seconds
 TRANSMITTER: BOOST SWITCHER
                                                                                                         9
 Output Voltage Range                                                                                                        V
                                                                                                        30
 Programmable Output Voltage
                                                                                                        1.7                  V
 Step Size
 Output Switching Frequency                                                                  100                 200       kHz
 Current-Limit Trip Level           VCS-SW                                                   100       150       200       mV
 TRANSMITTER: FET GATE DRIVER
 External FET Gate Charge               QG                                                                         2        nC
 Rise Time                               tR     CL = 1nF (Figure 2, Note 3)                            100                  ns
 Fall Time                               tF     CL = 1nF (Figure 2, Note 3)                            100                  ns
 TRANSMITTER: HIGH-VOLTAGE REGULATOR
 Output Voltage Range                           Low                                                     5.4                  V
 Output Voltage Range                           High                                                   26.4                  V
 Programmable Output Voltage
                                                                                                        1.7                  V
 Step Size
 Output Voltage Accuracy                                                                                 5                  %
 Load Regulation                                ILOAD = 15mA                                           150                 mV
www.maximintegrated.com                                                                                      Maxim Integrated │ 7


MAX35104                                                                                         Gas Flow Meter SoC
Electrical Characteristics (continued)
(VCC = +2.3V to +3.6V, TA = -40°C to +85°C, unless otherwise noted. Typical values are at VCC = 3.3V and TA = +25°C.) (Notes 2, 3)
           PARAMETER               SYMBOL                      CONDITIONS                    MIN       TYP      MAX       UNITS
 TRANSMITTER: PIEZO DRIVER
 Driver Output Resistance
                                   RON-N-PD     VIN = 10V, ILD =10mA                                    50                   Ω
 Pulling Down (n-Channel)
 Driver Output Resistance
                                   RON-P-PU     VIN = 10V, ILD =10mA                                    50                   Ω
 Pulling Up (p-Channel)
 Output Leakage Current             ILK-PD                                                             0.05                 µA
 Rise Time                           tR-PD      CL = 1nF                                               100                  ns
 Fall Time                           tF-PD      CL = 1nF                                               100                  ns
 FILTER SPECIFICATION
 Input Amplitude                                                                               1                 10        mV
 Differential Input Impedance                                                                            4                  kΩ
 Programmable Gain Resolution       Per bit                                                             1.5                 dB
 COMPARATOR SPECIFICATION
                                                C_OFFSETUP or C_OFFSETDN
 Input Offset Voltage              VOFFSET                                                               2                 mV
                                                register programmed to 00h
 Input Offset Step Size             VSTEP                                                                1                 mV
 Receiver Sensitivity               VSENS       Stop hit detect level                         10                          mVP-P
 ANALOG RECEIVER: BANDPASS FILTER
 Center Frequency Accuracy            f0A       f = 200kHz                                               6                  %
                                                                                                         4
 Q Range                                                                                                                  Hz/Hz
                                                                                                        12
 Q Accuracy                                                                                             20                  %
 200kHz PERFORMANCE
 A1 Differential Gain                           200kHz, VIN = 6mVP-P                                    10                 V/V
 UP/DN Gain Match                                                                                       ±1                  %
www.maximintegrated.com                                                                                      Maxim Integrated │ 8


MAX35104                                                                                         Gas Flow Meter SoC
Electrical Characteristics (continued)
(VCC = +2.3V to +3.6V, TA = -40°C to +85°C, unless otherwise noted. Typical values are at VCC = 3.3V and TA = +25°C.) (Notes 2, 3)
          PARAMETER                SYMBOL                    CONDITIONS                      MIN       TYP      MAX       UNITS
                PGA[3:0] = 0000b                                       VIN = 19.0mVP-P                 3.16
                PGA[3:0]= 0001b                                        VIN = 16.3mVP-P                 3.69
                PGA[3:0]= 0010b                                        VIN = 14.0mVP-P                 4.30
                PGA[3:0]= 0011b                                        VIN = 12.0mVP-P                 5.01
                PGA[3:0]= 0100b                                        VIN = 10.3mVP-P                 5.84
                PGA[3:0]= 0101b                                        VIN = 8.80mVP-P                 6.81
                PGA[3:0]= 0110b                                        VIN = 7.55mVP-P                 7.94
                PGA[3:0]= 0111b                                        VIN = 6.48mVP-P                 9.26
 PGA Gain                                       VOUT = 600mVP-P                                                            V/V
                PGA[3:0]= 1000b                                        VIN = 5.56mVP-P                 10.8
                PGA[3:0]= 1001b                                        VIN = 4.76mVP-P                 12.6
                PGA[3:0]= 1010b                                        VIN = 4.09mVP-P                 14.7
                PGA[3:0]= 1011b                                        VIN = 3.51mVP-P                 17.1
                PGA[3:0]= 1100b                                        VIN = 3.02mVP-P                 20.0
                PGA[3:0]= 1101b                                        VIN = 2.58mVP-P                 23.3
                PGA[3:0]= 1110b                                        VIN = 2.21mVP-P                 27.1
                PGA[3:0]= 1111b                                        VIN = 1.90mVP-P                 31.6
                                                VIN = 19mVP-P
 Filter Gain at 200kHz Trim                                                                             1.0                V/V
 Filter Gain with Bypass                        VIN = 19mVP-P                                          0.01                V/V
www.maximintegrated.com                                                                                      Maxim Integrated │ 9


MAX35104                                                                                           Gas Flow Meter SoC
Electrical Characteristics (continued)
(VCC = +2.3V to +3.6V, TA = -40°C to +85°C, unless otherwise noted. Typical values are at VCC = 3.3V and TA = +25°C.) (Notes 2, 3)
         PARAMETER                 SYMBOL                       CONDITIONS                     MIN       TYP        MAX       UNITS
 TIME MEASUREMENT UNIT
 Measurement Range                   tMEAS      Time of flight                                   4                  8000        µs
 Time Measurement Accuracy            tACC      Differential time measurement                             700                   ps
 Time Measurement Resolution           tRES                                                               3.8                   ps
 EXECUTION TIMES
 Power-On-Reset Time                            VCC MIN to POR bit set                                    275                   µs
 Case Switch Time                               CSW pin logic-high until CSWI bit set                      20                   ns
 CAL Command Time                               Command received until CAL bit set                       1.25                   ms
 SERIAL PERIPHERAL INTERFACE (Figure 1 and Figure 2)
 DIN to SCK Setup                       tDC                                                                          20         ns
 SCK to DIN Hold                      tCDH                                                                  2        20         ns
 SCK to DOUT Delay                    tCDD                                                                  5        20         ns
                                                VCC ≥ 3.0V                                      25          4
 SCK Low Time                           tCL                                                                                     ns
                                                VCC = 2.3V                                      50         30
 SCK High Time                          tCH                                                     25          4                   ns
 SCK Frequency                         tSCK                                                                          20        MHz
 SCK Rise and Fall                    tR, tF                                                                         10         ns
 CE to SCK Setup                        tCC                                                                 5        40         ns
 SCK to CE Hold                       tCCH                                                                           20         ns
 CE Inactive Time                     tCWH                                                                  2        40         ns
 CE to DOUT High Impedance             tCCZ                                                                 5        40         ns
Note 2: All voltages are referenced to ground. Current entering the device are specified as positive and currents exiting the device
         are negative.
Note 3: Limits are 100% production tested at TA = +25°C. Limits over the operating temperature range and relevant supply voltage
         range are guaranteed by design and characterization.
www.maximintegrated.com                                                                                        Maxim Integrated │ 10


MAX35104                                                                       Gas Flow Meter SoC
Recommended External Crystal Characteristics
             PARAMETER             SYMBOL                  CONDITIONS       MIN    TYP      MAX       UNITS
 32kHz Nominal Frequency               f32K                                      32.768                kHz
 32kHz Frequency Tolerance        ∆f32K/f32K        25°C                    -20              +20       ppm
 32kHz Load Capacitance              CL32K                                         12.5                 pF
 32kHz Series Resistance             RS32K                                                    70        kΩ
 4MHz Crystal Nominal Frequency         f4M                                       4.000                MHz
 4MHz Crystal Frequency Tolerance  Δf4M/f4M         25°C                    -30              +30       ppm
 4MHz Crystal Loadapacitance         CL4M                                          12.0                 pF
 4MHz Crystal Series Resistance      RS4M                                                    120         Ω
 4MHz Ceramic Nominal Frequency                                                   4.000                MHz
 4MHz Ceramic Frequency Tolerance                   25°C                    -0.5            +0.5        %
 4MHz Ceramic Load Capacitance                                                      30                  pF
Timing Diagrams
           tCC
    CE                                                                                           tCWH
                                  tCDH
   SCK
                     tDC
    DIN                      MSB                                LSB
                                                                      tCDD                            tCCZ
  DOUT
                                            HIGH IMPEDANCE              MSB                LSB
Figure 1. SPI Timing Diagram Read
www.maximintegrated.com                                                                 Maxim Integrated │ 11


MAX35104                                                                 Gas Flow Meter SoC
Timing Diagrams (continued)
         tCC
  CE                                                                                        tCWH
                                                        tCLK         tR
                                                                        tF   tCCH
                                   tCDH                      tCH
                                                                 VIH
                                                    tCL
  SCK
                                                                 VIL
                  tDC
  DIN                      MSB                                                       LSB
  DOUT                                  HIGH IMPEDANCE
Figure 2. SPI Timing Diagram Write
www.maximintegrated.com                                                           Maxim Integrated │ 12


MAX35104                                                                                                                                           Gas Flow Meter SoC
Pin Configuration
                              TOP VIEW
                                             TX_UPP   TX_UPN    VPR      VP     VSS    TX_DNP   TX_DNN          CSIN     VSS_SW   COMP
                                              30       29 28 27                 26 25 24 23 22                                    21
                                   AVDD 31                                                                                               20 V2X
                                    RXP 32                                                                                               19 FETG
                                    RXN 33                                                                                               18 VDD
                                    CIN 34                                                                                               17 CPH
                                    CIP 35                                MAX35104                                                       16 CPL
                                   AVSS 36                                                                                               15 WDO
                                 32KOUT 37                                                                                               14 INT
                                     T1 38                           EP = VSSIO
                                                                                                                                         13 DOUT
                                                            +
                                     T2 39                                                                                               12 DIN
                                     TC 40                                                                                               11 SCK
                                               1        2        3        4      5       6          7             8        9      10
                                             32KX1    32KX2     VDDISO   4MX1   4MX2   CSW
                                                                                                CMP_OUT/UP_DN
                                                                                                                BYPASS
                                                                                                                         RST      CE
                                                                            TQFN
                                                                         (5mm x 5mm)
Pin Description
   PIN           NAME                                                                                              FUNCTION
    1            32KX1     Connections for 32.768kHz Quartz Crystal, Connect a 12pF ceramic capacitor from each pin to
                           ground. An external CMOS 32.768kHz signal can also drive the device. In this configuration, the
    2            32KX2     32KX1 pin is connected to the external signal and the 32KX2 pin is left unconnected.
                           LDO Supply Voltage. This pin should be decoupled to VSSISO with a 100nF ceramic capacitor
    3            VDDISO
                           (Note 1).
    4            4MX1      Connections for 4MHz Quartz Crystal, connect a 12pF ceramic capacitor from each pin to
                           ground. A ceramic resonator can also be used. An external CMOS 4MHz signal can also drive
                           the device. In this configuration, the 4MX1 pin is connected to the external signal and the 4MX2
    5            4MX2      pin is left unconnected.
    6             CSW      CMOS Digital Input Case Switch. Active high tamper detect input.
                           CMOS output that indicates the direction (upstream or downstream) of which the pulse launcher
    7      CMP_OUT/UP_DN
                           is currently launching pulses OR the comparator output (Note 2).
                           Connect this pin to ground with a 100nF ceramic capacitor to provide stability for the on-board
    8           BYPASS     low-dropout regulator. The effective series resistance of this capacitor needs to be in the range of
                           1Ω to 2Ω (Note 3).
www.maximintegrated.com                                                                                                                                  Maxim Integrated │ 13


MAX35104                                                                                      Gas Flow Meter SoC
Pin Description (continued)
   PIN            NAME                                                 FUNCTION
    9              RST  Active-Low Reset (CMOS Digital Input). Performs the same function as a power-on reset (POR).
   10               CE  Active-Low Serial Peripheral Interface Chip Enable Input (CMOS Digital Input)
   11              SCK  Serial Peripheral Interface Clock Input (CMOS Digital Input)
   12              DIN  Serial Peripheral Interface Data Input (CMOS Digital Input)
   13             DOUT  Serial Peripheral Interface Data Output (CMOS Output)
                        Active-Low, Open-Drain Interrupt Output. The pin is driven low when the device requires service
   14              INT
                        from the host microprocessor.
                        Active-Low, Open-Drain Watchdog Output. The pin is driven low when the watchdog counter
   15             WDO
                        reaches zero (if enabled).
                        Negative terminal of the flying capacitor for the voltage doubler. Connect this pin to CPH with a
   16              CPL
                        100nF ceramic capacitor. (Note 4)
                        Positive terminal of the flying capacitor for the voltage doubler. Connect this pin to CPL with a
   17              CPH
                        100nF ceramic capacitor. (Note 4,5)
                        Supply Voltage. This pin should be decoupled to VSS with a 100nF and a 22µF ceramic capacitor
   18              VDD
                        (Note 1).
                        PWM Modulated CMOS Gate Driver Output for External n-Channel Power Transistor used in the
   19             FETG
                        Boost Switcher. Place a 25Ω series resistor between this pin and the transistor gate.
                        Connect this pin to ground with a 100nF ceramic capacitor to provide stability for the on-board
   20              V2X
                        voltage doubler (Notes 3, 4).
                        Error-Amplifier Output of Boost Converter. Connect the frequency-compensation network
   21             COMP
                        between COMP and AVSS. See Figure 6 (Notes 3, 4).
                        High-Current Ground Return for the Boost Switcher. Connect the current-sense resistor between
   22            VSS_SW
                        this pin and CSIN+ (Note 4).
                        Positive Analog Input to the Current-Sense Amplifier for the Boost Switcher. Connect the current-
   23             CSIN
                        sense resistor between this pin and CSIN (Note 4).
                        Connect to the negative terminal of the piezo transducer located downstream of the gas flow.
                        Performs the launching and receiving functions required for a time-of-flight measurement. In the
   24            TX_DNN launch case, it is the negative output of the bridged differential output driver pair. In the receive
                        case, it is the negative input of the analog differential return signal from the piezo transducer
                        (Notes 2, 4).
                        Connect to the positive terminal of the piezo transducer located downstream of the gas flow.
                        Performs the launching and receiving functions required for a time-of-flight measurement. In the
   25            TX_DNP launch case, it is the positive output of the bridged differential output driver pair. In the receive
                        case, it is the positive input of the analog differential return signal from the piezo transducer
                        (Notes 2, 4).
   26              VSS  Ground Connection
                        Resulting High-Voltage Bias Generated by the Boost Switcher Circuit. Used as the supply for the
   27               VP  high-voltage regulator and to generate the feedback voltage fed into the error-amplifier for closed
                        loop control. (Notes 3, 4).
www.maximintegrated.com                                                                                    Maxim Integrated │ 14


MAX35104                                                                                                Gas Flow Meter SoC
Pin Description (continued)
   PIN            NAME                                                          FUNCTION
                                  Connect this pin to ground with a 1µF ceramic capacitor to provide stability for the on-board high-
    28              VPR           voltage regulator. When the high-voltage regulator is not used and constantly disabled, short this
                                  pin to VP (Notes 3, 4).
                                  Connected to the negative terminal of the piezo transducer located upstream of the gas flow.
                                  Performs the launching and receiving functions required for a time-of-flight measurement. In the
    29           TX_UPN           launch case, it is the negative output of the bridged differential output driver pair. In the receive
                                  case, it is the negative input of the analog differential return signal from the piezo transducer
                                  (Notes 2, 4).
                                  Connected to the positive terminal of the piezo transducer located upstream of the gas flow.
                                  Performs the launching and receiving functions required for a time-of-flight measurement. In the
    30           TX_UPP           launch case, it is the positive output of the bridged differential output driver pair. In the receive
                                  case, it is the positive input of the analog differential return signal from the piezo transducer
                                  (Notes 2, 4).
                                  Analog Supply Voltage. This pin should be decoupled to AVSS with a 100nF ceramic capacitor
    31            AVDD
                                  (Note 1).
                                  Do Not Connect (DNC) When Utilizing the Internal Analog Front-End. Positive analog output from
    32             RXP            the selected transducer’s differential return signal. When used with the CIP pin provides a way to
                                  construct an external analog front-end (Note 5).
                                  Do Not Connect (DNC) When Utilizing the Internal Analog Front-End. Negative analog output
    33             RXN            from the selected transducer’s differential return signal. When used with the CIN pin provides a
                                  way to construct an external analog front-end (Note 5).
                                  Do Not Connect (DNC) When Utilizing the Internal Analog Front-End. Negative analog input to
    34              CIN           the differential receive comparator. When used with the RXN pin provides a way to construct an
                                  external analog front-end (Note 5). OR negative analog output of selectable AFE stages (Note 2).
                                  Do Not Connect (DNC) When Utilizing the Internal Analog Front-End. Positive analog input to
    35              CIP           the differential receive comparator. When used with the RXP pin provides a way to construct an
                                  external analog front-end (Note 5). OR positive analog output of selectable AFE stages (Note 2).
    36             AVSS           Ground Connection
    37           32KOUT           CMOS Output That Repeats the 32kHz Crystal Oscillator Frequency
    38               T1           Open-Drain Probe 1 Temperature Measurement (Note 5)
    39               T2           Open-Drain Probe 2 Temperature Measurement (Note 5)
    40              TC            Input/Output Temperature Measurement Capacitor Connection (Note 5)
   EP             VSSISO          Exposed Pad, Ground Connection
Note 1: A +2.7V to +3.6V supply. Typically sourced from a single lithium cell.
Note 2: Dual functionality pin.
Note 3: Do not connect to additional non-recommended external circuitry.
Note 4: High-voltage tolerant.
Note 5: This pin can be left open circuit if not needed.
www.maximintegrated.com                                                                                              Maxim Integrated │ 15


MAX35104                                                                                                                                                                                Gas Flow Meter SoC
Block Diagram
                                                                                                        CIP    CIN                         CMP_OUT/UP_DN
                                                                                                                                                                                                     T1           T2
                                   VBAT
                                                                                          TUNABLE BPF                                                                                                                       10K NTC        10kΩ (50ppm)
                                                                                                                                                                                                                                           METAL FILM
                                                                                           125kHz TO
                                                                                             500kHz
                  3.6V LTC CELL                                                                                                     PGM OFFSET               TIME-TO-DIGITAL
                                                      FIXED              10DB TO                                                    COMPARATOR                 CONVERTER
                                                      20dB                 30dB
                                                                                                                                                                                                                                      10 nF COG (NP0)
                                                                                                                                                                                                                           TC
                                                                                                                                                                                                                                         (30ppm/°C)
                                                                                                                                                                                           TEMPERATURE
                                      RXP
                                      RXN                                                  MAX35104                                                                                                                             SCK
                                                                                                                                                                      DATA AND STATUS                                       DOUT
                                                                                                                               PROGRAMMABLE ALU                          REGISTER                                                            SPI
                                                                                                                                                                                               4-WIRE SPI
                                  TX_UPN                                                                                                                                                                                        DIN
                                                                                          HIGH-VOLTAGE
                                  TX_UPP                                                                                                                                                                                        CE
  PIEZOELECTRIC                                                                              PULSE                                                                                                 I/
  TRANSDUCERS                                                                            LAUNCHER UP
                                  TX_DNN                                                                                                                                                                                                     MICRO
                                                                                              TO 30 V
                                  TX_DNP
                                                                                                                                                                                                 DIGITAL                        WDO
                                                                                                                                                                                                CONTROL
                                           VPR            HV REGULATOR
                                                                                                                                                                                               INTERFACE
                                                                                                                                    STATE MACHINE                                                                               INT          INTERRUPT
                                                                                                                                                                          CONFIG
                                                                                                                                     CONTROLLER
                                                                                                                                                                         REGISTERS
         VDD                                VP
                                                                                                                                                                                                                                RST
                                           COMP
                                                                   F/F                                                                                                                                                          CSW
                                                                         R    COMP             ERROR                                                                                                                                                 VDD
                                                   SWITCHER                                     AMP
                  N                                                      S                                                                                                                     INTERNAL LDO
                                                                   Q                                                                                                                                                       BYPASS
                                                   GAIN                                              BG
                                                   (4x)
                                           CSIN
                                                                                                                       HIGH-SPEED                                          REAL-TIME     EVENT TIMER W/
                                                                                                                                            32kHz OSCILLATOR
                                                                                                                       OSCILLATOR                                           CLOCK         RANDOMIZER
                                                    GATE DRIVER                          VOLTAGE DOUBLER
                                          VSS_SW
                                                                                                                                                                               VDDISO   AVDD                VDD
                                                      FETG                         V2X         CPL            CPH    4MX1    4MX2        32KOUT      32KX1       32KX2
                                                                                                                                                                               VSSISO   AVSS                VSS
Detailed Description                                                                                                           solution. A programmable high-voltage (up to 30V) pulse
The MAX35104 is a gas flow meter SoC targeted as an                                                                            launcher provides up to 19dB of transducer launch ampli-
analog front-end solution for the ultrasonic gas meter                                                                         tude adjustment to compensate for transducer aging and
and medical ventilator markets. With a time measure-                                                                           temperature, pressure, humidity affects.
ment accuracy of 700ps and automatic differential Time-                                                                        Early edge detection ensures measurements are made
of-Flight measurement, the device makes for simplified                                                                         with consistent wave patterns to greatly improve accuracy
computation of gaseous flow. Power consumption is the                                                                          and eliminate erroneous measurements. A built-in arith-
lowest available with ultra-low 62µA TOF measurement                                                                           metic logic unit provides TOF difference measurements
and 125nA duty-cycled temperature measurement.                                                                                 and programmable receiver hit accumulators to minimize
Multihit (up to 6 per wave) capability with stop-enable                                                                        the host microprocessor access. For temperature mea-
windowing allows the device to be fine-tuned for the appli-                                                                    surement, the device supports a single 2-wire PT1000
cation. Internal analog switches, a configurable 3-stage                                                                       platinum resistive temperature detector (RTD) or NTC
integrated operational amplifier chain amplifier, and an                                                                       thermistor. A simple 4-wire SPI interface allows any micro-
ultra-low input offset comparator provide the analog inter-                                                                    controller to effectively configure the device for its intended
face and control for a minimal electrical bill of material                                                                     measurement.
www.maximintegrated.com                                                                                                                                                                                                Maxim Integrated │ 16


MAX35104                                                                                                                                                                       Gas Flow Meter SoC
                                                                     TOF START
                                                           VHV-REGULATOR
                       1                                                                                                                   1
            TX_UPN
                       0                                                                                                                   0
            TX_UPP
                                                                                                                                                                                                          TRANSDUCER
                                                   ~0.7V                                                                                                                                                  RING DOWN
           TX_DNN
           TX_DNP
            AMPLIFIED AND FILTERED OUTPUT TO
            PROGRAMMABLE OFFSET                                                                                                                                                                                     POWER
            COMPARATOR (INTERNAL TO THE                                                                                                                                                                             DOWN
            DEVICE)                                                                                                                                                                                                 STATE
                                                                                                                                                                                            TOF STOP
                                                                                                                                                                                         HIT1
                                                                                                                                                                                         HIT2
                                                                                                                                                                                         HIT3
                                                                                                                                                                                         HIT4
                                                                                                                                                                         t1         t2   HIT5
                                                                                                                                                                                         HIT6
                                                                                                                                                                                                             AVG =
                                                                                                                                                                                                             ∑(HIT[1:6]) ÷ 6
                                                                                                                                                 COMPARATOR OFFSET
                                                                                                                                                                                                    COMPARATOR
                                                                                                                                                                                                    OFFSET
                                                                                                                                                                                                    RETURN
                                                                                 POWER DOWN STATE                                                                                                         POWER
           PROGRAMMABLE OFFSET COMPARATOR                                                                                                              WAVE NUMBER        0 1 2 3 4 5 6 7 8 9 10 11       DOWN
           INPUTS (INTERNAL TO THE DEVICE)                                                                                                                                                                STATE
            INT PIN
                                                        (2)
                                 (1)               ENABLE BOOST                                                  (4)
                               4 MHZ               CIRCUIT & WAIT                                               TOF
                              STARTUP              STABILIZATION        (3)                                 MEASUREMENT
                                                       TIME           LAUNCH                                   DELAY
                                                                                                                                               ~10us
                                                                      PULSES
               TOF COMMAND          CONFIGURE                                                                                   (6)                          (8)
                                                                                                       (5)
                 RECEIVED        INTERNAL ANALOG                                                                         BIAS APPLIED TO                   ENABLE
                                                                                                 DISABLE BOOST
                                     SWICTHES                                                                               INTERNAL                     COMPARATOR
                                                                                                    CIRCUIT
                                                                                                                        COMPARATOR CAPS
                                                                                                                                                              (9)                  (11)                      (13)
                                                                                                                                                                           (10)                  (12)                  (14)
                                                                                                                                                                                                          CALCULATIO
                                                                                                                                                           t1 WAVE      COMPARE t2 WAVE         STOP                    INT
                                                                                                                                                                                                              NS
                                                                                                                                                                         RETURN                 HITS                ASSERTED
                                                                STOP HITS SELECTED = 6, STOP POLARITY = POSITIVE EDGE               SELECTED WAVES FOR HITS:
                                                                                                                                    t2 = 4 HIT1 = 6 HIT2 = 7 HIT3 = 8    HIT4 = 9   HIT5 = 10 HIT6 = 11
Figure 3. Time-of-Flight Up Measurement Sequence
Time-of-Flight (TOF) Measurement Operations                                                                         1)       The 4MHz oscillator and LDO is enabled with a pro-
TOF is measured by launching pulses from one piezo-                                                                          grammable settling delay time set by the CLK_S[2:0]
electric transducer and receiving the pulses at a second                                                                     bits in Calibration and Control register.
transducer. The time between when the pulses are                                                                    2)       The boost circuit is enabled and attempts to reach
launched and received is defined as the time of flight. The                                                                  the targeted set output voltage. Once at the target
device contains the functionality required to create a string                                                                voltage, the stabilization time to wait before mov-
of pulses, sense the receiving pulse string, and measure                                                                     ing to the next step is set by the ST[3:0] bits in the
the time of flight. The device can measure two separate                                                                      Switcher 2 register.
TOFs, which are defined as TOF Up and TOF Down.                                                                     3)       The pulse launcher drives the appropriate TX pins
A TOF Up measurement has pulses launched from the                                                                            with a programmable sequence of pulses. The num-
TX_UPN and TX_UPP pins, which is connected to the                                                                            ber of pulses launched is set by the PL[7:0] bits in
downstream transducer. The ultrasonic pulse is received                                                                      the TOF1 register. The frequency of these 50% duty-
at the upstream transducer, which is connected to the                                                                        cycle pulses is set by the DPL[3:0] bits, also in the
TX_DNN and TX_DNP pins. A TOF Down measurement                                                                               TOF1 register. The start of these launch pulses gen-
has pulses launched from the TX_DNN and TX_DNP                                                                               erates a start signal for the Time-to-Digital Converter
pins, which is connected to the upstream transducer. The                                                                     (TDC) and is considered to be time zero for the TOF
ultrasonic pulse is received at the downstream transduc-                                                                     measurement. This is denoted in Figure 4.
er, which is connected to the TX_UPN and TX_UPP pins.                                                               4)       After a programmable delay time set in TOF Mea-
TOF measurements can be initiated by sending either the                                                                      surement Delay register, the comparator and hit
TOF_UP, TOF_DN, or TOF_DIFF commands. TOF_DIFF                                                                               detector at the appropriate pins are enabled. This
measurements can also be automatically executed using                                                                        delay allows the receiver to start recording hits when
Event Timing Mode commands EVTMG1 or EVTMG2.                                                                                 the received wave is expected, eliminating possible
                                                                                                                             false hits from noise in the system.
The steps involved in a single TOF measurement are
described below and labeled in Figure 3.                                                                            5)       Once the pulse launcher has completed transmitting
                                                                                                                             the sequence of pulses, the boost circuit is disabled.
www.maximintegrated.com                                                                                                                                                                                   Maxim Integrated │ 17


MAX35104                                                                                                  Gas Flow Meter SoC
6)   A common mode bias is enabled on the internal                             AVGDNInt and AVGDNFrac. The ratio of t1/t2 and t2/
     capacitor connecting the output of the bandpass filter                    tIDEAL are calculated and stored in the WVRUP or
     to the input of the programmable offset comparator.                       WVRDN register.
     This bias charge time is fixed at approximately 10µs.                 13) Once all the hit data, wave ratios, and averages
7)   The comparator is enabled.                                                become available in the Results registers, the TOF
8)   Stop hits are detected according to the programmed                        bit in the Interrupt Status register is set and the INT
     preferred edge of the acoustic signal sequence                            pin is asserted (if enabled) and remains asserted
     received at the appropriate pins according to the                         until the Interrupt Status register is accessed by the
     setting of the STOP_POL bit in the TOF1 register.                         microprocessor with a Read register command.
     When a wave received at the receiving pins exceeds                    The computation of the total time of flight is performed
     the Comparator Offset Voltage, which is set in the                    by counting the number of full and fractional 4MHz clock
     TOF6 and TOF7 registers, this wave is detected and                    cycles that elapsed between the launch start and a hit
     identified as wave number 0. The width of the wave’s                  stop as shown in Figure 4.
     pulse that exceeds the Comparator Offset Voltage is
     measured and stored as the t1 time.                                   Table 1. Two’s Complement TOF_DIFF
9)   The offset of the comparator then automatically and                   Conversion Example
     immediately switches to the Comparator Return Off-                              REGISTER VALUE                       CONVERTER VALUE
     set, which is set in the TOF6 and TOF7 registers.
                                                                              TOF_DIFFInt       TOF_DIFFFrac                 TOF DIFF Value
10) The t2 wave is detected and the width of the t2 pulse                         (hex)               (hex)                          (ns)
     is measured and stored as the t2 time. The wave
                                                                                  7FFF               FFFF                     8,191,999.9962
     number for the measurement of the t2 wave width is
     set by the T2WV[5:0] bits in the TOF2 register.                              001C                0403                      7,003.9177
11) The preferred number of stop hits are then detected.                          0001                00A1                        250.6142
     For each hit, the measured TOF is stored in the                              0000                0089                          0.5226
     appropriate HITxUPINT and HITxUPFrac or HITx-                                0000                0001                          0.0038
     DNINT and HITxDNFRAC registers. The number
                                                                                  0000                0000                          0.0000
     of hits to detect is set by the STOP[2:0] bits in the
     TOF2 register. The wave number to measure for                               FFFF                FFFF                          -0.0038
     each stop hit is set by the Hitx Wave Select bits in                        FFFF                FFC0                          -0.2441
     the TOF3, TOF4, and TOF5 registers.                                         FFFE                 1432                       -480.2780
12) After receiving all the programmed hits, the de-                             FF1C                 8001                     -56,874.9962
     vice calculates the average of the recorded hits
                                                                                  8000                0000                   -8,192,000.0000
     and stores this to AVGUPINT and AVGUPFrac or
                                                   INTEGER TOF RESULTS PORTION                FRACTIONAL TOF RESULTS PORTION
                                                             1 LSB = T4MHZ                           1 LSB = T4MHz/(2^16)
                                     1          2          3               4                     N
                        4 MHz CLOCK
                  START SIGNAL                                                                                             STOP SIGNAL
       (INTERNALLY GENERATED                                                                                               (GENERATED UPON
         WHEN ACOUSTIC SIGNAL                                                                                              ACOUSTIC SIGNAL
               IS TRANSMITTED)                                                                                             RECEPTION)
                                                  TOTAL TIME OF FLIGHT = INTEGER + FRACTIONAL
Figure 4. Start/Stop for Time-to-Digital Timing
www.maximintegrated.com                                                                                                    Maxim Integrated │ 18


MAX35104                                                                                              Gas Flow Meter SoC
Each TOF measurement result is comprised of an integer      if triggering on a negative edge, with 1 LSB = VCC/3072.
portion and a fractional portion. The integer portion is a  Separate input offset settings are available for the
binary representation of the number of t4MHz periods that   Upstream received signal and the Downstream received
contribute to the time results. The fractional portion is a signal. The input offset for the Upstream received signal is
binary representation of one t4MHz period quantized to      programmed using the C_OFFSETUP[6:0] bits in the TOF6
a 16-bit resolution. The maximum size of the integer is     register,. The input offset for the Downstream received
7FFFh or (215 - 1) x t4MHz or ~ 8.19ms. The maximum         signal is programmed using the C_OFFSETDN[6:0] bits in
size of the fraction is FFFFh or (216 - 1)/216 x t4MHz. or  the TOF7 register. Once the first hit is detected, the time t1
~ 249.9961 ns.                                              equal to the width of the earliest detectable edge is mea-
                                                            sured. The input offset voltage is then automatically and
Pulse Echo TOF Mode
                                                            immediately returned to a preprogrammed comparator
The device also has a pulse echo mode of operation.         offset value. This return offset value has a range of +127
This mode allows time-of-flight measurements to be taken    LSB’s to -128 LSB’s in 1 LSB steps and is programmed
when only one transducer is used. The sole transducer       into the C_OFFSETUPR[7:0] bits in the TOF6 register for
transmits the high-voltage pulses and then receives the     the Upstream received signal and programmed into the
return signal. The time-of-flight measurement operation     C_OFFSETDNR[7:0] bits in the TOF7 register. This pre-
acts exactly as described in steps 1–13 except that the     programmed comparator offset return value is provided to
common mode of the AFE is applied to the same pins that     allow for common-mode shifts that can be present in the
transmitted the high-voltage pulses (Figure 5A).            received acoustic wave.
The resulting data from the measurement is reported in      The device is now ready to measure the successive hits.
the same manner as described in the TOF_UP, TOF_            The next selected wave that is measured is the t2 wave.
DOWN, or TOF_DIFF sections depending upon which             In the example in Figure 5B, this is the 7th wave after the
command was executed.                                       Early Edge Detect wave. The selection of the t2 wave is
The pulse echo mode is enabled by setting the PECHO         made with the T2WV[5:0] bits in the TOF2 register.
bit in the Switcher 2 Register.                             With reference to Figure 5B, the ratio t1/t2 is calculated
Early Edge Detect                                           and registered for the user. This ratio allows determination
The Early Edge Detect method of measuring the TOF of        of abrupt changes in flow rate, received signal strength,
acoustic waves is used for all the TOF commands includ-     partially filled tube detection, and empty tube. It also pro-
ing TOF_UP, TOF_DN, and TOF_DIFF. This method               vides noise suppression to prevent erroneous edge detec-
allows the device to automatically control the input offset tion. Also, the ratio t2/tiDEAL is calculated and registered
voltage of the receiver comparator so that it can provide   for the user. For this calculation, tIDEAL is one-half the
advanced measurement accuracy. The input offset of the      period of launched pulse. This ratio adds confirmation that
receiver comparator can be programmed with a range          the t2 wave is a strong signal, which provides insight into
+127 LSBs if triggering on a positive edge and -127 LSBs    the common mode offset of the received acoustic wave.
         DIFFERENTIAL DRIVE, SD_EN = 0B
                                                                            PULSE ECHO MODE, PECHO = 1b
                                        VHV-REGULATOR
          1
  TX_UPN                                                                                                            TRANSDUCER
                                                                         ~0.7V                                      RING DOWN
          0
  TX_UPP
 TX_DNN
 TX_DNP
Figure 5A. Pulse Echo Measurement Mode
www.maximintegrated.com                                                                                      Maxim Integrated │ 19


MAX35104                                                                                                                                 Gas Flow Meter SoC
                                       OFFSET RESETS AUTOMATICALLY TO A PRE-
                                     PROGRAMMED VALUE (± 127mV IN 1mV STEPS) TO
                                        DETECT SUBSEQUENT ZERO-CROSSINGS
                                                                                                      WAVE NUMBER
                                                  0       1       2       3      4       5     6  7   8       9     10   11   12   13   14
   PROGRAMMABLE OFFSET DETECT: ± 127mV IN
                  1mV STEPS
         Programmable Offset
         Comparator Inputs (Internal
         to the Device)
                                                                                                     HIT #: 1     2    3    4    5    6
                                                  t1                                              t2
                                                                       EXAMPLE: MEASURE WIDTH OF
                                                                        7TH WAVE AFTER EARLY EDGE
                                                                                  DETECT
Figure 5B. Early Edge Detect Received Wave Example
TOF Error Handling                                                                                   The integrated boost controller in enabled and disabled
Any of the TOF measurements can result in an error.                                                  automatically by the device. The logic enables the boost
If an error occurs during the measurement, all the                                                   before executing a time of flight command and disables
associated registers report FFFFh. If a TOF_DIFF is                                                  the boost once the transmit pulse train is complete, see
being performed, the TOF_DIFFInt and TOF_DIF_Frac                                                    example timing in the Figure 3. The boost is disabled
registers report 7FFFh and FFFFh, respectively. The                                                  upon completion of the transmit pulses in order to reduce
TOF_DIFF_AVG Results registers do not include the error                                              overall system power consumption as well as to eliminate
measurement. If the measurement error is caused by                                                   any controller switching noise that would be introduced
the time measurement exceeding the timeout set by the                                                during the return signal’s timing measurements.
TIMOUT[2:0] bits in the TOF2 register, then the TO bit in                                            Control and Operation
the Interrupt Status register is set and the INT device pin
                                                                                                     The switching frequency of the controller is programmable
is asserted (if enabled).
                                                                                                     from 100kHz to 200kHz in 4 steps set by the SFREQ[1:0]
Step-Up DC-DC Controller                                                                             bits in the Switcher 1 register. In order to set the output
In order to increase the power transferred to the trans-                                             voltage the controller uses an outer loop feedback topol-
ducers during a launch sequence which is required to                                                 ogy along with a peak current mode inner loop control.
counteract the high attenuation factors for ultrasonic                                               The controller’s outer loop targets an output voltage from
waves in gaseous mediums the device contains an inte-                                                9V to 30V based on the programmed value set by the
grated DC-DC Step-Up controller designed to operate                                                  VS[3:0] bits in the Switcher 1 register. An internal error
in discontinuous-conduction mode (DCM boost). The                                                    amplifier creates a control voltage, which generates a
controller provides adjustable-output voltage operation                                              duty-modulated signal to control the operation of the
including programmable stabilization times with built in                                             internal gate driver used to switch the external MOSFET.
under voltage monitoring. The MAX35104’s integrated                                                  Additionally, the MOSFET’s source needs an external
gate driver utilizes the onboard voltage double in order to                                          current sense resistor, which feeds back the inductor’s
drive an external N-channel MOSFET’s gate from ground                                                current per cycle as a voltage and compares with the error
to 2 x VDD. The controller uses an external sense resis-                                             amplifier’s output to further adjust the duty-modulated
tor to control the peak inductor current and operates at                                             signal, thus forming an inner loop.
adjustable switching frequencies.
www.maximintegrated.com                                                                                                                         Maxim Integrated │ 20


MAX35104                                                                                 Gas Flow Meter SoC
The controller has an undervoltage comparator that deter-     frequency of the open-loop gain-transfer function of the
mines if the target output voltage is at target voltage, con- converter. The error amplifier included in the devices is a
sidered power good, or undervoltage. If the output voltage    transconductance amplifier. Figure 6 shows the compen-
is below target, the switcher operates in startup limit mode  sation network used to apply the necessary loop com-
that is determined by user selectable peak current limit      pensation for the example inductor and output capacitor
set by the LT_S[3:0] bits in the Switcher 2 register. This    values provided, where:
is essentially a slew rate control on how fast the boost                              RZ = 22kΩ
powers up and can be used to control the current signa-
tures seen by the supply battery. After the output voltage                           CP = 470pF
crosses the undervoltage threshold, the switcher runs in                              CZ = 10nF
normal duty mode. There is an additional optional peak
                                                              RSENSE
current limit setting for the normal duty mode that is set by
the LT_N[3:0] bits in the Switcher 2 register. Once in nor-   The external sense resistor value determines the peak
mal duty mode the device waits a programmable switcher        allowable inductor current. For a given limit trim setting,
stabilization time before a launch sequence begins. The       LT_N[3:0] and LT_S[3:0] in the Switcher 2 register. Adjust
stabilization time ensure that the controller has reaches a   the RSENSE value to adjust the peak allowable current.
stable and repeatable output voltage each time it is pow-     Select RSENSE based on the following criteria:
ered. This time is set by the ST[3:0] bits in the Switcher 2  Resistor Value: Select an RSENSE resistor value in which
register. See Figure 6.                                       the largest desired current would result in a 200mV full-
                                                              scale current sense voltage. Assuming an LT_x setting of
Compensation Component Values
                                                              0h, select RSENSE in accordance to the following equa-
In order to achieve standard operations the boost control-    tion and see Table 2 for examples:
ler requires that proper loop compensation be applied to
                                                                          RSENSE = 200mV/(Max Current)
the error-amplifier output (COMP pin). The goal of the
compensator design is to achieve the desired closed-loop      Power Dissipation: Select a sense resistor that is rated
bandwidth and sufficient phase margin at the crossover        for the max expected current and power dissipation (watt-
                                                              age). The sense resistor’s value might drift if it is allowed
                                        VDD
                                                              to heat up excessively.
                                                              Kelvin Sense
                                                              For best performance, a Kelvin Sense arrangement is
                                   5µH                        recommended for sense resistor as shown in Figure 7. In
                                               B340A-13-F
                                                              a Kelvin Sense arrangement, the voltage-sensing nodes
                             0Ω                               across the sense element are placed such that they mea-
                     FETG
                                            N                 sure the true voltage drop across the sense element and
                                          IRLM10060TRPBF      not any additional excess voltage drop that can occur in
                     CSIN+                                1µF
                                                              the copper PCB traces or the solder mounting of the sense
                                 100mΩ                        element. Routing the differential sense lines along the
       MAX35104
                     CSIN
                                                              same path to the device and keeping the path short also
                                                              improves the system performance. The analog differential
                                                              current-sense traces should be routed close together to
                      VP
                                     RZ =                     maximize common-mode rejection.
                                     22kΩ
                    COMP                                      Power Transistor
                            CP =                CZ =          Use an n-channel MOSFET power transistor with the
                           470pF                10nF
                                                              MAX35104. To ensure the external n-channel MOSFET
                                                              (nFET) is turned on hard, use logic-level or low-threshold
                                                              nFETs such that the MAX35104’s internal gate driver’s 2 x
                                                              VDD supply voltage is sufficient for proper switching oper-
                                                              ation. nFETs provide the highest efficiency because they
                                                              do not draw any DC gate-drive current. When selecting
Figure 6. Boost Circuits Components
www.maximintegrated.com                                                                              Maxim Integrated │ 21


MAX35104                                                                                                 Gas Flow Meter SoC
an nFET, three important parameters are the total gate                   Table 2. RSENSE Example Values
charge (Qg), on-resistance (RDS(ON)), and reverse trans-
fer capacitance (CRSS).                                                                   LIMIT TRIM
                                                                                                            CSIN TRIP           MAX
                                                                            RLIM            SETTING
Qg takes into account all capacitances associated with                                                      VOLTAGE          CURRENT
                                                                             (Ω)           (STARTUP
charging the gate. Use the typical Qg value for best                                                            (V)              (A)
                                                                                        AND NORMAL)
results; the maximum value is usually grossly over speci-
fied since it is a guaranteed limit and not the measured                                        0               0.2               2
value. The typical total gate charge should be 50nC or                                          1               0.4               4
                                                                              0.1
less. With larger numbers, the FETG pins may not be able                                        2               0.8               8
to adequately drive the gate.                                                                   4               1.6              16
The two most significant losses contributing to the nFET’s                                      0               0.2              0.8
power dissipation are I2R losses and switching losses.                                          1               0.4              1.6
                                                                             0.25
Select a transistor with low rDS(ON) and low CRSS to                                            2               0.8              3.2
minimize these losses.                                                                          4               1.6              6.4
Determine the maximum required gate-drive current                                               0               0.2              0.4
from the Qg specification in the nFET data sheet. The                                           1               0.4              0.8
MAX35104’s maximum allowed switching frequency is                             0.5
                                                                                                2               0.8              1.6
200kHz, so the maximum current required to charge
                                                                                                4               1.6              3.2
the nFET’s gate is f(max) x Qg(typ). Use the typical Qg
                                                                                                0               0.2              0.2
number from the transistor data sheet. For example, the
Si9410DY has a Qg(typ) of 17nC (at VGS = 5V), there-                                            1               0.4              0.4
                                                                               1
fore, the current required to charge the gate is:                                               2               0.8              0.8
         IGATE (max) = (300kHz) (17nC) = 5.1mA                                                  4               1.6              1.6
                                                                                                0               0.2              0.1
The bypass capacitor (C1) on the voltage double pin V2X
                                                                                                1               0.4              0.2
must instantaneously furnish the gate charge without                           2
excessive droop (e.g., less than 200mV):                                                        2               0.8              0.4
                                                                                                4               1.6              0.8
                       ∆V2X = Qg/C1
                                                                         Note: The current must be large enough such that the switcher
Continuing with the example, ∆V+ = 17nC/0.1μF = 170mV.                   can reach its target output voltage (< 1s).
Figure 6 uses an IRLM10060TRPBF logic-level nFET with
a guaranteed threshold voltage (VTH) of 2.5V.
                                                               CURRENT PATH
                                                          KELVIN CONNECTIONS
                              COPPER                                                                 COPPER
                               TRACE                                                                  TRACE
                                     SENSE RESISTOR OUTLINE
                                                                               ROUTE SENSE LINES ALONG
                                                                               THE SAME PATH
                                                                   IN+ IN-
Figure 7. Kelvin Sense Connection Layout Example
www.maximintegrated.com                                                                                              Maxim Integrated │ 22


MAX35104                                                                                   Gas Flow Meter SoC
Inductor (L)                                                  high voltage transducer drivers. The regulator is used
Practical inductor values range from 5μH to 150μH. 56μH       to provide a more stable higher bandwidth source from
is a good choice for most applications. Larger inductance     which the transducers can be driven. This helps mitigate
values tend to increase the startup time slightly, while      any loading mismatches between the two transduc-
smaller inductance values allow the coil current to ramp      ers and provides a more repeatable launch signature
up to higher levels before the over current switch halts      between upstream and downstream measurements, ulti-
switching, increasing the ripple at light loads. Inductors    mately reducing overall system error.
with a ferrite core or equivalent are recommended; pow-       The high-voltage linear regulator operates from 5.4V to
der iron cores are not recommended for use with high          27V in programmable 1.7V steps set by the VS[3:0] bits in
switching frequencies. Make sure the inductor’s satura-       the Switcher 1 register. There is an option to not use the
tion current rating (the current at which the core begins     high voltage regulator in the case where it is not desired
to saturate and the inductance starts to fall) exceeds the    and the switcher voltage is deem sufficient to drive the
peak current rating set by RSENSE. For highest efficiency,    transducers. Disable the regulator with the HREG_EN bit
use a coil with low DC resistance, preferably under 20mΩ.     in the Switcher 1 register. When disabled the VPR and VP
To minimize radiated noise, use a toroid, a pot core, or a    pins must be externally shorted together.
shielded coil.                                                When the regulator is enabled, its output is cycled off and
Diode                                                         on automatically by the device at the same time as the
The device high switching frequency demands a high-           boost switcher, see example timing Figure 3.
speed rectifier. Schottky diodes such as the B340A-13-F       Output Capacitor Selection
are recommended. Make sure the Schottky diode’s aver-         For stable operation over the full temperature range, use
age current rating exceeds the peak current limit set by      a low-ESR 1µF (min) 0805 ceramic output capacitor on
RSENSE, and that its breakdown voltage exceeds VOUT.          the VPR pin. Ceramic capacitors exhibit capacitance
Output Filter Capacitor                                       and ESR variations over temperature. Ensure that the
The primary criterion for selecting the output filter capaci- minimum capacitance under worst-case conditions does
tor is low effective series resistance (ESR). The product of  not drop below 1µF to ensure output stability. With a 1µF
the peak inductor current and the output filter capacitor’s   X7R dielectric, is sufficient at all operation temperatures.
ESR determines the amplitude of the ripple seen on the        Transducer Driver
output voltage. Smaller-value and/or higher- ESR capaci-
                                                              The device has two integrated high voltage full-bridge
tors are acceptable for light loads or in applications that
                                                              transducer drivers, one for the upstream and one for the
can tolerate higher output ripple. Since the output filter
                                                              downstream transducer as shown in Figure 8. The drivers
capacitor’s ESR affects efficiency, use low-ESR capaci-
                                                              direct connect to the transducers without any external
tors for best performance.
                                                              components required. The drivers can also be configured
Piezo Driver Regulator                                        to drive the transducer in a single-ended manner. Set
The MAX35104 provides an internal high voltage low            the single-ended drive enable bit, SD_EN, in the AFE
dropout linear regulator. The input to this regulator is the  1 register. In this configuration, the negative terminal of
boost switcher’s output and the output of the regulator       the drivers are held at ground and the positive terminal
supplies the high side bias used for the CMOS push pull       is modulated between the high-voltage node and ground.
www.maximintegrated.com                                                                                Maxim Integrated │ 23


MAX35104                                                                                          Gas Flow Meter SoC
                                                        VHV_REGULATOR
                                                                        TX_UPP
                                              DRIVER                                  DOWNSTREAM
                                                                                      TRANSDUCER
                                                        VHV_REGULATOR
                                                                        TX_UPN
                                    MAX35104
                                                        VHV_REGULATOR
                                                                        TX_DNP
                                              DRIVER                                  UPSTREAM
                                                                                      TRANSDUCER
                                                        VHV_REGULATOR
                                                                        TX_DNN
Figure 8. Piezo Driver Connection
Analog Front-End                                                      applied to the common mode, providing an additional
The device has a programmable analog front-end used                   level of system accuracy and robustness.
to condition the return signal before the signal is used              The first stage is a fixed 20dB gain amplifier. An internal
to determine when the stop-hit timing should occur. This              analog switch automatically connects the input of this
analog front-end consists of two amplifications stages, fol-          amplifier to the appropriate receiving transducer. When
lowed by a band pass filter, which feeds into the final com-          enabled, the input is pulled to VBIAS ~0.7V through 2kΩ
parator. The return signal is sampled differentially from             input resistance. The valid input range for the first amplifi-
the transducer. The entire AFE operates differentially all            cation stage, and, therefore, the targeted return amplitude
the way to the final comparator. By operating differently,            from the receiving transducer is 1mV to 10mV.
the receive chain is less susceptible to noise injections
www.maximintegrated.com                                                                                      Maxim Integrated │ 24


MAX35104                                                                                             Gas Flow Meter SoC
The second amplification stage is a programmable gain                  routine that can be used to select and set the appropriate
amplifier (PGA). The PGA is has a programmable range                   center frequency. To use this feature send the BYPASS_
from 10 dB to 30dB in 1.33dB steps set by the PGA[3:0]                 CALIBRATE command and wait until the complete bit is
bits in the AFE 1 register. Figure 9 shows the possible                set. This routine performs the required calibration and
gain settings and input voltage amplitude combinations.                automatically sets the F0 Adjust settings, bits F0[6:0] in
The ideal input amplitude for the differential stop com-               the AFE 2 register to the correct value.
parator is 350mV and therefore this should be the target               The bandpass filter can be bypassed as shown in
for the output of the AFE. Table 3 shows ideals settings               Figure 9 by enabling the BP_BP bit in the AFE1 register.
highlighted in green for all return signal amplitudes.                 If the internal analog front-end is not required it can be
The bandpass filter is a 2-pole bandpass filter with pro-              completely bypassed by externally shorting the RNX/RXP
grammable Q and center frequency. The Q of the filter                  pins to the CIN/CIP pins as shown in Figure 9 and setting
can be adjusted with four programmable options in the                  the AFE_BYPASS bit in the AFE1 register. This allows for
range for 4.2 to 12 (Hz/Hz) set by the LOWQ[1:0] bits in               an external AFE to be constructed with external compo-
the AFE 1 register. The center frequency is programmable               nents. The CIN/CIP pins can also be used to output each
from 125kHz to 500kHz in 3kHz steps set by the F0[6:0]                 stage of the AFE by setting the AFEOUT[1:0] bits in the
bits in the AFE 2 register. The MAX35104 provides an                   AFE 2 register.
integrated and automated center-frequency calibration
                                                 HARDWIRE
                                               AFE BYPASS*
                       RXN   RXP                                                    CIN CIP                     CMP_OUT/UP_DN
                                               AFE OUTPUT SELECT BITS
                                                                                                   MAX35104
                                                     AFE_BYPASS
                                                          BIT
                                                                BP BYPASS
                                                                SELECT BIT
                                                              TUNABLE BPF
                                                                 125kHz TO
                                                                   500kHz
    TX_UPN                                                                                                                   TIME-TO-
                                         10 dB                                                            PGM OFFSET          DIGITAL
    TX_UPP                       FIXED   TO 30                                                            COMPARATOR
                                 20 dB                                                                                      CONVERTER
                                          dB
    TX_ DNN
    TX_DNP                                                      TUNABLE Q
                                                              4 TO 12 (Hz/Hz)             * USED TO BYPASS INTERNAL AFE
                                                                                                         OR
                       RECEIVE                                    BP BYPASS                  TO IMPLEMENT A DIFFERENT
                 TRANSDUCER SELECT                                                            FILTERING ARCHITECTURE
Figure 9. Analog Front-End
www.maximintegrated.com                                                                                              Maxim Integrated │ 25


MAX35104                                                                                         Gas Flow Meter SoC
Table 3. Example Gain Settings
                                                       TRANSDUCER RECEIVE SIGNAL (V)
                               0.001   0.002   0.003    0.004   0.005     0.006      0.007       0.008      0.009      0.01
                       3.16    0.03    0.06    0.09     0.13    0.16       0.19       0.22       0.25        0.28      0.32
                       3.69    0.04    0.07    0.11     0.15    0.18       0.22       0.26       0.30        0.33      0.37
                        4.3    0.04    0.09    0.13     0.17    0.22       0.26       0.30       0.34        0.39      0.43
                       5.01    0.05    0.10    0.15     0.20    0.25       0.30       0.35       0.40        0.45      0.50
                       5.83    0.06    0.12    0.17     0.23    0.29       0.35       0.41       0.47        0.52      0.58
 GAIN SETTINGS (V/V)                                                                                                           AFE OUTPUT SIGNAL (V)
                        6.8    0.07    0.14    0.20     0.27    0.34       0.41       0.48       0.54        0.61      0.68
                       7.93    0.08    0.16    0.24     0.32    0.40       0.48       0.56       0.63        0.71      0.79
                       9.24    0.09    0.18    0.28     0.37    0.46       0.55       0.65       0.74        0.83      0.92
                       10.76   0.11    0.22    0.32     0.43    0.54       0.65       0.75       0.86        0.97      1.08
                       12.55   0.13    0.25    0.38     0.50    0.63       0.75       0.88       1.00        1.13      1.26
                       14.62   0.15    0.29    0.44     0.58    0.73       0.88       1.02       1.17        1.32      1.46
                       17.04   0.17    0.34    0.51     0.68    0.85       1.02       1.19       1.36        1.53      1.70
                       19.86   0.20    0.40    0.60     0.79    0.99       1.19       1.39       1.59        1.79      1.99
                       23.15   0.23    0.46    0.69     0.93    1.16       1.39       1.62       1.85        2.08      2.32
                       26.98   0.27    0.54    0.81     1.08    1.35       1.62       1.89       2.16        2.43      2.70
                       31.44   0.31    0.63    0.94     1.26    1.57       1.89       2.20       2.52        2.83      3.14
Temperature Measurement Operations                                  an approximation to the TDC converter. During the real
A temperature measurement is a time measurement of                  measurement, the TDC can then optimize its measure-
the RC circuit connected to the temperature port device             ment parameters to use power efficiently. These evalu-
pins T1, T2, and TC. The TC device pin has a driver to              ate cycles are automatically inserted. The time from the
charge the timing capacitor.                                        start of one port’s temperature measurement to the next
                                                                    port’s temperature measurement is set using with the
Figure 6 depicts a 10kΩ NTC thermistor with a 10nF NPO              PORTCYC[1:0] bits in the Event Timing 2 register.
COG 30ppm/°C capacitor. It shows two dummy cycles
with two temperature port-evaluation measurements and               Once all the temperature measurements are completed,
two real temperature port measurements.                             the times measured for each port are reported in the cor-
                                                                    responding TxInt and TxFrac Results registers. The TE bit
The Dummy 1 and Dummy 2 cycles represent preamble                   in the Interrupt Status register is also set and the INT pin
measurements that are intended to eliminate the dielectric          is asserted (if enabled).
absorption of the temperature measurement capacitor.
These Dummy cycles are executed using a thermistor                  Actual temperature is determined by a ratio-metric calcu-
Emulation resistor of 1000 Ohms internal to the device.             lation. If T2 is connected to a thermistor and T1 is con-
This Dummy path allows the dielectric absorption effects            nected to the reference resistor (as shown in the System
of the capacitor to be eliminated without causing the               Diagram), then the ratio of T2/T1 = RTHERMISTOR/RREF..
thermistor to be unduly self-heated. The number of                  The ratio RTHERMISTOR/RREF. can be determined by the
Dummy measurements to be taken ranges from 0 to 7.                  host microprocessor and the temperature can be derived
This parameter is configured by setting the PRECYC[2:0]             from a lookup table of Temperature vs. Resistance for the
bits in the Event Timing 2 register.                                thermistor utilizing interpolation of table entries if required.
Following the dummy cycles, an evaluation, TXevaluate,              Temperature Error Handling
is performed. This measurement allows the device to                 The temperature measurement unit can detect open and/
maximize power efficiency by evaluating the temperature             or short circuit temperature probes. If the resultant tem-
of the thermistor with a coarse measurement prior to a              perature reading in less than 8µs, then the device writes
real measurement. The coarse measurement provides                   a value of 0000h to the corresponding Results registers to
www.maximintegrated.com                                                                                      Maxim Integrated │ 26


MAX35104                                                                                  Gas Flow Meter SoC
Table 4. Randomizer Sampling                                  ●●    EVTMG2: Performs automatic TOF_DIFF measure-
                                                                    ments. The parameters and operation of the TOF
       TDF          MINIMUM         MAXIMUM           LSB           measurement are described in the Time-of-Flight
  FREQUENCY       NEXT SAMPLE NEXT SAMPLE WEIGHT                    Measurement section.
       (Hz)        PERIOD (S)       PERIOD (S)         (S)
                                                              ●●    EVTMG3: Performs automatic Temperature
       0.50           0.082             1.00         2.0E-3         measurements. The parameters and operation of the
       1.00           0.084             2.00         3.9E-3         Temperature measurements are described in
       1.50           0.086             2.99         5.9E-3         the Temperature Measurement section.
       2.00           0.088             3.99         7.8E-3   ●●    EVTMG1: Performs automatic TOF_DIFF and
                                                                    Temperature measurements.
       2.50           0.090             4.99         9.8E-3
       3.00           0.092             5.99        11.7E-3   Continuous Event Timing Operation
       3.50           0.094             6.99        13.7E-3   The device can be configured to continue running Event
                                                              Timing sequences at the completion of any sequence. If
       4.00           0.096             7.98        15.6E-3
                                                              the ET_CONT bit in the Calibration and Control register
       4.50           0.098             8.98        17.6E-3   is set, the currently executing EVTMGx command con-
       5.00           0.100             9.98        19.5E-3   tinues to execute until a HALT command is received by
       5.50           0.101            10.98        21.5E-3   the device. If the ET_CONT bit is clear, automatic execu-
                                                              tion of Event Timing stops after the completion of a full
       6.00           0.103            11.98        23.4E-3
                                                              sequence of measurements.
       6.50           0.105            12.97        25.4E-3
                                                              Continuous Interrupt Timing Operation
       7.00           0.107            13.97        27.3E-3
                                                              When operating in Event Timing Mode, the INT pin
       7.50           0.109            14.97        29.3E-3
                                                              can be asserted (if enabled) either after each TOF or
       8.00            0.111           15.97        31.3E-3   Temperature measurement, or at the completion of the
                                                              sequence of measurements. If the CONT_INT bit in the
indicate a short circuit temperature probe. If the measure-   Calibration and Control register is set to a 1, then the INT
ment process does not discharge the TC pin below the          pin is asserted (if enabled) at the completion of each TOF
threshold of the internal temperature comparator within       or Temperature command. This allows the host micro-
2µs of the time set by the PORTCYC[1:0] bits in the Event     controller to interrogate the current Event for accuracy of
Timing 2 register, then an open circuit temperature probe     measurement. If the CONT_INT bit is set to a 0, then the
error is declared. The MAX35104 writes a value of FFFFh       INT pin is only asserted (if enabled) at the completion of
to the corresponding results registers to indicate an open    a sequence of measurements. This allows the host micro-
circuit temperature probe, the TO bit in the Interrupt Status controller to remain in a low-power sleep mode and only
register is set, and the INT pin is asserted (if enabled). If wake-up upon the assertion of the INT pin.
the temperature measurement error is caused by any
other problems, then the device writes a value of FFFFh       TOF Sample Randomizer
to each of the temperature port results registers indicating  The device has the ability to randomize the TOF samples
that all the temperature port measurements are invalid.       when operating in event timing mode, given a sample fre-
                                                              quency as selected by the TDF[3:0] bits, the subsequent
Event Timing Operation                                        samples in the sequence occur at a period ±(1/F) from the
The Event Timing mode of operation is an advanced             previous sample.
feature that allows the user to configure the device to
                                                              This is accomplished using a 9-bit linear feedback shift
perform automatic measurement cycles. This allows
                                                              register (LFSR) to randomize the internals between suc-
the host microcontroller to enter low power mode and
                                                              cessive samples. The feedback polynomial implemented
only awaken upon assertion of the INT pin (if enabled)
                                                              for the LFSR is x9 + X5 + 1.
when new measurement data is available. By using the
TOF_DIFF and Temperature commands and configur-               For example, if TDF[3:0] is set to 0, which is a sample fre-
ing the appropriate TOFx registers and the Event Timing       quency of 0.5s and an event timing mode is initiated, the
registers, the Event Timing Modes directs the device to       first sample occurs 0.5s after that start. The subsequent
provide complete data for a sequence of measurements          samples occur at a time between 0.082s and 1s after the
captured on a cyclical basis. There are three versions of     start of the previous sample, and so on. The times are
the EVTMG commands.                                           start-to-start times.
www.maximintegrated.com                                                                              Maxim Integrated │ 27


MAX35104                                                                                                                    Gas Flow Meter SoC
                                                        DRIVER TO CHARGE TC-                                COUNT BEGINS
                                                        CONNECTED CAPACITOR                                           COUNT ENDS
                               VDD
                                3.0
       CAPACITOR VOLTAGE (V)
                                2.0
                               1.2
                               1.0
                                      DUMMY 1           DUMMY 2          T1 EVALUATE          T2 EVALUATE            T1                 T2
                                 0                128              256                 384                   512              640               768
                                       SCHMITT                                                                          PORTCYCLE TIME SET TO 128µs
                                       TRIGGER                                    TIME (µs)
                                                                                                                       DUMMY MEASUREMENTS SET TO 2
                                      THRESHOLD
Figure 10. Temperature Command Execution Cycle Example
Error Handling During Event Timing Operation                                                 measurements. In addition, the Temperature Average
During execution of Event Timing modes, any error that                                       Results registers, TxAVG, are not updated with the error
occurs during a TOF_DIFF or Temperature measurement                                          measurement if a temperature error occurs during Event
are handled as described in the corresponding error                                          Timing Operation.
handling sections. Calibration can also be executed dur-                                     Event Timing Mode 2
ing Event Timing operation, if programmed to do so with                                      The EVTMG2 command execution causes the TOF_DIFF
the Calibration Configuration bits in the Calibration and                                    command to be executed automatically with program-
Control register. If a Calibration error occurs, this is han-                                mable repetition rates and programmable total counts as
dled as described in the Error Handling during Calibration                                   shown in Figure 11.
section. If any of these errors occur, the Event Timing
operation does not terminate, but continues operation.                                       During execution of the EVTMG2 command, each TOF_
                                                                                             DIFF command execution cycle causes the device to
When making TOF measurements in Event Timing Mode,                                           compute a TOF_DIFF measurement (AVGUP register
the device provides additional data in the TOF_Cycle_                                        minus AVGDN register) as well as the running average of
Count/TOF_Range register that can be used to check                                           TOF_DIFF measurements (TOFF_DIFF_AVG register).
the validity of all the TOF measurements. The TOF_                                           The setting of the TDF[3:0] bits in the Event Timing 1 reg-
Cycle_Count is the number of valid error-free TOF mea-                                       ister selects the rate at which TOF_DIFF commands are
surements that were recorded during an Event Timing                                          executed. The setting of the TDM[4:0] bits in the Event
Sequence. If a TOF error occurs, the TOF_Cycle_Count                                         Timing 1 register determines the number of TOF_DIFF
register is not incremented. The TOF_Range is the range                                      measurements to be taken during the sequence.
of all valid TOF measurements that were captured during
a sequence.                                                                                  Once all the TOF_DIFF measurements in the sequence
                                                                                             are captured, the TOF_DIFF_AVG register contains the
When making temperature measurements in Event                                                average of the differences of the resultant AVGDN and
Timing Mode, the device provides additional data in the                                      AVGUP Results register content of each TOF_DIFF
Temp_Cycle_Count register. This count increments after                                       measurement. After the TOF_DIFF_AVG registers are
every valid error-free temperature measurement and                                           updated, the TOF_EVTMG bit is set in the Interrupt Status
can be used to check the validity of all the temperature                                     register and the INT pin is asserted (if enabled).
www.maximintegrated.com                                                                                                                  Maxim Integrated │ 28


MAX35104                                                                                                       Gas Flow Meter SoC
                                     EVTMG2
                                    COMMAND
                            TIME OF FLIGHT EVENT                                                HOST MICROCONTROLLER USE OF EVTMG2
                                                                                                          TIME OF FLIGHT EVENT
                                      START
                                                                                            PROGRAM TOF
                             GET CONFIGURATION
                                REGISTER DATA                                                 DIFFERENCE                     PROGRAMMABLE IN
                                                                                            MEASUREMENT                      0.5 SECOND STEPS
                                                                                              FREQUENCY                       UP TO 8 SECONDS
                                  START TIMER                                              (8XS/TDF3-TDF0)
                                                                                       (EG. EVERY 2 SECONDS)
                               IS TIMER > = NEXT NO                                  PROGRAM NUMBER OF TOF
                                 8XS/TDF3-TDF0                                                DIFFERENCE                           UP TO 32
                                  INCREMENT?            ASSERT THE INT                                                      MEASUREMENTS CAN
                                                          DEVICE PIN
                                                                                           MEASUREMENTS
                                                                                     (TDM4-TDM0) TO BE TAKEN                      BE TAKEN
                                          YES                                                    (EG. 15)
                              PERFORM TOF_DIFF
                                    COMMAND
                                                                                       CONFIGURE REMAINING
                                                                                        MAX35104 REGISTERS
                        YES    IS TIMER > = NEXT
                                                                                      INCLUDING THE CONT_INT
                                 8XS/TDF3-TDF0
                                  INCREMENT?                                              AND ET_CONT BITS
                                          NO
                                                                                          SEND THE EVTMG2
                              COMPUTE RUNNING
         SEE ERROR             AVG FOR TOF_DIFF                                                COMMAND
          HANDLING           MEASUREMENTS AND
        DESCRIPTION                 STORE AT
                                 TOF_DIFF_AVG
                                                                                       WAIT FOR ASSERTION OF
                                                                                            INT DEVICE PIN
                                   INCREMENT
                              TOF_CYCLE_COUNT
                                                      SETTING CONT_INT
                                                         ALLOWS HOST                  READ INTERRUPT STATUS
                                   INCREMENT
                                                      MICROCONTROLLER                          REGISTER
                                                       TO INTERROGATE
                               SEQUENCE CYCLE
                                                       MAX35104 AFTER
                                    COUNTER
                                                     EACH MEASUREMENT
                                                            CYCLE
                                                                               NO
                               SEQUENCE CYCLE    NO                                         IS TOF_EVTMG
                               COUNTER = TDM4-                                                  BIT SET?
                                      TDM0 ?
                                          YES                          NO
                                                       IS THE CONT_INT                                YES
                                                           BIT SET?
                                     SET THE                                                                                AVERAGE OF 15 TOF
                               TOF_EVTMG BIT IN                                          READ TOF_DIFF_AVG,                      DIFFERENCE
                                THE INTERRUPT                    YES                                                        MEASUREMENTS ARE
                               STATUS REGISTER
                                                                                          TOF_DIFF, AVGUP,
                                                                                       AVGDN, HITX REGISTERS                   READY FOR THE
                                                        ASSERT THE INT
                                                          DEVICE PIN                         FOR TOF DATA                           HOST
                                                                                                                            MICROCONTROLLER
                                ASSERT THE INT
                                   DEVICE PIN
                                                        ASSERT THE INT
                                                          DEVICE PIN
    SETTING ET_CONT BIT
        CAUSES THE                                                                                                   NO             OTHER
      SEQUENCE TO BE                             YES                                       IS THE ET_CONT
        CONTINUOUS
                              IS THE ET_CONT BIT
                                                                                                BIT SET?                          PROCESS
                                       SET?
                                          NO
                                                                                                      YES
                                       END
Figure 11. EVTMG2 Command                                                 Figure 12. EVTMG2 Pseudo Code
www.maximintegrated.com                                                                                                      Maxim Integrated │ 29


MAX35104                                                                                   Gas Flow Meter SoC
Event Timing Mode 3                                          Calibration Operation
The EVTMG3 command execution causes the                      For more accurate results, calibration of the TDC can be
Temperature command to be executed automatically with        performed. Calibration allows the device to perform a cali-
programmable repetition rates and programmable total         bration measurement that is based upon the 32.768kHz
counts as shown in Figure 13.                                crystal, which is the most accurate clock in the system.
During execution of the EVTMG3 command, each                 This calibration is used when a ceramic oscillator is
Temperature command execution cycle computes the             used in place of an AT-cut crystal for the 4MHz refer-
running average of the measurement of each tempera-          ence. The device automatically generates start and stop
ture port. The results are provided in the Tx_AVGInt and     signals based upon edges of the 32.768kHz clock. The
TxAVGFrac Results registers.                                 number of 32.768kHz clock periods that are used and
                                                             then averaged are selected with the CAL_PERIOD[3:0]
The setting of the TMF[5:0] bits in the Event Timing 1
                                                             bits in the Calibration and Control register. The TDC
register selects the rate at which Temperature commands
                                                             measures the number of 4MHz clock pulses that occur
are executed. The setting of the TMM[4:0] bits in the Event
                                                             during the 32.768kHz pulses. The measured time of a
Timing 2 register determines the number of temperature
                                                             32.768kHz clock pulse is reported in the CalibrationInt
measurements to be taken during the sequence.
                                                             and CalibrationFrac Results registers. These results can
Once all the Temperature measurements in the sequence        then be used as a gain factor for calculating actual Time-
are captured, the Tx_AVGInt and TxAVGFrac Results reg-       to-Digital converter measurement if the CAL_USE bit in
isters contain the average of all the temperature measure-   the Event Timing 2 register is set.
ments in the sequence. After these registers are updated,
                                                             Following is a description of an example calibration. Each
the Temp_EVTMG bit is set in the Interrupt Status register
                                                             TDC measurement is a 15-bit fixed-point integer value
and the INT pin is asserted (if enabled).
                                                             concatenated with a 16-bit fractional value binary repre-
Event Timing Mode 1                                          sentation of the number of t_4MHz periods that contribute
The EVTMG1 command execution causes the TOF_DIFF             to the time result, the actual period of t_4MHz needs to
command and the Temperature Command to be executed           be known. If the CAL_PERIOD[3:0] bits in the Calibration
automatically with programmable repetition rates and pro-    and Control register are set to 6, then six measurements
grammable total counts. In essence, both the EVTMG2          of 32.768kHz periods are measured by the TDC and
and EVTMG3 commands are simultaneously executed in           then averaged. The expected measured value would be
a synchronous manner.                                        30.5176µs/250ns = 122.0703125 t_4MHz periods. Let
                                                             us assume that the 4MHz ceramic resonator is actually
Setting up the TOF measurements for automatic execu-
                                                             running at 4.02MHz. The TDC measurement unit would
tion in Event Timing Mode 1 is identical to setting these up
                                                             then measure 30.5176µs/248.7562ns = 122.6806641
for execution with Event Timing Mode 2. Likewise, setting
                                                             t_4MHz periods and this result would be returned in the
up the Temperature Measurements is identical to setting
                                                             Calibration Results register. For all TDC measurements, a
these up for execution using Event Timing Mode 3.
                                                             gain value of 122.0703125/122.6806641 = 0.995024876
If the TOF_DIF command repetition rate and the               would then be applied.
Temperature command repetition rate cause both mea-
                                                             Calibration is performed at the following events:
surements to be required at the same time, the TOFF_DIF
command takes precedent. Upon completion of the              ●●   When the Calibration command is sent to the
TOFF_DIFF command, the pending Temperature com-                   MAX35104. At the completion of this calibration, the
mand is executed, as shown in Figure 15.                          CAL bit in the Interrupt Status register and the INT
                                                                  pin is asserted (if enabled).
Once all the TOF_DIFF measurements in the sequence
are complete, the TOF_EVTMG bit in the Interrupt             ●●   During Event Timing Operation, automatic calibra-
Status register is set and the INT pin asserts (if enabled).      tions can be performed before executing TOF or
Likewise, when all the Temperature measurements in the            Temperature measurements. This is selectable with
sequence are completed, the Temp_EVTMG bit in the                 the CAL_CFG[2:0] bits in the Event Timing 2 register.
Interrupt Status register is set and the INT pin is asserted      Upon completion of an automatic calibration during
(if enabled). It should be noted that depending upon the          Event Timing, the result is updated in the Calibration
selected rates and number of cycles, the TOF_DIFF and             Results register, but the CAL bit in the Interrupt Sta-
Temperature measurements can complete their sequenc-              tus register is not set and the INT pin is not asserted.
es at different times. This causes the INT pin to be assert-
ed (if enabled) before both sequences are complete.
www.maximintegrated.com                                                                              Maxim Integrated │ 30


MAX35104                                                                                                       Gas Flow Meter SoC
                                     EVTMG3
                                    COMMAND
                             TEMPERATURE EVENT                                                   HOST MICROCONTROLLER USE OF EVTMG3
                                                                                                           TEMPERATURE EVENT
                                      START
                                                                                       PROGRAM TEMPERATURE
                             GET CONFIGURATION
                                REGISTER DATA                                                 DIFFERENCE                   PROGRAMMABLE IN
                                                                                             MEASUREMENT                    1 SECOND STEPS
                                                                                               FREQUENCY                   UP TO 64 SECONDS
                                  START TIMER                                               (8XS/TDF5-TDF0)
           TEMPERATURE
          MEASUREMENT                                                                  (EG. EVERY 15 SECONDS)
         REPETITION RATE
                                                                                         PROGRAM NUMBER OF
                               IS TIMER > = NEXT NO
                                                                                             TEMPERATURE
                                 8XS/TDF5-TDF0                                                                                  UP TO 32
                                  INCREMENT?                                                  DIFFERENCE
                                                                                                                          MEASUREMENTS CAN
                                                                                           MEASUREMENTS
                                                                                                                                BE TAKEN
                                          YES                                         (TDM4-TDM0) TO BE TAKEN
                                    PERFORM                                                       (EG. 2)
                                 TEMPERATURE
                                    COMMAND
                                                                                        CONFIGURE REMAINING
                                                                                         MAX35104 REGISTERS
                         YES     TEMPERATURE                                          INCLUDING THE CONT_INT
                              COMMAND ERROR ?
                                                                                          AND ET_CONT BITS
                                          NO
                              COMPUTE RUNNING                                             SEND THE EVTMG3
                                 AVG FOR EACH
         SEE ERROR              MEASURED PORT
                                                                                                COMMAND
          HANDLING               AND STORE AT
        DESCRIPTION             T1_AVG, T2_AVG,
                                T3_AVG, T4_AVG
                                    REGISERS
                                                                                       WAIT FOR ASSERTION OF
                                                       SETTING CONT_INT
                                                          ALLOWS HOST
                                                                                             INT DEVICE PIN
                                   INCREMENT
                             TEMP_CYCLE_COUNT         MICROCONTROLLER
                              RESULTS REGISTER          TO INTERROGATE
                                                        MAX35104 AFTER
                                                     EACH MEASUREMENT                  READ INTERRUPT STATUS
                                                              CYCLE
                                   INCREMENT
                                                                                                REGISTER
                               SEQUENCE CYCLE
                                    COUNTER
                                                                                NO
                               SEQUENCE CYCLE    NO                     NO                  IS TEMP_EVTMG
                                                        IS THE CONT_INT
                               COUNTER = TDM4-               BIT SET?                            BIT SET?
                                      TDM0 ?
                                          YES                      YES
                                                                                                       YES
                                     SET THE                 SET THE                                                       ACCUMULATION OF
                               TOF_EVTMG BIT IN           TE BIT IN THE                 READ THE TXINT, TXFRAC,            TWO TEMPERATURE
                                THE INTERRUPT         INTERRUPT STATUS                                                    MEASUREMENTS ARE
                               STATUS REGISTER              REGISTER
                                                                                        TX_AVGINT, TX_AVGFRAC
                                                                                             REGISTERS FOR                   READY FOR THE
                                                                                          TEMPERATURE DATA                        HOST
                                                                                                                           MICROCONTROLLER
                                ASSERT THE INT           ASSERT THE INT
                                   DEVICE PIN              DEVICE PIN
    SETTING ET_CONT BIT
        CAUSES THE                                                                                                 NO            OTHER
      SEQUENCE TO BE                             YES                                       IS THE ET_CONT
        CONTINUOUS
                              IS THE ET_CONT BIT
                                                                                                 BIT SET?                       PROCESS
                                       SET?
                                          NO
                                                                                                       YES
                                       END
Figure 13. EVTMG3 Command                                                  Figure 14. EVTMG3 Pseudo Code
www.maximintegrated.com                                                                                                     Maxim Integrated │ 31


MAX35104                                                                                              Gas Flow Meter SoC
                          HOST MICROCONTROLLER USE OF EVTMG1
                                                                          Error Handling during Calibration
                            TIME OF FLIGHT / TEMPERATURE EVENT
                                                                          Since calibration can be set to be automatic by configur-
                      PROGRAM TOF
                                                                          ing the CAL_CFG[2:0] bits in the Event Timing 2 register,
                       DIFFERENCE
                      MEASUREMENT
                                                      PROGRAMMABLE IN     any errors that occur during the Calibrate command stop
                                                       0.5 SECOND STEPS
                        FREQUENCY                      UP TO 8 SECONDS    the CalibrationInt and the CalibrationFrac Results regis-
                     (8XS/TDF3-TDF0)
                 (EG. EVERY 2 SECONDS)                                    ters from being updated with new calibration coefficients.
                                                                          The results for the previous Calibration data remain in
              PROGRAM NUMBER OF TOF
                                                                          these two registers and be used for scaling measured
                       DIFFERENCE
                    MEASUREMENTS
                                                             UP TO 32
                                                     MEASUREMENTS CAN
                                                                          results. If the calibration error is caused by the internal
               (TDM4-TDM0) TO BE TAKEN                      BE TAKEN      calibration time measurement exceeding the time set
                           (EG. 2)
                                                                          by the TIMOUT[2:0] bits in the TOF2 register, the TO bit
                                                                          in the Interrupt Status register is set and the INT pin is
                PROGRAM TEMPERATURE
              MEASUREMENT FREQUENCY
                                                      PROGRAMMABLE IN     asserted (if enabled).
                                                        1 SECOND STEPS
                     (8XS/TMF5-TMF0)
                                                      UP TO 64 SECONDS
                (EG. EVERY 15 SECONDS)
                                                                          RTC, Alarm, Watchdog, and Tamper Operation
                                                                          RTC Operation
                      PROGRAM # OF
                      TEMPERATURE                            UP TO 32     The device contains a real-time clock (RTC) that is driven
                    MEASUREMENTS                     MEASUREMENTS CAN
              (TMM4-TMM0) TO BE TAKEN                       BE TAKEN      by the 32kHz oscillator. The time and calendar informa-
                           (EG. 2)
                                                                          tion is obtained by reading the appropriate register words.
                                                                          The time and calendar are set or initialized by writing the
                 CONFIGURE REMAINING                                      appropriate register words. The contents of the time and
                  MAX35104 REGISTERS
               INCLUDING THE CONT_INT                                     calendar registers are in the binary-coded decimal (BCD)
                   AND ET_CONT BITS
                                                                          format. The clock/calendar provides hundredths of sec-
                                                                          onds, tenths of seconds, seconds, minutes, hours, day,
                   SEND THE EVTMG3
                         COMMAND
                                                                          date, month, and year information. The date at the end
                                                                          of the month is automatically adjusted for months with
                WAIT FOR ASSERTION OF
                                                                          fewer than 31 days, including corrections for leap year
                      INT DEVICE PIN                                      valid up to 2100. The clock operates in either the 24-hour
                                                      AVERAGE OF 15 TOF
                                                           DIFFERENCE     or the 12-hour format with AM/PM indicator. The device’s
                READ INTERRUPT STATUS
                                                     MEASUREMENTS ARE
                                                     READY FOR THE HOST
                                                                          RTC can be programmed for either 12-hour or 24-hour
                         REGISTER
                                                      MICROCONTROLLER     formats. If using the 24-hour format, Bit6 (12 HR MODE)
                                                                          of the Mins_Hrs register should be cleared to 0 and then
                                                     READ TOF_DIFF_AVG,   Bit5 represents the 20-hour indicator. If using the 12-hour
                                                       TOF_DIFF, AVGUP,
                     IS TEMP_EVTMG
                          BIT SET?                  AVGDN, HITX REGISTERS format, Bit6 should be set to 1 and Bit5 represents AM
                                                          FOR TOF DATA
                                                                          (if 0) or PM (if 1). The day-of-week register increments
                                                                          at midnight. Values that correspond to the day of week
                                                                          are user defined but must be sequential (i.e., if 0 equals
           NO
                     IS TEMP_EVTMG                                        Sunday, then 1 equals Monday, and so on). Illogical time
                          BIT SET?
                                                                          and date entries result in undefined operation.
                                YES                                       Alarm Operation
                                                       AVERAGE OF TWO
                READ THE TXINT, TXFRAC,                  TEMPERATURE      The device’s RTC provides one programmable alarm.
                 TX_AVGINT, TX_AVGFRAC               MEASUREMENTS ARE
                      REGISTERS FOR                      READY FOR THE    The alarm is activated when either the AM1 or AM2 bits in
                                                              HOST
                   TEMPERATURE DATA
                                                      MICROCONTROLLER     the Real-Time Clock register are set. Based upon these
                                                                          bits, an alarm can occur when either the minutes and/or
                                               NO
                                                                          hours programmed in the Alarm register match the current
                                                              OTHER
                    IS THE ET_CONT
                          BIT SET?                          PROCESS       value in the Mins_Hrs register. When an Alarm occurs, the
                                                                          AF bit in the Interrupt Status register is set and the INT
                                YES                                       device pin is asserted (if enabled).
Figure 15. EVTMG1 Pseudo Code
www.maximintegrated.com                                                                                           Maxim Integrated │ 32


MAX35104                                                                                                                                            Gas Flow Meter SoC
                                                                                                        EVTMG1
                                                                                       TIME OF FLIGHT / TEMPERATURE COMMAND
                      START           GET CONFIGURATION REGISTER DATA       START TIMER
                             TOF_DIFF
                           MEASUREMENT
                            REPETITION
                                                                        IS TIMER > = NEXT         YES                                  SET
                               RATE
                                                                          8XS/TDF3-TDF0                                         TOF_PENDING
                                                                            INCREMENT?
                                                                               NO
                                                                                                                                                         TEMPERATURE
                                                                                                                                                        MEASUREMENT
                                                                                                                                                      REPETITION RATE
                                                                                                   YES                                 SET
                                                                        IS TIMER > = NEXT
                                                                                                                               TEMPERATURE_
                                                                          8XS/TMF5–TMF0
                                                                                                                                   PENDING
                                                                            INCREMENT?
                                                                               NO
                                                                                                   YES
                                                                      IS TOF_PENDING SET?
                                                                               NO
                                                                  NO              IS                                         PERFORM TOF_DIFF
                                                                          TEMPERATURE_                                            COMMAND
                                                                           PENDING SET?
                                                                              YES
                                                                                                                        YES       TOF_DIFF
               CLEAR                                                          PERFORM
                                                                                                                              COMMAND ERROR?                                      CLEAR
           TEMPERATURE_                                                   TEMPERATURE
                                                                                                                                                                               TOF_PENDING
              PENDING                                                         COMMAND
                                                                                                                                           NO
                                                                                                                             COMPUTE RUNNING
                                                                                                                              AVG FOR TOF_DIFF
                                                                 YES      TEMPERATURE                        SEE ERROR      MEASUREMENTS AND
                                                                        COMMAND ERROR?                        HANDLING            STORE AT
                                                                                                            DESCRIPTION         TOF_DIFF_AVG          SETTING CONT_INT
                                                                                                                                                         ALLOWS HOST
                                                                               NO                                                                    MICROCONTROLLER
                                                                                                                                                       TO INTERROGATE
                                                                       COMPUTE RUNNING                                           INCREMENT             MAX35104 AFTER
                                                                          AVG FOR EACH                                       TOF_CYCLE_COUNT        EACH MEASUREMENT
                                                                         MEASURED PORT                                                                       CYCLE
                                            SEE ERROR HANDLING             AND STORE AT
                                                 DESCRIPTION             T1_AVG, T2_AVG,
                                                                         T3_AVG, T4_AVG                                          INCREMENT
                                                                              REGISERS                                        SEQUENCE CYCLE
                                                                                                                                  COUNTER
                              SETTING                                        INCREMENT
                             CONT_INT                                     TEMPERATURE
                           ALLOWS HOST                                   CYCLE COUNTER                                                           NO                     NO
                                                                                                                              SEQUENCE CYCLE           IS THE CONT_INT
                          MICROCONTROLL
                                                                                                                              COUNTER = TDM4–               BIT SET?
                               ER TO
                                                                                                                                     TDM0?
                           INTERROGATE
                          MAX35104 AFTER
                                                                             INCREMENT                                                     YES                    YES
                               EACH
                                                                        SEQUENCE CYCLE
                           MEASUREMENT
                                                                              COUNTER
                               CYCLE                                                                                                SET THE                 SET THE
                                                                                                                              TOF_EVTMG BIT IN           TOF BIT IN THE
                                                                                                                               THE INTERRUPT         INTERRUPT STATUS
                                                                                                                              STATUS REGISTER              REGISTER
                                         NO                       NO    SEQUENCE CYCLE
                                               IS THE CONT_INT
                                                                        COUNTER = TMM4-
                                                   BIT SET?
                                                                                TMM0?
                                                   YES                        YES                                                       IS      YES            IS          YES
                                                                                                                            TEMPERATURE_PEND            TEMPERATURE_
                                                                                                                                   ING SET?              PENDING SET?
                                                                               SET THE
                                                    SET THE
                                                                       TEMP_EVTMG BIT IN
                                            BIT IN THE INTERRUPT                                                                           NO                     NO
                                                                          THE INTERRUPT
                                              STATUS REGISTER
                                                                        STATUS REGISTER
                                                                                                    SETTING ET_CONT BIT
                                                                                                          CAUSES THE           ASSERT THE INT           ASSERT THE INT
                                                                                                       SEQUENCE TO BE            DEVICE PIN               DEVICE PIN
                                                ASSERT THE INT           ASSERT THE INT
                                                  DEVICE PIN                 DEVICE PIN                  CONTINUOUS
                                                                 YES                                                                            YES
                                                                       IS THE ET_CONT BIT                                    IS THE ET_CONT BIT
                                                                                 SET?                                                 SET?
                                                                               NO                                                          NO
                                                                                 END                                                  END
Figure 16. EVTMG1 Command
www.maximintegrated.com                                                                                                                                                 Maxim Integrated │ 33


MAX35104                                                                                   Gas Flow Meter SoC
For proper alarm function, programming of the ALARM           real-time events being performed by the MAX35104.
register HOURS bits must match the format (12- or             Upon completion of any command, the device alerts the
24-hour modes) used in the Mins_Hrs register.                 host microprocessor using the INT pin. The assertion of
                                                              the INT pin can be used to awaken the host microproces-
Watchdog Operation
                                                              sor from its low-power mode. Upon receiving an interrupt
The device also contains a watchdog alarm. The Watchdog       on the INT pin, the host microprocessor should read the
Alarm Counter register is a 16-bit BCD counter that is pro-   Interrupt Status register to determine which tasks were
grammable in 10ms intervals from 0.01 to 99.99 seconds.       completed.
A seed value can be written to this register representing
the start value for the countdown. The watchdog counter       Interrupt Status Register
begins decrementing when the WD_EN bit in the RTC             The interrupt status register contains flags for all for all
register is set.                                              commands and events that occur within the MAX35104.
An immediate read of Watchdog Alarm Counter returns           These flags are set when the event occurs or at the
the value just written. A read after a “wait” duration causes completion of the executing command. When the Interrupt
a value “seed” minus “wait” to be returned. For example       Status Register is read, all asserted bits are cleared. If
if the seed value was 28.01 seconds, an immediate read        another interrupt source has generated an interrupt during
returns 28.01. A read after a 4 seconds returns 24.01 sec-    the read, these new flags are asserted following the read.
onds. The value read out for any read operation is a snap-    INT Pin
shot obtained at the instant of a serial read operation.      The device’s INT pin is asserted when any of the bits in
A write operation to the Watchdog Alarm Counter causes a      the Interrupt Status register are set. The INT pin remains
re-load with the newly written seed. When the Watchdog is     asserted until the Interrupt Status register is read by the
enabled and a non-zero value is written into the Watchdog     user and all bits in this register are clear. For the INT pin
Alarm Counter, the Watchdog Alarm Counter decrements          to operate, it must first be enabled by setting the INT_EN
every 1/100 second, until it reaches zero. At this point, the bit in the Calibration and Control register.
WF bit in the Real Time Clock register is set and the WDO
pin is asserted low for a minimum of 150ms. At the end of     Serial Peripheral Interface Operation
the pulse, the WDO pin becomes high impedance.                Four pins are used for SPI-compatible communications:
                                                              DOUT (serial-data out), DIN (serial-data in), CE (chip
The WF flag remains set until cleared by writing WF to
                                                              enable), and SCK (serial clock). DIN and DOUT are
a logic 0 in the Real-Time Clock register. If the WF bit is
                                                              the serial data input and output pins for the devices,
cleared while the WDO device pin is being held low, the
                                                              respectively. The CE input initiates and terminates a data
WDO device pin is immediately released to its high-imped-
                                                              transfer. SCK synchronizes data movement between the
ance state. Writing a seed value of 0 does not cause the
                                                              master (microcontroller) and the slave (MAX35104). The
WF bit to be asserted.
                                                              SCK, which is generated by the microcontroller, is active
Tamper Detect Operation                                       only when CE is low and during opcode and data transfer
The device provides a single input that can be connected      to any device on the SPI bus. The inactive clock polarity
to a device case switch and used for tamper detection.        is logic-low. DIN is latched on the falling edge of SCK.
Upon detection of a case switch event the CSWA in             There is one clock for each bit transferred. Opcode bits
the Control Register and the CSWI bit in the Interrupt        are transferred in groups of eight, MSB first. Data bits are
Status register is set and the INT device pin is asserted     transferred in groups of 16, MSB first.
(if enabled).                                                 The SPI is used to access the features and memory of the
                                                              MAX35104 using an opcode/command structure.
Device Interrupt Operations
The device is designed to optimize the power efficiency       Opcode Commands
of a flow metering application by allowing the host micro-    The MAX35104 supports the opcode/commands shown
processor to remain in a low power sleep mode, instead        in Table 5.
of requiring the microprocessor to keep track of complex
www.maximintegrated.com                                                                                Maxim Integrated │ 34


MAX35104                                                                                   Gas Flow Meter SoC
Table 5. Opcode Commands
   GROUP           COMMAND          OPCODE FIELD (HEX)                           EXECUTION OPCODE COMMANDS
                     TOF_Up                   00h
                                                                  CE
                    TOF_Down                  01h
                     TOF_Diff                 02h
                   Temperature                03h                                 0   1    2    3    4 5  6    7
                      Reset                   04h                SCK
  Execution
   Opcode      Bandpass_Calibrate             06h
  Commands           EVTMG1                   07h                                O                           O
                                                                  DIN
                     EVTMG2                   08h                                                           LSB
                                                                                 MSB          8 BITS
                     EVTMG3                   09h
                      HALT                    0Ah                                            OPCODE
                     Calibrate                0Eh               DOUT                    HIGH IMPEDANCE
                                      94h–97h, B0h–FFh
                                        Each hex value
                  Read Register     represents the location Figure 17. Execution Opcode Command Protocol
                                       of a single 16-bit
   Register                                 register.       Note: The TOF_UP command yields absolute time of
   Opcode                                                   flight results that include circuit delays.
  Commands                         14h–17h, 30h–43h Each
                                           hex value        TOF_Down Command (01h)
                  Write Register    represents the location
                                                            The TOF_DOWN command generates a single TOF
                                       of a single 16-bit
                                                            measurement in the downstream direction. Pulses are
                                            register.
                                                            launched from the TX_DNP and TX_DNN pins and
                                                            received by TX_UPP and TX_UPN pins. The measured
Execution Opcode Commands                                   hit results are reported in the HITxDnInt and HITxDnFrac
The device supports several single byte opcode com-         registers, with the calculated average of all the measured
mands, which cause the MAX35104 to execute various          hits being reported in the AVGDNInt and AVGDNFrac
routines. All commands have the same SPI protocol           register. The t1/t2 and t2/tIDEAL wave ratios are reported
sequence as shown in Figure 17. Once all 8 bits of the      in the WVRDN register. Once all these results are stored,
opcode are received by the MAX35104 and the CE              the TOF bit in the Interrupt Status register is set and the
device pin is deasserted, the device begins execution of    INT pin is asserted (if enabled).
the specified command as described in that Command’s        Note: The TOF_Down command yields absolute time of
description.                                                flight results that include circuit delays.
TOF_UP Command (00h)                                        TOF_DIFF Command (02h)
The TOF_UP command generates a single TOF mea-              The TOF_DIFF command performs back-to-back TOF_
surement in the upstream direction. Pulses are launched     UP and TOF_DN measurements as required for a meter-
from the TX_UPP and TX_UPN pins and received by the         ing application. The TOF_UP sequence is followed by the
TX_DNP and TX_DNN pins. The measured hit results            TOF_DN sequence. The time between the start of the
are reported in the HITxUPInt and HITxUPFrac regis-         TOF_UP measurement and the start of the TOF_DN mea-
ters, with the calculated average of all the measured hits  surement is set by the TOF_CYC[2:0] bits in the TOF2
being reported in the AVGUPInt and AVGUPFrac register.      register. Upon completion of the TOF_DN measurement,
The t1/t2 and t2/tIDEAL wave ratios are reported in the     the results of AVGUP minus AVGDN is computed and
WVRUP register. Once all these results are stored, then     stored at the TOF_DIFFInt and TOF_DIFFFrac Results
the TOF bit in the Interrupt Status register is set and the register locations. Once these results are stored, then the
INT pin is asserted (if enabled).
www.maximintegrated.com                                                                                 Maxim Integrated │ 35


MAX35104                                                                                    Gas Flow Meter SoC
TOF bit in the Interrupt Status register is set and the INT   EVTMG2 Command (08h)
pin is asserted (if enabled).                                 The EVTMG2 command initiates the event timing mode
Temperature Command (03h)                                     2 advanced automatic measurement feature. This timing
                                                              mode performs automatic TOF_DIFF measurements as
The Temperature command initiates a temperature mea-
                                                              described in the Event Timing Operations section. The
surement sequence as described in the Temperature
                                                              duration of the automatic measurements depends upon
Measurement Operations section. The characteristics the
                                                              the settings in the Event Timing 1 register, CONT_INT
temperature measurement sequence depends upon the
                                                              and ET_CONT bits in the Calibration and Control register.
settings in the Event Timing 1 Register, and Event Timing
2 register. Once all the measurements are completed, the      EVTMG3 Command (09h)
times measured for each port are reported in the corre-       The EVTMG3 command initiates the event timing mode
sponding TxInt and TxFrac Results Registers. The TE bit       3 advanced automatic measurement feature. This timing
in the Interrupt Status register is also set and the INT pin  mode performs automatic Temperature measurements as
is asserted (if enabled).                                     described in the Event Timing Operations section. The
Reset Command (04h)                                           duration of the automatic measurements depends upon
                                                              the settings in the Event Timing 1 register, Event timing 2
The Reset command essentially performs the same func-
                                                              register, CONT_INT and ET_CONT bits in the Calibration
tion as a POR and causes all the Configuration registers to
                                                              and Control register.
be set to their POR values and all the Results registers and
the Interrupt Status register to be cleared and set to zero.  HALT Command (0Ah)
Initialize Command (05h)                                      The HALT command is sent to the device to stop any
                                                              of the three EVTMG1/2/3 commands. All register data
The Initialize command recalls POR values for registers
                                                              content is frozen and the SPI is then made available for
14h–17h.
                                                              access by the host microcontroller for commands, mem-
Bandpass Calibrate Command (06h)                              ory access, and register access. The HALT command
The Bandpass Calibrate command is used to automati-           takes time to execute. Because the EVTMGx commands
cally program the bandpass filter’s center frequent. This     are composed of multiple TOF_DIFF and Temperature
command should be run before any TOF commands are             commands, the HALT command causes the device to
executed (if the bandpass is enabled). To execute this        evaluate its own state and complete the currently execut-
command, first select the desired launch frequency by         ing TOF_DIFF or Temperature command. Once the HALT
setting the DPL[3:0] bits in the TOF1 register. Upon exe-     command has completed, all registers are updated and
cution of this command, the device uses internally gener-     the device sets the Halt bit in the Interrupt Status regis-
ated signals at the set launch frequency to stimulate the     ter and then asserts the INT device pin (if enabled). The
bandpass filter and selects the correct center frequency      host microprocessor reads the Interrupt Status register to
values for the F0 Adjust bits, F0[6:0] in the AFE 2 register. determine the interrupt source.
EVTMG1 Command (07h)                                          Calibrate Command (0Eh)
After issuing the Bandpass Calibrate command, an addi-        The Calibrate command performs the calibration routine
tional 5mA ICC current is active until the CE pin is toggled. as described in the Calibration Operation section. When
Note: The Bandpass Calibrate command is not available         the Calibrate command has completed the measurement,
for 1MHz pulse lauch divider setting, DPL[3:0] = 1.           the Calibration Results register contains the measured
                                                              32kHz period measurement value, the device sets the Cal
The EVTMG1 command initiates the event timing mode            bit in the Interrupt Status register and then asserts the INT
1 advanced automatic measurement feature. This timing         device pin (if enabled). The host microprocessor reads
mode performs automatic TOF_DIFF and Temperature              the Interrupt Status register to determine the interrupt
measurements as described in the Event Timing                 source and then reads the Calibration Results register to
Operations section. The duration of the automatic mea-        calculate the 4MHz ceramic oscillator gain factor.
surements depends upon the settings in the Event Timing
1 Register, Event timing 2 register, CONT_INT and ET_         Register Opcode Commands
CONT bits in the Calibration and Control register.
                                                              To manipulate the register memory, there are two com-
                                                              mands supported by the device: Read register and Write
www.maximintegrated.com                                                                                Maxim Integrated │ 36


MAX35104                                                                                            Gas Flow Meter SoC
register. Each register accessed with these commands is             pin is deasserted as shown in Figure 19. The address
16 bits in length. These commands are used to access                counter is automatically incremented.
all sections of the memory map including the RTC and
Watchdog registers, Configuration registers, Conversion             Write Register Command
Results registers, and Status registers. The Conversion             This command applies to all writable registers. See the
Results registers and the Interrupt Status register of the          Register Memory Map for more detail. Figure 20 shows
Status registers are all read only.                                 the SPI protocol sequence.
                                                                    The Write Register command can also be used to write
Read Register Command
                                                                    consecutive addresses. In this case, the data bits are
The opcode must be clocked into the DIN device pin                  continuously received on the DIN device pin and bound
before the DOUT device pin produces the register data.              for the initial starting address register that is addressed in
Figure 18 shows the SPI protocol sequence.                          the opcode. The address counter is automatically incre-
The Read Register command can also be used to read                  mented after each 16 bits of data and wraps around to the
consecutive addresses. In this case, the data bits are              beginning of the Configuration/Results register memory
continuously delivered in sequence starting with the MSB            map if the SCK device pin is continually clocked and the
of the data register that is addressed in the opcode, and           CE device pin remains asserted as shown in Figure 21.
continues with each SCK rising edge until the CE device
                                                  READ REGISTER COMMAND
            CE
                             0  1    2    3   4  5   6    7   8   9  10             19  20  21  22   23
           SCK
                            O                           O
            DIN
                            MSB        8 BITS          LSB
                                                                           DATA 16 BITS
                                       OPCODE
          DOUT                      HIGH IMPEDANCE           D   D   D   D        D    D   D   D    D     HIGH IMPEDANCE
                                                            MSB                                    LSB
Figure 18. Read Register Opcode Command Protocol
www.maximintegrated.com                                                                                       Maxim Integrated │ 37


MAX35104                                                                                                         Gas Flow Meter SoC
                                                        CONTINUOUS READ REGISTER COMMAND
     CE
                   0   1   2   3    4   5   6    7    8   9   10         19    20 21 22 23 24 25 26 27             39 40 41 42   43
    SCK
                  O                             O
     DIN
                  MSB        8 BITS           LSB
                             OPCODE                                DATA 16 BITS                    DATA 16 BITS
   DOUT                  HIGH IMPEDANCE             D    D    D  D       D    D    D   D  D   D  D   D   D        D    D   D   HIGH IMPEDANCE
                                                   MSB                                   LSB MSB                 LSB
Figure 19. Continuous Read Register Opcode Command Protocol
                                                                WRITE REGISTER COMMAND
             CE
                                0     1   2      3     4    5    6    7     8     9   10            19   20   21    22    23
            SCK
                               O                                    O    D      D    D   D         D   D     D    D      D
             DIN
                               MSB                                 LSB MSB                                             LSB
                                               8 BITS
                                              OPCODE                                      DATA 16 BITS
           DOUT                                                            HIGH IMPEDANCE
Figure 20. Write Register Opcode Command Protocol
www.maximintegrated.com                                                                                                      Maxim Integrated │ 38


MAX35104                                                                                                   Gas Flow Meter SoC
                                              CONTINUOUS WRITE REGISTER COMMAND
    CE
                   0  1   2    3    4 5  6    7   8    9  10            19  20  21  22   23   24   25   26   27   39
   SCK
                  O                         O   D    D   D   D        D    D   D   D    D   D    D    D    D     D   D  D
    DIN
                  MSB                      LSB MSB                                     LSB MSB                  LSB
                             8 BITS
                            OPCODE                            DATA 16 BITS                        DATA 16 BITS
  DOUT                                                          HIGH IMPEDANCE
Figure 21. Continuous Write Register Opcode Command Protocol
Register Memory Map                                                     figuration variables are set to their POR default value. The
Table 6 shows the registers that are accessed by the                    RTC, Results, Interrupt Status, and Control registers are
Read register command and the Write register command.                   all 0000h following a reset.
“X” represents a reserved bit. Following a reset, all con-
www.maximintegrated.com                                                                                               Maxim Integrated │ 39


                            Table 6. Register Memory Map
                             READ     WRITE
                                                     NAME                                   BITS[15:8]                                                                         BITS[7:0]
                            OPCODE   OPCODE
                            RTC AND WATCHDOG REGISTERS                                                                                                                                                                            MAX35104
                              B0h      30h          Seconds           Tenths of Seconds             Hundredth Seconds                           10 Seconds                                          Seconds
                              B1h      31h          Mins_Hrs             10-Minutes                      Minutes                    0         12hr         20hr /AM/PM          10hr                       Hours
www.maximintegrated.com
                              B2h      32h          Day_Date                                   Day                                                   10-Date                                         Date
                                                     Month_
                              B3h      33h                                10-Month                        Month                                      10-Year                                         Year
                                                      Year
                                                    Watchdog
                                                                          Tenths of                   Hundredths of
                              B4h      34h           Alarm                                                                                      10 Seconds                                          Seconds
                                                                          Seconds                        Seconds
                                                    Counter
                              B5h      35h           Alarm               10-Minutes                      Minutes                    0         12hr         20hr /AM /PM         10hr                 Alarm Hours
                            CONFIGURATION REGISTERS
                                             Switcher   SFREQ          SFREQ     HREG_
                              94h    14h                                                      0          X          X        X          X      DFREQ1 DREEQ0              1         1       VS3       VS2          VS1    VS0
                                                1             1           0           D
                                             Switcher
                              95h    15h                LT_N3           LT_N2     LT_N1     LT_N0     LT_S3        LT_S2   LT_S1    LT_S0        ST3           ST2     ST1        ST0      LT_50D      0            0    PECHO
                                                2
                                                         AFE_
                              96h    16h      AFE1                        0            0      0           0       SD_EN AFEOU1 AFEOUT0               0                          WRITE BACK VALUES READ
                                                             BP
                                                         4M_
                              97h    17h      AFE2                       F06          F05    F04         F03        F02     F01         F00     PGA3           PGA2   PGA1       PGA0      LOWQ1    LOWQ0           0    BP_BP
                                                             BP
                             B6h     36h                                                                                                 Reserved
                             B7h     37h                                                                                                 Reserved
                                                                                                                                                                                           STOP_
                             B8h     38h      TOF1           PL7         PL6          PL5    PL4         PL3       PL2      PL1         PL0     DPL3           DPL2   DPL1        DPL0                 X           X       X
                                                                                                                                                                                            POL
                                                                                                                                                               TOF_   TOF_        TOF_      EN_     TIMOUT TIMOUT TIMOUT
                             B9h     39h      TOF2      STOP2          STOP1     STOP0      T2WV5     T2WV4       T2WV3    T2WV2    T2WV1       T2WV0
                                                                                                                                                               CYC2   CYC1       CYC0      UP_DN       2            1      0
                                                                                 Hit1WV     Hit1WV    Hit1WV      Hit1WV   Hit1WV   Hit1WV                            Hit2WV     Hit2WV    Hit2WV   Hit2WV     Hit2WV    Hit2WV
                             BAh     3Ah      TOF3           X            X                                                                          X          X
                                                                                       5      4           3          2       1           0                                5         4        3         2            1      0
                                                                                 Hit3WV     Hit3WV    Hit3WV      Hit3WV   Hit3WV   Hit3WV                            Hit4WV     Hit4WV    Hit4WV   Hit4WV     Hit4WV    Hit4WV
                             BBh     3Bh      TOF4           X            X                                                                          X          X
                                                                                       5      4           3          2       1           0                                5         4        3         2            1      0
                                                                                 Hit5WV     Hit5WV    Hit5WV      Hit5WV   Hit5WV   Hit5WV                            Hit6WV     Hit6WV    Hit6WV   Hit6WV     Hit6WV    Hit6WV
                             BCh     3Ch      TOF5           X            X                                                                          X          X
                                                                                       5      4           3          2       1           0                                5         4        3         2            1      0
                                                        C_OFF          C_OFF     C_OFF      C_OFF     C_OFF       C_OFF    C_OFF    C_OFF
                                                                                                                                                C_OFF      C_OFF      C_OFF      C_OFF     C_OFF    C_OFF      C_OFF     C_OFF
                             BDh     3Dh      TOF6      SETRU          SETRU     SETRU      SETRU     SETRU       SETRU    SETRU    SETRU
                                                                                                                                               SETUP7 SETUP6 SETUP5 SETUP4 SETUP3 SETUP2 SETUP1 SETUP0
    Maxim Integrated │ 40                               P         7       P6          P5     P4          P3         P2      P1          P0
                                                                                                                                                                                                                                  Gas Flow Meter SoC


                            Table 6. Register Memory Map (continued)
                             READ     WRITE
                                                     NAME                       BITS[15:8]                                                         BITS<7:0>
                            OPCODE   OPCODE
                                                        C_OF    C_OFF   C_OFF   C_OFF    C_OFF    C_OFF   C_OFF   C_OFF    C_OFF    C_OFF   C_OFF    C_OFF     C_OFF     C_OFF     C_OFF
                                                                                                                                                                                             C_OFF
                             BEh     3Eh     TOF7       FSET    SETRD   SETRD   SETRD    SETRD    SETRD   SETRD   SETRD    SETDN    SETDN   SETDN    SETDN     SETDN     SETDN     SETDN
                                                                                                                                                                                                       MAX35104
                                                                                                                                                                                             SETDN0
                                                        RDN7     N6      N5      N4          N3    N2      N1      N0           7     6       5         4        3         2         1
                                             Event
www.maximintegrated.com
                             BFh     3Fh                TDF3    TDF2    TDF1    TDF0     TDM4     TDM3    TDM2    TDM1     TDM0     TMF5    TMF4      TMF3     TMF2      TMF1      TMF0        X
                                            Timing 1
                                             Event      TMM                                       Cal_    Cal_    Cal_      Cal_                     PRECY     PRECY     PRECY     PORTC     PORTC
                             C0h     40h                        TMM3    TMM2    TMM1     TMM0                                         X       X
                                            Timing 2        4                                      Use    AUTO    CFG1     CFG0                        C2        C1        C0       YC1       YC0
                                              TOF
                                            Measure
                             C1h     41h                DLY15   DLY14   LY13    DLY12    DLY11    DLY10   DLY9    DLY8     DLY7     DLY6    DLY5      DLY4      DLY3      DLY2      DLY1      DLY0
                                             ment
                                             Delay
                                            Calibrati
                                                                                         CMP_     CMP_    INT_     ET_     CONT_    CLK_    CLK_      CLK_      Cal_      Cal_      Cal_      Cal_
                             C2h     42h    on and          X     X       X       X
                                                                                             EN    SEL     EN     CONT      INT      S2      S1        S0      Period3   Period2   Period1   Period0
                                            Control
                                              Real
                             C3h     43h     Time           X     X       X       X          X      X       X       X           X   32K_BP 32K_EN    EOSC       AM2       AM1       WF       WD_EN
                                             Clock
                            CONVERSION RESULTS REGISTERS
                                     Read
                             C4h                                                                                        WVRUP
                                     Only
                                     Read
                             C5h                                                                                    Hit1UpInt
                                     Only
                                     Read
                             C6h                                                                                    Hit1UpFrac
                                     Only
                                     Read
                             C7h                                                                                    Hit2UpInt
                                     Only
                                     Read
                             C8h                                                                                    Hit2UpFrac
                                     Only
                                     Read
                             C9h                                                                                    Hit3UpInt
                                     Only
                                     Read
                             CAh                                                                                    Hit3UpFrac
                                     Only
                                     Read
                             CBh                                                                                    Hit4UpInt
                                     Only
    Maxim Integrated │ 41
                                                                                                                                                                                                       Gas Flow Meter SoC


                            Table 6. Register Memory Map (continued)
                             READ     WRITE
                                              NAME           BITS[15:8]                BITS[7:0]
                            OPCODE   OPCODE
                                     Read
                             CCh                                          Hit4UpFrac
                                     Only
                                                                                                   MAX35104
                                     Read
                             CDh                                           Hit5UpInt
                                     Only
www.maximintegrated.com
                                     Read
                             CEh                                          Hit5UpFrac
                                     Only
                                     Read
                             CFh                                           Hit6UpInt
                                     Only
                                     Read
                             D0h                                          Hit6UpFrac
                                     Only
                                     Read
                             D1h                                          AVGUPInt
                                     Only
                                     Read
                             D2h                                          AVGUPFrac
                                     Only
                                     Read
                             D3h                                           WVRDN
                                     Only
                                     Read
                             D4h                                           Hit1DnInt
                                     Only
                                     Read
                             D5h                                          Hit1DnFrac
                                     Only
                                     Read
                             D6h                                           Hit2DnInt
                                     Only
                                     Read
                             D7h                                          Hit2DnFrac
                                     Only
                                     Read
                             D8h                                           Hit3DnInt
                                     Only
                                     Read
                             D9h                                          Hit3DnFrac
                                     Only
                                     Read
                             DAh                                           Hit4DnInt
                                     Only
                                     Read
                             DBh                                          Hit4DnFrac
                                     Only
                                     Read
                             DCh                                           Hit5DnInt
                                     Only
    Maxim Integrated │ 42
                                                                                                   Gas Flow Meter SoC


                            Table 6. Register Memory Map (continued)
                             READ     WRITE
                                              NAME           BITS[15:8]                      BITS[7:0]
                            OPCODE   OPCODE
                                     Read
                             DDh                                             Hit5DnFrac
                                     Only
                                                                                                         MAX35104
                                     Read
                             DEh                                              Hit6DnInt
                                     Only
www.maximintegrated.com
                                     Read
                             DFh                                             Hit6DnFrac
                                     Only
                                     Read
                             E0h                                              AVGDNInt
                                     Only
                                     Read
                             E1h                                             AVGDNFrac
                                     Only
                                     Read
                             E2h                                            TOF_DIFFInt
                                     Only
                                     Read
                             E3h                                            TOF_DIFFFrac
                                     Only
                                     Read
                             E4h                                          TOF_Cycle_Count
                                     Only
                                     Read
                             E5h                                          TOF_DIFF_AVGInt
                                     Only
                                     Read
                             E6h                                          TOF_DIFF_AVGFrac
                                     Only
                                     Read
                             E7h                                                T1Int
                                     Only
                                     Read
                             E8h                                               T1Frac
                                     Only
                                     Read
                             E9h                                                T2Int
                                     Only
                                     Read
                             EAh                                               T2Frac
                                     Only
                                     Read
                             EFh                                          Temp_Cycle_Count
                                     Only
                                     Read
                             F0h                                             T1_AVGInt
                                     Only
                                     Read
                             F1h                                             T1_AVGFrac
                                     Only
    Maxim Integrated │ 43
                                                                                                         Gas Flow Meter SoC


                            Table 6. Register Memory Map (continued)
                             READ     WRITE
                                                   NAME                BITS[15:8]                                                      BITS[7:0]
                            OPCODE   OPCODE
                                     Read
                             F2h                                                                          T2_AVGInt
                                     Only
                                                                                                                                                                        MAX35104
                                     Read
                             F3h                                                                         T2_AVGFrac
                                     Only
www.maximintegrated.com
                                     Read
                             F8h                                                                        CalibrationInt
                                     Only
                                     Read
                             F9h                                                                        CalibrationFrac
                                     Only
                                     Read
                             FAh                                                                          Reserved
                                     Only
                                     Read
                             FBh                                                                          Reserved
                                     Only
                                     Read
                             FCh                                                                          Reserved
                                     Only
                                     Read
                             FDh                                                                          Reserved
                                     Only
                                                                                          STATUS REGISTERS
                                     Read   Interrupt                                          TOF_    Temp_
                             FEh                        TO    AF   X    TOF         TE   LDO                       X      Cal   Halt      CSWI     INIT   POR   X   X
                                     Only    Status                                            EVTMG   EVTMG
                             FFh     7Fh    Control       X   X    X     X          X     X     AFA    CSWA        X      X      X          X       X      X    X   X
    Maxim Integrated │ 44
                                                                                                                                                                        Gas Flow Meter SoC


MAX35104                                                                               Gas Flow Meter SoC
RTC and Watchdog Register Descriptions
Table 7. RTC Seconds Register
                                                    RTC SECONDS REGISTER
         WRITE OPCODE                READ OPCODE                            POR DEFAULT VALUE
              30h                            B0h                                   0000h
 Bit            15            14              13               12      11         10             9               8
 Name                          Tenths of Seconds                                Hundredths of Seconds
 Bit             7             6               5                4      3           2             1               0
 Name            0                       10 Seconds                                   Seconds
    BIT               NAME                                              DESCRIPTION
  15:12         Tenths of Seconds        Range 0 to 9
   11:8      Hundredths of Seconds       Range 0 to 9
      7                  0               This bit always returns 0
     6:4            10 Second            Range 0 to 5
     3:0             Seconds             Range 0 to 9
Table 8. RTC Mins_Hrs Register
                                                    RTC MINS_HRS REGISTER
         WRITE OPCODE                 READ OPCODE                           POR DEFAULT VALUE
              31h                            B1h                                   0000h
 Bit            15           14               13               12      11         10             9               8
 Name            0                        10 Minutes                                   Minutes
 Bit             7            6                5                4       3          2             1               0
 Name            0          12/24       20HR/AM/PM           10HR                       Hours
    BIT            NAME                                              DESCRIPTION
     15              0           This bit always returns 0
  14:12         10 Minutes       Range 0 to 5
   11:8           Minutes        Range 0 to 9
      7              0           This bit always returns 0
                                 1 = 12-Hour Mode
      6            12/24         0 = 24-Hour Mode
                                 This bit is write only
                                 In 12-Hour Mode
                                   1 = PM
      5        20HR/AM/PM
                                   0 = AM
                                 In 24-Hour Mode: 20 Hour Digit
      4            10HR
     3:0           Hours         Range 0 to 9
www.maximintegrated.com                                                                            Maxim Integrated │ 45


MAX35104                                                                             Gas Flow Meter SoC
Table 9. RTC Day_Date Register
                                                 RTC DAY_DATE REGISTER
         WRITE OPCODE               READ OPCODE                            POR DEFAULT VALUE
               32h                         B2h                                   0000h
 Bit             15         14              13             12        11          10          9               8
 Name             0          0               0              0         0                    Day
 Bit              7          6               5              4         3           2          1               0
 Name             0          0                    10 Date                             Date
    BIT        NAME                                              DESCRIPTION
  15:11           0     These bits always return 0
   10:8         Day     Range 0 to 7
     7:6          0     These bits always return 0
     5:4      10 Date   Range 0 to 3
     3:0        Date    Range 0 to 9
Table 10. RTC Month_Year Register
                                               RTC MONTH_YEAR REGISTER
         WRITE OPCODE               READ OPCODE                            POR DEFAULT VALUE
               33h                         B3h                                   0000h
 Bit             15         14              13             12        11          10          9               8
 Name             0          0               0          10 Month                     Month
 Bit              7          6               5              4         3           2          1               0
 Name                              10 Year                                            Year
    BIT        NAME                                              DESCRIPTION
  15:13           0     These bits always return 0.
     12      10 Month   Range 0 to 1
   11:8        Month    Range 0 to 9
     7:4      10 Year   Range 0 to 9
     3:0        Year    Range 0 to 9
www.maximintegrated.com                                                                        Maxim Integrated │ 46


MAX35104                                                                                    Gas Flow Meter SoC
Table 11. Watchdog Alarm Counter Register
                                           WATCHDOG ALARM COUNTER REGISTER
         WRITE OPCODE                 READ OPCODE                               POR DEFAULT VALUE
              34h                             B4h                                      0000h
 Bit            15            14                13                12      11          10               9               8
 Name                           Tenths of Seconds                                    Hundredths of Seconds
 Bit             7             6                 5                 4       3           2               1               0
 Name                              10 Seconds                                              Seconds
    BIT               NAME                                                  DESCRIPTION
  15:12        Tenths of Seconds          Range 0 to 9
   11:8      Hundredths of Seconds        Range 0 to 9
     7:4            10 Second             Range 0 to 9
     3:0             Seconds              Range 0 to 9
Table 12. Alarm Register
                                                           ALARM REGISTER
         WRITE OPCODE                 READ OPCODE                               POR DEFAULT VALUE
              35h                             B5h                                      0000h
 Bit            15            14                 13                12     11          10               9               8
 Name           X                          10 Minutes                                      Minutes
 Bit             7             6                  5                 4     3            2               1               0
 Name           X            12/24        20HR/AM/PM             10HR                       Hours
    BIT               NAME                                                  DESCRIPTION
     15                 X                 Reserved
  14:12             10 Minutes            Range 0 to 5
   11:8              Minutes              Range 0 to 9
      7                 X                 Reserved
                                          1 = 12-Hour Mode
      6               12/24               0 = 24-Hour Mode
                                          This bit is write only
                                          In 12-Hour Mode
                                            1 = PM
      5            20HR/AM/PM
                                            0 = AM
                                          In 24-Hour Mode: 20 Hour Digit
      4               10HR
     3:0              Hours               Range 0 to 9
www.maximintegrated.com                                                                                  Maxim Integrated │ 47


MAX35104                                                                                         Gas Flow Meter SoC
Configuration Register Descriptions
Table 13. Switcher 1 Register
                                                 SWITCHER 1 REGISTER
       WRITE OPCODE            READ OPCODE                                             POR VALUE
            14h                       94h                                                  0030h
 Bit               15          14             13              12            11                10              9              8
 Name           SFREQ1     SFREQ0          HREG_D              0             X                X               X              X
 Bit                7           6              5               4             3                 2              1              0
 Name           DFREQ1     DFREQ0              1               1           VS3              VS2              VS1           VS0
      BIT        NAME                                                 DESCRIPTION
                         Switcher Control Frequency: These 2 bits are used to control the switching frequency of the switcher
                         boost circuit.
                                     SFREQ1                          SFREQ0                    SWITCHING FREQUENCY (kHz)
                 SFREQ
     15:14                              0                               0                                     100
                  [1:0]
                                        0                               1                                     125
                                        1                               0                                     166
                                        1                               1                                     200
                         High Voltage Regulator Disable: This bit powers down the high voltage regulator in the case where it
                         is not desired and the switcher voltage is deem sufficient to drive the piezos. In such a case, the VPR
       13       HREG_D
                         and VP pins must be externally shorted together.
                         When set to 0 the high voltage regulator is enabled. When set to 1 it is disabled.
                         Zero: This bit must always be written to 0b when accessing this register.
       12           0
                         WARNING: Writing this bit to a non-zero value causes undesired device operation.
      11:8          X    Reserved
                         Doubler Control Frequency: These 2 bits are used to control the switching frequency of the doubler
                         circuit.
                                      DREQ1                           DREQ0                     SWITCHING FREQUENCY (kHz)
       7:6     DREQ[1:0]                 0                               0                                     100
                                         0                               1                                     125
                                         1                               0                                     166
                                         1                               1                                     200
www.maximintegrated.com                                                                                      Maxim Integrated │ 48


MAX35104                                                                                       Gas Flow Meter SoC
Table 13. Switcher 1 Register (continued)
                                      One: These bits must always be written to 11b when accessing this register.
    5:4            11
                                  WARNING: Writing these bits to a non-one value causes undesired device operation.
    BIT          NAME                                                DESCRIPTION
                         Voltage Select: This is a hex value that controls the switcher and high voltage regulator output target
                         voltage:
                                                                                   DESCRIPTION
                                 VS0[3:0]            REGULATOR              SWITCHER            MAX FET DUTY CYCLE (%)
                                                      TARGET (V)           TARGET (V)          LT_50D = 0b        LT_50D = 1b
                                  0000b                     5.4                  9                  50                 50
                                  0001b                     5.4                  9                  50                 50
                                  0010b                     5.4                  9                  50                 50
                                  0011b                     5.4                  9                  50                 50
                                  0100b                     5.4                  9                  50                 60
    3:0          VS[3:0]          0101b                     7.2                10.8                 50                 63
                                  0110b                      9                 12.6                 50                 65
                                  0111b                    11.4                 15                  50                 68
                                  1000b                    13.2                16.8                 50                 70
                                  1001b                    15.6                19.2                 50                 73
                                  1010b                    17.4                 21                  50                 73
                                  1011b                    19.2                22.8                 50                 78
                                  1100b                    21.6                25.2                 50                 80
                                  1101b                    23.4                 27                  50                 83
                                  1110b                    25.2                28.8                 50                 85
                                  1111b                     27                 30.6                 50                 90
www.maximintegrated.com                                                                                    Maxim Integrated │ 49


MAX35104                                                                                        Gas Flow Meter SoC
Table 14. Switcher 2 Register
                                                 SWITCHER 2 REGISTER
        WRITE OPCODE              READ OPCODE                                          POR VALUE
             15h                         95h                                               44E0h
 Bit                15         14             13              12             11             10             9               8
 Name             LT_N3     LT_N2           LT_N1          LT_N0           LT_S3          LT_S2          LT_S1          LT_S0
 Bit                 7          6              5               4              3              2             1               0
 Name              ST3       ST2             ST1             ST0          LD_50D             0             0           PECHO
      BIT         NAME                                                DESCRIPTION
                          Limit trim Normal Operation: After the output voltage crosses the undervoltage good threshold,
                          which is the programmed voltage select output, the switcher runs in normal duty mode. Four bits
                          control the max inductor current in normal duty mode. The bits must be set in the one-hot pattern
                          shown below.
     15:12      LT_N[3:0]                                        0000b = Loop conditions determine max
                                                                 0001b = 0.2V/RSENSE = MAX CURRENT
                          LT_N[3:0]                              0010b = 0.4V/RSENSE = MAX CURRENT
                                                                 0100b = 0.8V/RSENSE = MAX CURRENT
                                                                 1000b = 1.6V/RSENSE = MAX CURRENT
                          Limit trim Startup: During power up, a soft-start must be initiated as the inductor can saturate from
                          a maxed out duty cycle arising from the large error between target and the output voltage. Four bits
                          control the max inductor current. The bits must be set in the one-hot pattern shown below.
      11:8      LT_S[3:0]                                        0000b = No limit
                                                                 0001b = 0.2V/RSENSE = MAX CURRENT
                          LT_S[3:0]                              0010b = 0.4V/RSENSE = MAX CURRENT
                                                                 0100b = 0.8V/RSENSE = MAX CURRENT
                                                                 1000b = 1.6V/RSENSE = MAX CURRENT
www.maximintegrated.com                                                                                     Maxim Integrated │ 50


MAX35104                                                                                        Gas Flow Meter SoC
Table 14. Switcher 2 Register (continued)
    BIT           NAME                                                 DESCRIPTION
                         Switcher Stabilization Time: This is a hex number that selects the time allotted for the stabilization
                         of the output voltage of the switcher. This count begins once the under voltage comparator
                         determines the target output voltage is within the defined specifications. After the stabilization time
                         expires the launch pulses are then transmitted.
                         The time is based upon the 32.768 KHz crystal.
                                       ST[3:0]                                       STABILIZATION TIME
                                        0000b                                                  64µs
                                        0001b                                                128µs
                                        0010b                                                192µs
                                        0011b                                                256µs
                                        0100b                                                320µs
    7:4          ST[3:0]                0101b                                                384µs
                                        0110b                                                473µs
                                        0111b                                                512µs
                                        1000b                                                768µs
                                        1001b                                               1.02ms
                                        1010b                                               1.25ms
                                        1011b                                               1.50ms
                                        1100b                                               2.05ms
                                        1101b                                               4.10ms
                                        1110b                                               8.19ms
                                        1111b                                               16.4ms
                         LIMIT TRIM 50% Disable: This bit disables the 50% MAX duty cycle applied to the switcher FET.
                         When set to 0 the switcher FET’s applied MAX duty cycle will never exceed a 50%
     3           LT_50D
                         When set to a 1 the switcher FET’s applied MAX duty cycle will dependent upon the settings in the
                         Launch Voltage Select, VS[3:0], bit field in the Switcher 1 Register.
                         Zero: These bits must always be written to 00b when accessing this register.
    2:1             0
                         WARNING: Writing these bits to a non-zero value will cause undesired device operation
                         Pulse Echo enable: This bit enables the pulse echo mode of the device. In pulse echo mode the
                         launch transducer is also the receive transducer.
     0           PECHO
                         When set to 1 the device operates in pulse echo mode.
                         When set to 0 the device operates in normal time of flight mode.
www.maximintegrated.com                                                                                      Maxim Integrated │ 51


MAX35104                                                                                         Gas Flow Meter SoC
Table 15. AFE 1 Register
                                                       AFE 1 REGISTER
         WRITE OPCODE              READ OPCODE                                           POR VALUE
              16h                           96h                                             04Xxh
 Bit                15          14                13            12               11           10               9              8
 Name            AFE_BP          0                 0             0               0         SD_EN          AFEOUT1        AFEOUT0
 Bit                 7           6                 5             4               3             2               1              0
 Name                0                                            WRITE BACK READ VALUES
      BIT         NAME                                                     DESCRIPTION
                           Analog Front-End Bypass: This bit is used to remove the entire analog front-end signal chain,
                           including both gain stages and the bandpass filter, from the return signal-chain path.
      15         AFE_BP    When set to 1, externally connecting the RXN/RXP pins to the CIN/CIP pins is required.
                           When set to 0 the return signals are routed to the first gain stage of the analog front-end.
                           Zero: These bits must always be written to 0000b when accessing this register.
     14:11           0
                           WARNING: Writing these bits to a non-zero value will cause undesired device operation
                           Single Ended Drive Enable: This bit enables the transmitted square wave to be driven in a single
      10          SD_EN
                           ended manner. When set to 0, the transmitted square wave will be driven differentially.
                           Analog Front End Output: These bits enable the AFE signals to be output on the CIP/CIN pins
                           according to the following stage output
                                   AFEOUT1                         AFEOUT0                            DESCRIPTION
      9:8      AFEOUT[1:0]               0                               0             CIP/CIN output disabled
                                         0                               1             Route bandpass filter out
                                         1                               0             Route programmable gain amplifier out
                                         1                               1             Route fixed gain amplifier out
                           Zero: This bit must always be written to 0b when accessing this register.
       7             0
                           WARNING: Writing this b it to a non-zero value will cause undesired device operation
                           Write Back: This bit field must be written back to the initial value that is read from the device after a
                           POR, before it is modified. When writing this register a POR read must occur first and the value of
                           these 7 bits must be stored in the host microcontroller. Any future writes to this register must write this
      6:0           WB
                           7-bit bit-field to the value that was initially read.
                           WARNING :Writing these bits to a value that does not match the initial POR read value will cause
                           undesired device operation
www.maximintegrated.com                                                                                         Maxim Integrated │ 52


MAX35104                                                                                       Gas Flow Meter SoC
Table 16. AFE 2 Register
                                                   AFE 2 REGISTER
     WRITE OPCODE             READ OPCODE                                             POR VALUE
           17h                       97h                                                  0000h
 Bit                15        14             13             12              11              10           9               8
 Name            4M_BP       F06            F05            F04             F03             F02         F01             F00
 Bit                 7         6              5              4              3                2           1               0
 Name             PGA3      PGA2           PGA1           PGA0           LOWQ1           LOWQ0           0            BP_BP
     BIT          NAME                                               DESCRIPTION
                         4MHz Bypass: This bit, when set, allows an external CMOS-level 4.0 MHz signal to be applied to the
      15         4M_BP   4MX1 device pin. The internal 4MHz oscillator is bypassed and the external signal is driven into the
                         device’s core.
                         F0 Adjust: This is a hex value that adjusts the center frequency of the bandpass filter.
     14:8        F0[6:0] Use the Bandpass Calibrate Command (06h) and the device will automatically select
                         the best center frequency based upon the selected launch frequency. These bits will
                         be set automatically by the device.
                         Gain Select: This is a hex value that selects the gain for the programmable gain amplifier:
                                                                                        AMPLIFIER GAIN
                                      PGA[3:0]
                                                                               dB                              V/V
                                        0000b                                  10                              3.16
                                        0001b                                11.33                             3.69
                                        0010b                                12.66                             4.30
                                        0011b                                13.99                             5.01
                                        0100b                                15.32                             5.83
                                        0101b                                16.65                             6.80
      7:4       PGA[3:0]                0110b                                17.98                             7.93
                                        0111b                                19.31                             9.24
                                        1000b                                20.64                            10.76
                                        1001b                                21.97                            12.55
                                        1010b                                23.30                            14.62
                                        1011b                                24.63                            17.04
                                        1100b                                25.96                            19.86
                                        1101b                                27.29                            23.15
                                        1110b                                28.62                            26.98
                                        1111b                                29.95                            31.44
www.maximintegrated.com                                                                                  Maxim Integrated │ 53


MAX35104                                                                                       Gas Flow Meter SoC
Table 16. AFE 2 Register (continued)
     BIT          NAME                                                DESCRIPTION
                         BPF Q Select: These 2 bits are used to lower the Q factor of the filter
                                        LOWQ1                                LOWQ2                     FILTER Q (Hz/Hz)
                                           0                                    0                              12
     3:2       LOWQ[1:0]
                                           0                                    1                              7.4
                                           1                                    0                              5.3
                                           1                                    1                              4.2
                         Zero: This bit must always be written to 0b when accessing this register.
      1             0
                         WARNING :Writing this bit to a non-zero value will cause undesired device operation
                         Bandpass Filter Bypass: This bit is used to remove the tunable bandpass filter from the return
                         signal-chain path. When the bandpass filter is bypassed, the return signals present at the input of the
      0          BP_BP
                         tunable bandpass filter are routed directly to programmable offset comparator.
                         When set to 0 the BPF is used to condition the return signal. When set to 1 the BPF is bypassed.
Table 17. TOF1 Register
                                                    TOF1 REGISTER
       WRITE OPCODE              READ OPCODE                                     POR DEFAULT VALUE
             38h                        B8h                                              0000h
 Bit                15        14             13              12              11           10             9               8
 Name              PL7       PL6             PL5            PL4             PL3          PL2            PL1             PL0
 Bit                 7         6              5               4              3             2             1               0
 Name             DPL3      DPL2            DPL1           DPL0         STOP_POL          X              X               X
www.maximintegrated.com                                                                                   Maxim Integrated │ 54


MAX35104                                                                                         Gas Flow Meter SoC
Table 17. TOF1 Register (continued)
    BIT              NAME                                               DESCRIPTION
                             Pulse Launcher Size: This is a hex value that defines the number of pulses that are launched
                             from the pulse launcher during transmission. The range of this hex value is 00h–FFh. When
    15:8             PL[7:0]
                             PL[7:0] is set to 00h, the Pulse Launcher is disabled. Up to 127 pulses can be launched. When
                             PL7 is set, the pulse count is clamped at 127.
                             Pulse Launch Divider: This is a hex value that defines the divider ratio of the internal clock
                             signal used to drive the Pulse Launch signal. The 4 MHz external reference oscillator is used
                             as the source for the internal clock reference. The internal reference clock is first divided by
                             2 to produce a 2MHz clock. The range of this hex value is 1h to Fh, resulting in a range of
                             division from ÷2 to ÷16 of the 2 MHz clock. A value of 0h is not supported and should not be
                             programmed.
                             Pulse Launch Frequency = 2MHz / (1+DPL[3:0])
     7:4            DPL[3:0]
                                                 DPL[3:0]                                  PULSE LAUNCH FREQUENCY
                                                   0000b                                             RESERVED
                                                   0001b                                               1MHz
                                                   0002b                                              666kHz
                                                    ...                                                 ...
                                                   1110b                                             133.33kHz
                                                   1111b                                              125kHz
                             Stop Polarity: This bit defines the edge sensitivity of the internal programmable stop
                             comparator. The comparator generates a stop condition for the internal TDC time count on
      3           STOP_POL   the rising slope of the received signal if this bit is set to 0. The comparator generates a stop
                             condition for the internal TDC time count on the falling slope of the received signal if this bit is
                             set to 1.
     2:0               X     Reserved
www.maximintegrated.com                                                                                      Maxim Integrated │ 55


MAX35104                                                                                       Gas Flow Meter SoC
Table 18. TOF2 Register
                                                      TOF2 REGISTER
       WRITE OPCODE              READ OPCODE                                      POR DEFAULT VALUE
             39h                        B9h                                               0000h
 Bit            15           14                13             12              11           10            9             8
 Name        STOP2         STOP1            STOP0          T2WV5            T2WV4        T2WV3        T2WV2         T2WV1
 Bit             7            6                 5              4               3            2            1             0
 Name        T2WV0       TOF_CYC2        TOF_CYC1         TOF_CYC0             X        TIMOUT2     TIMOUT1        TIMOUT0
    BIT       NAME                                                  DESCRIPTION
                        Stop Hits: These bits set the number of stop hits to be expected and measured.
                                    STOP2                        STOP1                    STOP0            DESCRIPTION
                                      0                             0                        0                   1 Hit
                                      0                             0                        1                  2 Hits
                                      0                             1                        0                  3 Hits
  15:13     STOP[2:0]
                                      0                             1                        1                  4 Hits
                                      1                             0                        0                  5 Hits
                                      1                             0                        1                  6 Hits
                                      1                             1                        0                  6 Hits
                                      1                             1                        1                  6 Hits
                        Wave Selector for t2:These bits determine the wave number for which t2 is measured. To ensure
                        measurement accuracy, the first wave measurable after the Early Edge Detect is Wave 2. Waves are
                        numbered as depicted in Figure 5B.
                                        T2WV[5:0] (decimal)                                     DESCRIPTION
   12:7     T2WV[5:0]
                                              0 through 2                                           Wave 2
                                                    3                                               Wave 3
                                                    4                                               Wave 4
                                             5 through 63                                      Wave 5 through 63
www.maximintegrated.com                                                                                  Maxim Integrated │ 56


MAX35104                                                                                            Gas Flow Meter SoC
Table 18. TOF2 Register (continued)
   BIT        NAME                                                         DESCRIPTION
                        TOF Duty Cycle: These bits determine the time delay between successive executions of TOF
                        measurements. It is the Start-to-Start time of automatic execution of the TOF_UP and the TOF_DN and
                        is applicable only for the TOF_DIFF command. It is based upon the 32.768kHz crystal. If the actual TOF
                        of the acoustic path exceeds the programmed Start-to-Start time in this setting, then the TOF Duty Cycle
                        performs as if the bit setting is 000b.
                                                                                         DESCRIPTION
                                TOF_CYC[2:0]                     32kHz CLOCK           TYPICAL        4MHz ON BETWEEN TOF_UP
                                                              CYCLES(decimal)             TIME                AND TOF_DOWN
            TOF_CYC
   6:4                               000b                                0                 0µs                        Yes
               [2:0]
                                     001b                                4               122µs                        Yes
                                     010b                                8               244µs                        Yes
                                      011b                              16               488µs                        Yes
                                     100b                               24               732µs                        Yes
                                     101b                               32               976µs                        Yes
                                      110b                             546              16.65ms                        No
                                      111b                             655              19.97ms                        No
    3            X      Reserved
                        Timeout: These bits force a timeout in the Time-To-Digital measurement block. If the hit required
                        to measure t1, t2, or Hit1 thru Hit6 of the received signal does not occur in this time, the TO bit in the
                        Interrupt Status register is set and the INT pin is asserted (if enabled). Additionally, any of the Conversion
                        Results registers read FFFFh if the data for that register is invalid. In addition, if resultant temperature
                        readings exceed the timeout value set by these bits, then the device writes a value of FFFFh to the
                        corresponding T1, T2, T3, T4 Results register to indicate an open circuit temperature probe.
                                TIMOUT2                       TIMOUT1                    TIMOUT0                    DESCRIPTION
             TIMOUT
   2:0                               0                             0                          0                           128µs
               [2:0]
                                     0                             0                          1                           256µs
                                     0                             1                          0                           512µs
                                     0                             1                          1                          1024µs
                                     1                             0                          0                          2048µs
                                     1                             0                          1                          4096µs
                                     1                             1                          0                          8192µs
                                     1                             1                          1                         16384µs
www.maximintegrated.com                                                                                            Maxim Integrated │ 57


MAX35104                                                                                        Gas Flow Meter SoC
Table 19. TOF3 Register
                                                     TOF3 REGISTER
         WRITE OPCODE            READ OPCODE                                      POR DEFAULT VALUE
              3Ah                       BAh                                               0000h
 Bit                15        14              13              12             11             10              9             8
 Name               X         X            Hit1WV5         Hit1WV4       Hit1WV3        Hit1WV2         Hit1WV1       Hit1WV0
 Bit                 7         6               5               4             3               2              1             0
 Name               X         X            Hit2WV5         Hit2WV4       Hit2WV3        Hit2WV2         Hit2WV1       Hit2WV0
      BIT            NAME                                               DESCRIPTION
     15:14             X        Reserved
                                Hit1 Wave Select: These bits select the wave number for which the Hit1 stop time is
                                measured. Wave Numbers are depicted in Figure 5B. The Hit1 Wave Select value must be
                                at least 1 greater than the Wave Selected for t2, which is configured in the TOF2 register.
                                For example, if the Wave Selector for t2 is set to wave number 7, then the Hit1 Wave Select
                                must be set to deselect wave number 8 or greater. The earliest wave for which Hit1 can be
                                measured is Wave 3.
      13:8        HIT1WV[5:0]
                                            HIT1WV[5:0] (decimal)                                 DESCRIPTION
                                                      0 to 3                                          Wave 3
                                                        4                                             Wave 4
                                                        5                                             Wave 5
                                                     6 to 63                                       Wave 6 to 63
       7:6             X        Reserved
                                Hit2 Wave Select: These bits select the wave number for which the Hit2 stop time is
                                measured. Wave numbers are depicted in Figure 5B. The Hit2 Wave Select value must be at
                                least 1 greater than the Hit1 Wave Select value. For example, if Hit1 Wave Select value is set
                                to measure wave number 9, then the Hit2 Wave Select must be set to detect wave number 10
                                or greater. The earliest wave for which Hit2 can be measured is Wave 4.
       5:0        HIT2WV[5:0]               HIT2WV[5:0] (decimal)                                 DESCRIPTION
                                                      0 to 4                                          Wave 4
                                                        5                                             Wave 5
                                                        6                                             Wave 6
                                                     7 to 63                                       Wave 7 to 63
www.maximintegrated.com                                                                                     Maxim Integrated │ 58


MAX35104                                                                                    Gas Flow Meter SoC
Table 20. TOF4 Register
                                                     TOF4 REGISTER
      WRITE OPCODE            READ OPCODE                                     POR DEFAULT VALUE
           3Bh                      BBh                                                0000h
 Bit                15        14             13            12              11            10              9              8
 Name                X        X           Hit3WV5       Hit3WV4       Hit3WV3         Hit3WV2       Hit3WV1         Hit3WV0
 Bit                 7         6              5             4              3              2              1              0
 Name                X        X           Hit4WV5       Hit4WV4       Hit4WV3         Hit4WV2       Hit4WV1         Hit4WV0
      BIT         NAME                                             DESCRIPTION
     15:14           X   Reserved
                         Hit3 Wave Select: These bits select the wave number for which the Hit3 stop time is measured.
                         Wave numbers are depicted in Figure 5B. The Hit3 Wave Select value must be at least 1 greater
                         than the Hit2 Wave Select value. For example, if the Hit2 Wave Select value is set to measure wave
                         number 10, then the Hit3 Wave Select must be set to detect wave number 11 or greater. The earliest
                         wave for which Hit3 can be measured is Wave 5.
                HIT3WV
      13:8                             HIT3WV[5:0] (decimal)                                 DESCRIPTION
                   [5:0]
                                                 0 to 5                                           Wave 5
                                                   6                                              Wave 6
                                                   7                                              Wave 7
                                                8 to 63                                        Wave 8 to 63
       7:6           X   Reserved
                         Hit4 Wave Select: These bits select the wave number for which the Hit4 stop time is measured.
                         Wave numbers are depicted in Figure 5B. The Hit4 Wave Select value must be at least 1 greater
                         than the Hit3 Wave Select value. For example, if the Hit3 Wave Select value is set to measure wave
                         number 11, then the Hit4 Wave Select must be set to detect wave number 12 or greater. The earliest
                         wave for which Hit4 can be measured is Wave 6.
                HIT4WV
       5:0                             HIT4WV[5:0] (decimal)                                 DESCRIPTION
                   [5:0]
                                                 0 to 6                                           Wave 6
                                                   7                                              Wave 7
                                                   8                                              Wave 8
                                                9 to 63                                        Wave 9 to 63
www.maximintegrated.com                                                                                   Maxim Integrated │ 59


MAX35104                                                                                     Gas Flow Meter SoC
Table 21. TOF5 Register
                                                    TOF5 REGISTER
         WRITE OPCODE            READ OPCODE                                   POR DEFAULT VALUE
              3Ch                      BCh                                             0000h
 Bit                15        14            13             12              11            10              9              8
 Name                X        X          Hit5WV5        Hit5WV4        Hit5WV3       Hit5WV2        Hit5WV1         Hit5WV0
 Bit                 7         6             5              4              3              2              1              0
 Name                X        X          Hit6WV5        Hit6WV4        Hit6WV3       Hit6WV2        Hit6WV1         Hit6WV0
      BIT         NAME                                              DESCRIPTION
     15:14           X   Reserved
                         Hit5 Wave Select: These bits select the wave number for which the Hit5 stop time is measured.
                         Wave numbers are depicted in Figure 5B. The Hit5 Wave Select value must be at least 1 greater
                         than the Hit4 Wave Select value. For example, if the Hit4 Wave Select value is set to measure wave
                         number 12, then the Hit5 Wave Select must be set to detect wave number 13 or greater. The earliest
                         wave for which Hit5 can be measured is Wave 7.
                HIT5WV
      13:8                             HIT5WV[5:0] (decimal)                                    DESCRIPTION
                   [5:0]
                                                0 to 7                                             Wave 7
                                                   8                                               Wave 8
                                                   9                                               Wave 9
                                               10 to 63                                          Wave 10 to 63
       7:6           X   Reserved
                         Hit6 Wave Select: These bits select the wave number for which the Hit6 stop time is measured.
                         Wave numbers are depicted in Figure 5B. Hit6 Wave Select value must at least 1 greater than the
                         Hit5 Wave Select value. For example, if Hit5 Wave Select value is set to measure wave number 13,
                         then the Hit6 Wave Select must be set to detect wave number 14 or greater. The earliest wave for
                         which Hit6 can be measured is Wave 8.
                HIT5WV
       5:0                             HIT4WV[5:0] (decimal)                                    DESCRIPTION
                   [5:0]
                                                0 to 8                                             Wave 8
                                                   9                                               Wave 9
                                                  10                                               Wave 10
                                               11 to 63                                          Wave 11 to 63
www.maximintegrated.com                                                                                   Maxim Integrated │ 60


MAX35104                                                                                          Gas Flow Meter SoC
Table 22. TOF6 Register
                                                       TOF6 REGISTER
       WRITE OPCODE                READ OPCODE                                     POR DEFAULT VALUE
             3Dh                         BDh                                                 0000h
 Bit                15          14             13              12             11              10             9              8
               C_OFFSET     C_OFFSET      C_OFFSET        C_OFFSET      C_OFFSET         C_OFFSET       C_OFFSET       C_OFFSET
 Name
                  UPR7        UPR6           UPR5            UPR4           UPR3            UPR2           UPR1          UPR0
 Bit                 7           6              5               4              3               2             1              0
                            C_OFFSET      C_OFFSET        C_OFFSET      C_OFFSET         C_OFFSET       C_OFFSET       C_OFFSET
 Name               X
                               UP6            UP5             UP4            UP3             UP2            UP1           UP0
     BIT            NAME                                                 DESCRIPTION
                               Comparator Return Offset Upstream: When the device is measuring the t2 wave, the
                               programmed receive comparator offset is returned to a common mode voltage automatically after
                               the Early Edge, t1, is detected. The actual offset return voltage is dependent upon and scales
                               with the voltage present at the VCC pins. The following formula defines the Comparator Return
                               Offset voltage setting, where C_OFFSETUPR is a two’s-complement number:
                                                                                   1152 + C_OFFSETUPR
                                Comparator Return Offset Voltage   = VCC ×
                C_OFFSETUP                                                                    3072
     15:8
                     R[7:0]                       VCC
                                where 1 LSB =
                                                  3072
                                             C_OFFSETUPR[6:0]                                       OFFSET (LSBs)
                                                   7Fh to 01h                                           127 to 1
                                                       00h                                                 0
                                                   80h to FFh                                          -128 to -1
      7                X       Reserved
www.maximintegrated.com                                                                                       Maxim Integrated │ 61


MAX35104                                                                                  Gas Flow Meter SoC
Table 22. TOF6 Register (continued)
    BIT             NAME                                            DESCRIPTION
                           Comparator Offset Upstream: These bits define an initial selected receive comparator offset
                           voltage for the analog receiver comparator front-end. This comparator offset is used to detect the
                           Early Edge wave, t1. The actual common mode voltage is dependent upon and scales with the
                           voltage present at the VCC pins.
                           When the STOP_POL bit in the TOF1 register is set to zero indicating a rising edge detection of
                           the zero crossing of the received acoustic wave, then the Comparator Offset is a positive value.
                           When the STOP_POL bit in the TOF1 register is set to one indicating a falling edge detection of
                           the zero crossing of the received acoustic wave, then the Comparator Offset is a negative value.
                           The following formulas define the Comparator Offset voltage setting
                C_OFFSETUP
    6:0
                     [6:0]
                                                                                        1152 + C_OFFSETUP
                            STOP_POL= 0 Comparator Offset Voltage        =       VCC ×
                                                                                                 3072
                                                                                        1151 − C_OFFSETUP
                            STOP_POL= 1 Comparator Offset Voltage       =       VCC ×
                                                                                                 3072
                                              VCC
                            where 1 LSB =
                                              3072
                                          C_OFFSETUP[6:0]                                   OFFSET (LSBs)
                                              00h to 7Fh                                        0 to 127
www.maximintegrated.com                                                                                Maxim Integrated │ 62


MAX35104                                                                                            Gas Flow Meter SoC
Table 23. TOF7 Register
                                                       TOF7 REGISTER
      WRITE OPCODE                READ OPCODE                                       POR DEFAULT VALUE
            3Eh                           BEh                                                  0000h
 Bit               15           14               13              12             11              10              9              8
               C_OFFSET     C_OFFSET        C_OFFSET       C_OFFSET        C_OFFSET        C_OFFSET        C_OFFSET       C_OFFSET
 Name
                  DNR7        DNR6            DNR5             DNR4           DNR3            DNR2            DNR1          DNR0
 Bit                7            6                5               4             3                2              1              0
                            C_OFFSET        C_OFFSET       C_OFFSET        C_OFFSET        C_OFFSET        C_OFFSET       C_OFFSET
 Name               X
                               DN6             DN5              DN4            DN3             DN2             DN1           DN0
     BIT             NAME                                                   DESCRIPTION
                                  Comparator Return Offset Downstream: When the device is measuring the t2 wave, the
                                  programmed receive comparator offset is returned to a common mode voltage automatically
                                  after the Early Edge, t1, is detected. The actual offset return voltage is dependent upon and
                                  scales with the voltage present at the VCC pins. The following formula defines the Comparator
                                  Return Offset voltage setting, where C_OFFSETDNR is a two’s-complement number:
                                                                                      1152 + C_OFFSETDNR
               C_OFFSETDNR
                                  Comparator Return Offset Voltage     = VCC ×
     15:8                                                                                         3072
                      [7:0]                          VCC
                                  where 1 LSB =
                                                    3072
                                                C_OFFSETDNR[6:0]                                      OFFSET (LSBs)
                                                     7Fh to 01h                                           127 to 1
                                                         00h                                                  0
                                                    80h to FFh                                           -128 to -1
      7                 X         Reserved
www.maximintegrated.com                                                                                          Maxim Integrated │ 63


MAX35104                                                                                   Gas Flow Meter SoC
Table 23. TOF7 Register (continued)
    BIT              NAME                                            DESCRIPTION
                            Comparator Offset Downstream: These bits define an initial selected receive comparator
                            offset voltage for the analog receiver comparator front-end. This comparator offset is used
                            to detect the Early Edge wave, t1. The actual common mode voltage is dependent upon and
                            scales with the voltage present at the VCC pins.
                            When the STOP_POL bit in the TOF1 register is set to zero indicating a rising edge detection of
                            the zero crossing of the received acoustic wave, then the Comparator Offset is a positive value.
                            When the STOP_POL bit in the TOF1 register is set to one indicating a falling edge detection
                            of the zero crossing of the received acoustic wave, then the Comparator Offset is a negative
                            value.
                C_OFFSETDN  The following formulas define the Comparator Offset voltage setting:
    6:0
                      [6:0]
                                                                                          1152 + C OFFSETUP
                             STOP_POL  = 0 Comparator Offset Voltage       = VCC ×
                                                                                                 3072
                                                                                         1151 − C OFFSETUP
                             STOP_POL  = 1 Comparator Offset Voltage      = VCC ×
                                                                                                 3072
                                                VCC
                             where 1 LSB =
                                                3072
                                          C_OFFSETDN[6:0]                                    OFFSET (LSBs)
                                                00h to 7Fh                                       0 to 127
www.maximintegrated.com                                                                                Maxim Integrated │ 64


MAX35104                                                                                        Gas Flow Meter SoC
Table 24. Event Timing 1 Register
                                            EVENT TIMING 1 REGISTER
         WRITE OPCODE            READ OPCODE                                      POR DEFAULT VALUE
              3Fh                     BFh                                                  0000h
 Bit                15        14           13               12              11              10              9              8
 Name             TDF3      TDF2          TDF1             TDF0            TDM4           TDM3           TDM2           TDM1
 Bit                 7         6            5                4               3               2              1              0
 Name             TDM0      TMF5          TMF4            TMF3             TMF2           TMF1            TMF0             X
      BIT         NAME                                               DESCRIPTION
                         TOF Difference Measurement Frequency: These bits define the rate at which TOF_DIFF
                         measurements are executed when the EVTMG1 or EVTMG2 command is executed.
                         Rate = 0.5s + (TDF[3:0] x 0.5s) + randomizer value
     15:12      TDF[3:0]                 TDF[3:0] (decimal)                                          RATE (s)
                                                  0                                                      0.5
                                                  1                                                      1.0
                                                 ...                                                     ...
                                                 14                                                      7.5
                         TOF Difference Measurements: These bits define the number of TOF_DIFF measurement cycles to
                         be executed when the EVTMG1 or EVTMG2 command is executed.
                         Cycles = 1+ TDM[4:0]
      11:7      TDM[4:0]                 TDM[4:0] (decimal)                                          CYCLES
                                                  0                                                       1
                                                  1                                                       2
                                                 ...                                                     ...
                                                 30                                                      31
                         Temperature Measurement Frequency: These bits define the time delay between temperature
                         cycle measurements. It is a start-cycle to start-cycle time duration at which temperature
                         measurement cycles are executed when the EVTMG1 or EVTMG3 command is executed.
                         Rate = 1.0s + (TMF[3:0] * 1.0s) + randomizer value
       6:1      TMF[5:0]                 TMF[5:0] (decimal)                                          RATE (S)
                                                  0                                                       1
                                                  1                                                       2
                                                 ...                                                     ...
                                                 62                                                      63
        0           X    Reserved
www.maximintegrated.com                                                                                      Maxim Integrated │ 65


MAX35104                                                                                      Gas Flow Meter SoC
Table 25. Event Timing 2 Register
                                                EVENT TIMING 2 REGISTER
     WRITE OPCODE           READ OPCODE                                         POR DEFAULT VALUE
          40h                     C0h                                                   0000h
 Bit            15          14              13              12              11            10             9               8
 Name         TMM4         TMM3           TMM2            TMM1            TMM0        CAL_USE      CAL_CFG2        CAL_CFG1
 Bit             7           6               5               4              3              2             1               0
 Name      CAL_CFG0          X              X          PRECYC2         PRECYC1        PRECYC0      PORTCYC1        PORTCYC0
    BIT            NAME                                                   DESCRIPTION
                                Temperature Measurements: These bits define the number of temperature measurement
                                cycles to be executed when the EVTMG1 or EVTMG3 command is executed.
                                Cycles = 1+ TMM[4:0]
                                               TMM[4:0] (decimal)                                  CYCLES
  15:11           TMM[4:0]
                                                        0                                              1
                                                        1                                              2
                                                       ...                                           ...
                                                       30                                             31
                                Calibration Usage: This bit, when set, causes the device to use the calibration data in the
                                CalibrationInt and CalibrationFrac registers during measurement, averaging and accumulation
     10          CAL_USE
                                of data while executing the EVTMG commands. All time measurements are scaled using the
                                calibration factors as described by the Calibrate command.
                                Calibration Configuration: These bits define the point in the EVTMGx cycle/sequence where
                                the automatic Calibration command is executed.
                                                                                     DESCRIPTION
                                   CAL_CFG[2:0]            During EVTMGx sequences, automatic execution of the Calibrate
                                                           command occurs at:
                                     000b to 011b          Auto Calibration Disabled
     9:7       CAL_CFG[2:0]                                The beginning of each TOF_DIFF cycle
                                         100b
                                                           The beginning of each Temperature cycle
                                                           The beginning of each TOF_DIFF cycle
                                         101b
                                                           The beginning of each Temperature sequence
                                                           Once at the beginning of each TOF_DIFF sequence
                                          110b
                                                           The beginning of each Temperature cycle
                                                           Once at the beginning of each TOF_DIFF sequence
                                          111b
                                                           The beginning of each Temperature sequence
     6:5              X         Reserved
www.maximintegrated.com                                                                                    Maxim Integrated │ 66


MAX35104                                                                                        Gas Flow Meter SoC
Table 25. Event Timing 2 Register (continued)
    BIT            NAME                                                  DESCRIPTION
                                Preamble Temperature Cycle: These 3 bits are used to set the number of cycles to use as
                                preamble for reducing dielectric absorption of the temperature measurement capacitor. Each
                                cycle is comprised of one temperature measurement sequence as defined by the TP[1:0] bits.
                                      PRECYC2                  PRECYC1                  PRECYC0                DESCRIPTION
                                           0                        0                        0                 0 Dummy Cycle
                                           0                        0                        1                 1 Dummy Cycles
     4:2       PRECYC[2:0]
                                           0                        1                        0                 2 Dummy Cycles
                                           0                        1                        1                 3 Dummy Cycles
                                           1                        0                        0                 4 Dummy Cycles
                                           1                        0                        1                 5 Dummy Cycles
                                           1                        1                        0                 6 Dummy Cycles
                                           1                        1                        1                 7 Dummy Cycles
                                Port Cycle Time: These two bits define the time interval between successive individual
                                temperature port measurements. It is a start-to-start time. These bits also define the timeout
                                function of the temperature measurement ports. See the Temperature Operation Sections for
                                timeout details.
     1:0      PORTCYC[1:0]                PORTCYC1                         PORTCYC0                     DESCRIPTION (µs)
                                               0                                0                                128
                                               0                                1                                256
                                               1                                0                                384
                                               1                                1                                512
Table 26. TOF Measurement Delay Register
                                        TOF MEASUREMENT DELAY REGISTER
        WRITE OPCODE             READ OPCODE                                     POR DEFAULT VALUE
             41h                        C1h                                                0000h
 Bit                15        14              13             12             11              10              9              8
 Name             DLY15      DLY14           DLY13         DLY12           DLY11          DLY10           DLY9           DLY8
 Bit                 7         6               5              4              3               2              1              0
 Name             DLY7       DLY6            DLY5           DLY4           DLY3            DLY2           DLY1           DLY0
      BIT            NAME                                                DESCRIPTION
                                This is hexadecimal value ranging from 0000h to FFFFh (Decimal 0 to 65535). It is a multiple
                                of the 4MHz crystal period (250ns). The minimum setting is 0064h, which is equivalent to 25µs.
                                The analog comparator driven by the bandpass filter does not generate a stop condition until
      15:0         DLY[15:0]    this delay, counted from the internally generated start pulse for the acoustic wave, has expired.
                                This delay applies to Early Edge Detect wave.
                                Care must be taken to set the TIMOUT bits in the TOF2 register so that a timeout interrupt
                                does not occur before this delay expires.
www.maximintegrated.com                                                                                      Maxim Integrated │ 67


MAX35104                                                                                           Gas Flow Meter SoC
Table 27. Calibration and Control Register
                                           CALIBRATION AND CONTROL REGISTER
       WRITE OPCODE                  READ OPCODE                                   POR DEFAULT VALUE
             42h                            C2h                                               0000h
 Bit           15            14               13              12            11               10              9               8
 Name          X              X               X                X          CMP_EN         CMP_SEL          INT_EN        ET_CONT
 Bit            7             6                5               4             3                2              1               0
                                                                           CAL_            CAL_            CAL_            CAL_
 Name     CONT_INT        CLK_S2            CLK_S1          CLK_S0
                                                                          PERIOD3        PERIOD2         PERIOD1         PERIOD0
   BIT       NAME                                                      DESCRIPTION
  15:12        X        Reserved
                        Comparator/UP_DN Output Enable :
    11     CMP_EN       1 = CMP_OUT/UP_DN output device pin is enabled.
                        0 = CMP_OUT/UP_DN output device pin is driven low.
                        Comparator/UP_DN Output Select: This bit selects the output function of the CMP_OUT/UP_DN pin
                        and is only used when CMP_EN = 1.
    10     CMP_SEL      1 = CMP_EN: The output monitors the receiver front-end comparator output.
                        0 = UP_DN: The output monitors the launch direction of the pulse launcher.
                        High Output: Upstream measurement (TX_UP to TX_DN)
                        Low Output: Downstream measurement (TX_DN to TX_UP)
                        Interrupt Enable: This bit, when set, enables the INT pin. All interrupt sources are wire-ORed to the
     9      INT_EN
                        INT pin.
                        Event Timing Continuous Operation: This bit, when set, causes the currently executing EVTMGx
                        command to continuously execute until the HALT command is received by the device.
                        This bit, when cleared, causes:
                             •     The currently executing EVTMG1 command to run one sequence of TOF_DIFF
     8     ET_CONT
                                   measurement cycles and/or one sequence of temperature measurement.
                             •     The currently executing EVTMG2 command to run one sequence of TOF_DIFF measurements
                                   cycles.
                             •     The currently executing EVTMG3 command to run one sequence of temperature measurement
                                   cycles.
                        Continuous Interrupt: This bit, when set, causes the currently executing EVTMGx command to assert
                        the INT pin (if enabled) after every TOF_DIFF or Temperature measurement cycle. This allows the host
     7    CONT_INT      microprocessor to interrogate the current Event for accuracy of measurements and hit data.
                        When this bit is cleared, the currently executing EVTMGx command interrupt-generation behavior is
                        controlled only by the setting of the ET_CONT bit.
www.maximintegrated.com                                                                                        Maxim Integrated │ 68


MAX35104                                                                                         Gas Flow Meter SoC
Table 27. Calibration and Control Register (continued)
  BIT        NAME                                                      DESCRIPTION
                        Clock Settling Time: These bits define the time interval that the device waits after enabling the
                        4MHz clock for it to stabilize before making any measurements of time or temperature.
                                                                                                   DESCRIPTION
                            CLK_S2               CLK_S1             CLK_S0
                                                                                    32kHz CLOCK CYCLES             TYPICAL TIME
                                0                     0                 0                       16                       488µs
                                0                     0                 1                       48                      1.46ms
  6:4     CLK_S[2:0]
                                0                     1                 0                       96                      2.93ms
                                0                     1                 1                      128                       3.9ms
                                1                     0                 0                      168                      5.13ms
                                1                     0                 1                    4MHz Osc On Continuously
                                1                     1                 0                    4MHz Osc On Continuously
                                1                     1                 1                    4MHz Osc On Continuously
                        4MHz Ceramic Oscillator Calibration Period: These bits define the number of 32.768kHz oscillator
                        periods to measure for determination of the 4MHz ceramic oscillator period.
                        32kHz Clock Cycles = 1+ CAL_PERIOD[3:0]
                                                                                         DESCRIPTION
                                 CAL_PERIOD[3:0]
           CAL_PERI                  (decimal)                        32kHz CLOCK CYCLES                      TYPICAL TIME
  3:0                                                                       (decimal)                               (µs)
            OD[3:0]
                                           0                                     1                                  30.5
                                           1                                     2                                   61
                                         ...                                    ...                                  ...
                                          14                                    15                                 457.7
                                          15                                    16                                 488.0
www.maximintegrated.com                                                                                        Maxim Integrated │ 69


MAX35104                                                                                          Gas Flow Meter SoC
Table 28. Real-Time Clock Register
                                               REAL-TIME CLOCK REGISTER
         WRITE OPCODE                  READ OPCODE                                    POR DEFAULT VALUE
              43h                              C3h                                              0000h
 Bit               15          14               13               12              11           10               9              8
 Name               X          X                 X                X              X            X                X              X
 Bit                7           6                5                4              3             2               1              0
 Name               X      32K_BP            32K_EN            EOSC             AM1          AM0             WF           WD_EN
     BIT          NAME                                                     DESCRIPTION
     15:7           X    Reserved
                         32kHz Bypass: This bit, when set, allows an external CMOS-level 32.768kHz signal to be applied to
       6         32K_BP  the 32KX1 device pin. The internal 32.768kHz oscillator is bypassed and the external signal is driven
                         into the device’s core.
                         32kHz Clock Output Enable: This bit enables the 32KOUT device pin to drive a CMOS-level square
       5        32K_EN
                         wave representation of the 32kHz crystal.
                         Enable Oscillator: This active-low bit when set to logic 0 starts the real time clock oscillator. When
       4          EOSC
                         this bit is set to logic 1, the oscillator is stopped.
                         Alarm Control: The device contains a time-of-day alarm. The alarm is activated when either the
                         AM1 or AM2 bits are set. When the RTC’s hours or minutes value increments to a value equal to the
                         alarm settings in Alarm registers, the AF bit in the Interrupt Status register is set and the INT device
                         pin is asserted (if enabled) and remains asserted until the Interrupt Status register is accessed by the
                         microprocessor with a Read register command.
      3:2        AM[1:0]             AM1                      AM0                          ALARM FUNCTION
                                      0                         0           No alarm
                                      0                         1           Alarm when minutes match
                                      1                         0           Alarm when hours match
                                      1                         1           Alarm when hours and minutes match
                         Watchdog Flag: This bit is set when the watchdog counter reaches zero. This bit must be written to
       1           WF    a zero to clear the bit. Writing this bit to a zero when the WDO pin is asserted low releases the WDO
                         pin to its inactive high-impedance state.
                         Watchdog Enable:
       0         WD_EN   1 = Watchdog timer is enabled.
                         0 = Watchdog time is disabled and the WDO pin is high impedance.
www.maximintegrated.com                                                                                         Maxim Integrated │ 70


MAX35104                                                                                                 Gas Flow Meter SoC
Table 29. Interrupt Status Register
                                                    INTERRUPT STATUS REGISTER
         WRITE OPCODE                   READ OPCODE                                        POR DEFAULT VALUE
          READ ONLY                             FEh                                                0000h
 Bit               15              14            13            12            11               10              9                  8
 Name              TO             AF              X           TOF           TE               LDO         TOF_EVTMG       TEMP_EVTMG
 Bit                7               6             5             4            3                 2              1                  0
 Name               X             Cal            Halt        CSWI            X              PORX              X                  X
 Note: This register is read only and bits are self-clearing upon a read to this register, see the Interrupt Operations section for more
 information.
     BIT         NAME                                                       DESCRIPTION
                             TimeOut: The TO bit is set if any one of the t1, t2, Hit1 thru Hit6, or temperature measurements do not
      15           TO
                             occur causing the time set by the TIMOUT[2:0] bits in the TOF2 register to elapse.
                             Alarm Flag: Set when the RTC’s hours or minutes value increments to a value equal to the alarm
      14           AF
                             settings in Alarm registers.
      13            X        Reserved
                             Time of Flight: Set when the TOF_UP, TOF_DN, or TOF_DIFF command has completed.
                             During execution of The EVTMG1 or EVTMG2 command, this bit is set and the INT pin is asserted
      12          TOF
                             (if enabled) upon completion of each of the cycles of the Event defined by the TOF Difference
                             Measurements setting if the CONT_INT bit in the Calibration and Control register has been set.
                             Temperature: Set when the Temperature command has completed.
                             During execution of The EVTMG1 or EVTMG3 command, this bit is set and the INT pin is asserted
      11           TE
                             (if enabled) upon completion of each of the cycles of the Event defined by the Temperature
                             Measurements setting if the CONT_INT bit in the Calibration and Control register has been set.
                             Internal LDO Stabilized: Set when the internal low-dropout regulator is turned on by either the LDO_
      10          LDO
                             Timed or LDO_ON and has stabilized.
                             Event Timing TOF Completed: Set when either the EVTMG1 or EVTMG2 commands have completed
                 TOF_
       9                     its last TOF_DIFF measurement cycle. This indicates that the data in the T1, T2, T1_AVG, and T2_AVG
                EVTMG
                             registers is valid.
                             Event Timing Temperature Completed: Set when the EVTMG1 or EVTMG3 commands have
                TEMP_
       8                     completed its last temperature measurements. This indicates that the data in the T1, T2, T3, T4, T1_
                EVTMG
                             AVG, T2AVG, T3AVG, and T4_AVG Results registers is valid.
       7            X        Reserved
                             Calibrate: Set after completion of the Calibrate command when the command is manually sent by the
                             host microprocessor. When Calibration occurs as a result of the setting of the Cal_Use, Cal_AUTO
       6          CAL
                             and Cal_CFGx bits in the Event Timing 2 register and the device is automatically executing Calibration
                             commands as required during execution of any of the EVTMGx commands, this bit is not set.
       5         HALT        HALT: Set when the HALT command has completed
       4         CSWI        Case Switch: Set when a high logic level is detected on the CSW device pin.
       3            X        Reserved
                             Power-On-Reset: Set when the device has been successfully powered by application of VCC. Upon
       2          POR
                             application of power, the SPI port is inactive until this bit has been set.
     1:0            X        Reserved
www.maximintegrated.com                                                                                              Maxim Integrated │ 71


MAX35104                                                                                         Gas Flow Meter SoC
Table 30. Control Register
                                                  CONTROL REGISTER
        WRITE OPCODE                READ OPCODE                                       POR DEFAULT VALUE
             FFh                           7Fh                                                 000xh
 Bit                15        14              13              12              11             10             9                8
 Name               X          X               X               X              X              X             AFA            CSWA
 Bit                 7         6               5               4              3               2             1                0
 Name               X          X               X               X           HWR3            HWR2          HWR1             HWR0
      BIT         NAME                                                DESCRIPTION
     15:10          X    Reserved
                         Alarm Flag Arm: This bit is set when the RTC’s hours and/or minutes value matched the alarm
                         settings in the Real-Time Clock register. This bit is set at the same time as the AF bit in the Interrupt
       9           AFA
                         Status register. After resetting the RTC alarm settings, a 0 must be written to this bit to re-arm the
                         RTC Alarm. This bit can only be written to a 0.
                         Case Switch Arm: This bit is set when the CSW pin detects a logic-high, indicating the MAX35104
                         has detected a tamper condition. This bit is set at the same time as the CSWI bit in the Interrupt
       8          CSWA   Status register. Once set, this bit must be written to a 0 to re-arm the Case Switch Detection. The
                         Case Switch Detection must be re-armed before the CSWI interrupt can be set again. This bit can
                         only be written to a 0.
      7:0           X    Reserved
                         Hardware Revision: These 4 bits contain hardware revision code specific to the MAX35104 device.
      3:0       HWR[3:0] Note: This value can be accessed and modified. Read this register directly after a POR to get the
                         correct hardware revision number.
www.maximintegrated.com                                                                                      Maxim Integrated │ 72


MAX35104                                                                                              Gas Flow Meter SoC
Conversion Results Register Descriptions
The devices conversion results registers are all read only volatile SRAM. The POR default value for all registers is 0000h.
Table 31. Conversion Results Registers Description
 READ-ONLY
                REGISTER                                                    DESCRIPTION
  ADDRESS
                           Bit 15 to Bit 8 holds the 8 bit value of the pulse width ratio (t1 ÷ t2).for the upstream measurement.
                           Each bit is weighted as follows:
                              Bit15          Bit 14        Bit 13         Bit 12       Bit 11        Bit 10         Bit 9         Bit 8
                                 1            0.5           0.25          0.125        0.0625       0.03125      0.015625      0.0078125
                           Bit 7 to bit 0 holds the 8 bit value of the pulse width ratio (t2 ÷ tIDEAL) where tIDEAL is equal to one-
     C4h          WVRUP
                           half the period of the Pulse Launch Frequency for the upstream measurement. Each bit is weighted
                           as follows:
                               Bit 7         Bit 6         Bit 5           Bit 4        Bit 3         Bit 2         Bit 1         Bit 0
                                 1            0.5           0.25          0.125        0.0625       0.03125      0.015625      0.0078125
                           The maximum value of each of these ratios is 1.9921875.
                           15-bit fixed-point integer value of the first hit in the upstream direction. This integer portion is a binary
     C5h         Hit1UPInt representation of the number of t4MHz periods that contribute to the time results. The maximum size
                           of the integer is 7FFFh or (215 - 1) x t4MHZ.
                           16-bit fractional value of the first hit in the upstream direction. This fractional portion is a binary
     C6h        Hit1UPFrac representation of one t4MHz period quantized to a 16-bit resolution. The maximum size of the fraction
                           is FFFFh or (216 - 1)/ 216 x t4MHZ.
                           15-bit fixed-point integer value of the second hit in the upstream direction. This integer portion
     C7h         Hit2UPInt is a binary representation of the number of t4MHz periods that contribute to the time results. The
                           maximum size of the integer is 7FFFh or (215 - 1) x t4MHZ.
                           16-bit fractional value of the second hit in the upstream direction. This fractional portion is a binary
     C8h        Hit2UPFrac representation of one t4MHz period quantized to a 16-bit resolution. The maximum size of the fraction
                           is FFFFh or (216 - 1)/ 216 x t4MHZ.
                           15-bit fixed-point integer value of the third hit in the upstream direction. This integer portion is a binary
     C9h         Hit3UPInt representation of the number of t4MHz periods that contribute to the time results. The maximum size
                           of the integer is 7FFFh or (215 - 1) x t4MHZ.
                           16-bit fractional value of the third hit in the upstream direction. This fractional portion is a binary
     CAh        Hit3UPFrac representation of one t4MHz period quantized to a 16-bit resolution. The maximum size of the fraction
                           is FFFFh or (216 - 1)/ 216 x t4MHZ.
                           15-bit fixed-point integer value of the fourth hit in the upstream direction. This integer portion is
     CBh         Hit4UPInt a binary representation of the number of t4MHz periods that contribute to the time results. The
                           maximum size of the integer is 7FFFh or (215 - 1) x t4MHZ.
                           16-bit fractional value of the fourth hit in the upstream direction. This fractional portion is a binary
     CCh        Hit4UPFrac representation of one t4MHz period quantized to a 16-bit resolution. The maximum size of the fraction
                           is FFFFh or (216 - 1)/ 216 x t4MHZ.
                           15-bit fixed-point integer value of the fifth hit in the upstream direction. This integer portion is a binary
     CDh         Hit5UPInt representation of the number of t4MHz periods that contribute to the time results. The maximum size
                           of the integer is 7FFFh or (215 - 1) x t4MHZ.
www.maximintegrated.com                                                                                            Maxim Integrated │ 73


MAX35104                                                                                              Gas Flow Meter SoC
Table 31. Conversion Results Registers Description (continued)
 READ-ONLY
                REGISTER                                                    DESCRIPTION
  ADDRESS
                           16-bit fractional value of the fifth hit in the upstream direction. This fractional portion is a binary
     CEh        Hit5UPFrac representation of one t4MHz period quantized to a 16-bit resolution. The maximum size of the fraction
                           is FFFFh or (216 - 1)/ 216 x t4MHZ.
                           15-bit fixed-point integer value of the sixth hit in the upstream direction. This integer portion is
     CFh         Hit6UPInt a binary representation of the number of t4MHz periods that contribute to the time results. The
                           maximum size of the integer is 7FFFh or (215 - 1) x t4MHZ.
                           16-bit fractional value of the sixth hit in the upstream direction. This fractional portion is a binary
    D0Fh        Hit6UPFrac representation of one t4MHz period quantized to a 16-bit resolution. The maximum size of the fraction
                           is FFFFh or (216 - 1)/ 216 x t4MHZ.
                           15-bit fixed-point integer value of the average of the hits recorded in the upstream direction This
     D1h         AVGUPInt  integer portion is a binary representation of the number of t4MHz periods that contribute to the time
                           results. The maximum size of the integer is 7FFFh or (215 - 1) x t4MHZ.
                           16-bit fractional value of the average of the hits recorded in the upstream direction. This fractional
                  AVGUP
     D2h                   portion is a binary representation of one t4MHz period quantized to a 16-bit resolution. The maximum
                    Frac
                           size of the fraction is FFFFh or (216 - 1)/ 216 x t4MHZ.
                           Bit 15 thru Bit 8 holds the 8 bit value of the pulse width ratio (t1 ÷ t2).for the downstream
                           measurement. Each bit is weighted as follows:
                              Bit15          Bit 14        Bit 13         Bit 12       Bit 11        Bit 10         Bit 9         Bit 8
                                 1            0.5           0.25          0.125       0.0625       0.03125       0.015625      0.0078125
                           Bit 7 to bit 0 holds the 8 bit value of the pulse width ratio (t2 ÷ tIDEAL) where tIDEAL is equal to
     D3h          WVRDN
                           one-half the period of the Pulse Launch Frequency for the downstream measurement. Each bit is
                           weighted as follows:
                               Bit 7         Bit 6         Bit 5           Bit 4       Bit 3          Bit 2         Bit 1         Bit 0
                                 1            0.5           0.25          0.125       0.0625       0.03125       0.015625      0.0078125
                           The maximum value of each of these ratios is 1.9921875.
                           15-bit fixed-point integer value of the first hit in the downstream direction. This integer portion is
     D4h         Hit1DNInt a binary representation of the number of t4MHz periods that contribute to the time results. The
                           maximum size of the integer is 7FFFh or (215 - 1) x t4MHZ.
                           16-bit fractional value of the first hit in the downstream direction. This fractional portion is a binary
     D5h        Hit1DNFrac representation of one t4MHz period quantized to a 16-bit resolution. The maximum size of the fraction
                           is FFFFh or (216 - 1)/ 216 x t4MHZ.
                           15-bit fixed-point integer value of the second hit in the downstream direction. This integer portion
     D6h         Hit2DNInt is a binary representation of the number of t4MHz periods that contribute to the time results. The
                           maximum size of the integer is 7FFFh or (215 - 1) x t4MHZ.
                           16-bit fractional value of the second hit in the downstream direction. This fractional portion is a binary
     D7h        Hit2DNFrac representation of one t4MHz period quantized to a 16-bit resolution. The maximum size of the fraction
                           is FFFFh or (216 - 1)/ 216 x t4MHZ.
                           15-bit fixed-point integer value of the third hit in the downstream direction. This integer portion
     D8h         Hit3DNInt is a binary representation of the number of t4MHz periods that contribute to the time results. The
                           maximum size of the integer is 7FFFh or (215 - 1) x t4MHZ.
www.maximintegrated.com                                                                                            Maxim Integrated │ 74


MAX35104                                                                                            Gas Flow Meter SoC
Table 31. Conversion Results Registers Description (continued)
 READ-ONLY
                REGISTER                                                    DESCRIPTION
  ADDRESS
                           16-bit fractional value of the third hit in the downstream direction. This fractional portion is a binary
     D9h        Hit3DNFrac representation of one t4MHz period quantized to a 16-bit resolution. The maximum size of the fraction
                           is FFFFh or (216 - 1)/ 216 x t4MHZ.
                           15-bit fixed-point integer value of the fourth hit in the downstream direction. This integer portion
     DAh         Hit4DNInt is a binary representation of the number of t4MHz periods that contribute to the time results. The
                           maximum size of the integer is 7FFFh or (215 - 1) x t4MHZ.
                           16-bit fractional value of the fourth hit in the downstream direction. This fractional portion is a binary
     DBh        Hit4DNFrac representation of one t4MHz period quantized to a 16-bit resolution. The maximum size of the fraction
                           is FFFFh or (216 - 1)/ 216 x t4MHZ.
                           15-bit fixed-point integer value of the fifth hit in the downstream direction. This integer portion is
     DCh         Hit5DNInt a binary representation of the number of t4MHz periods that contribute to the time results. The
                           maximum size of the integer is 7FFFh or (215 - 1) x t4MHZ.
                           16-bit fractional value of the fifth hit in the downstream direction. This fractional portion is a binary
     DDh        Hit5DNFrac representation of one t4MHz period quantized to a 16-bit resolution. The maximum size of the fraction
                           is FFFFh or (216 - 1)/ 216 x t4MHZ.
                           15-bit fixed-point integer value of the sixth hit in the downstream direction This integer portion is
     DEh         Hit6DNInt a binary representation of the number of t4MHz periods that contribute to the time results. The
                           maximum size of the integer is 7FFFh or (215 - 1) x t4MHZ.
                           16-bit fractional value of the sixth hit in the downstream direction. This fractional portion is a binary
     DFh        Hit6DNFrac representation of one t4MHz period quantized to a 16-bit resolution. The maximum size of the fraction
                           is FFFFh or (216 - 1)/ 216 x t4MHZ.
                           15-bit fixed-point integer value of the average of the hit times recorded in the downstream direction
     E0h         AVGDNInt  This integer portion is a binary representation of the number of t4MHz periods that contribute to the
                           time results. The maximum size of the integer is 7FFFh or (215 - 1) x t4MHZ.
                           16-bit fractional value of the average of the hit times recorded in the downstream direction. This
                  AVGDN
     E1h                   fractional portion is a binary representation of one t4MHz period quantized to a 16-bit resolution. The
                    Frac
                           maximum size of the fraction is FFFFh or (216 - 1)/ 216 x t4MHZ.
                           16-bit fixed-point two’s-complement integer portion of the difference of the averages for the hits
                           recorded in both the upstream and downstream directions. It is computed as:
                   TOF_                                                    AVGUP – AVGDN
     E2h
                  DIFFInt  This integer represents the number of t4MHz periods that contribute to computation.
                           The maximum size of the integer is 7FFFh or (215 - 1) x t4MHZ. The minimum size of this integer is
                           8000h or -215 x t4MHz.
                           16-bit fractional portion of the two’s complement difference of the averages for the hits recorded
                   TOF_    in both the upstream and downstream directions. This fractional portion is a binary representation
     E3h
                 DIFFFrac  of one t4MHz period quantized to a 16-bit resolution. The maximum size of the fraction is FFFFh or
                           (216 - 1)/ 216 x t4MHZ.
www.maximintegrated.com                                                                                           Maxim Integrated │ 75


MAX35104                                                                                         Gas Flow Meter SoC
Table 31. Conversion Results Registers Description (continued)
 READ-ONLY
                REGISTER                                                 DESCRIPTION
  ADDRESS
                          Bit 15 thru Bit 8 holds the 8 bit value of the TOF_Range. The TOF_Range is an 8-bit binary integer
                          that indicates the range of valid error-free TOF_DIFF measurements that were made during
                          execution of either of the EVTMG1 or EVTMG2 commands. The maximum value of TOF_Range is
                          equal to 2 times the actual pulse launch period as configured by the Pulse Launch Divider bits in the
                          TOF1 register.
                              Bit15        Bit 14         Bit 13       Bit 12     Bit 11         Bit 10       Bit 9         Bit 8
                              MSB                                TOF_Range 8-bit binary integer                             LSB
                          The formulas to calculate the Range and Resolution of the TOF_Range integer for a given DPL[3:0]
                          bit setting are shown below:
                          Maximum Range (µs) = DPL[3:0] + 1 Resolution = Maximum Range / 256
                                                               LAUNCH             MAXIMUM RANGE                RESOLUTION
                                   DPL[3:0]
                    TOF_                                    FREQUENCY                     (µs)                        (ns)
                   Cycle_           0001b                        1 MHz                       2                       7.8175
     E4h           Count/           0002b                      666.6kHz                      3                      11.7185
                    TOF_
                   Range              ...                          ...                     ...                         ...
                                    1110b                      133.3kHz                     15                    58.59375
                                     1111b                      125kHz                      16                        62.5
                          Bit 7 to Bit 0 holds the 8-bit value of the TOF Cycle Count. The TOF Cycle Count is an 8-bit binary
                          integer that indicates the number of valid error-free cycles that either of the EVTMG1 or EVTMG2
                          commands has executed. It also represents the number of TOF_DIFF cycles that have been totaled
                          for the purpose of averaging, which affects the results provided in the TOF_DIFF_AVGFrac and
                          TOF_DIFF_AVGInt registers. It is incremented every time an error-free TOF_DIFF command is
                          executed by either the EVTMG1 or EVTMG2 sequence. Because of this internal error checking, once
                          the complete number of cycles defined by the TOF Difference Measurements bits in the Event Timing
                          1 register has been completed and the TOF_EVTMG bit has been set in the Interrupt Status register
                          causing the INT device pin to be asserted (if enabled), the TOF Cycle Count may not be equal to the
                          setting of the TOF Difference Measurements bits in the Event Timing 1 register.
                              Bit 7         Bit 6         Bit 5        Bit 4       Bit 3         Bit 2        Bit 1         Bit 0
                              MSB                             TOF Cycle Count 8-bit binary integer                          LSB
                          16-bit fixed-point two’s-complement integer portion of the average of the accumulated TOF_DIFF
                          measurements. It is computed as:
                TOF_DIFF_
     E5h
                   AVGInt
                          This integer represents the number of t4MHz periods that contribute to the computation. The
                          maximum size of the integer is 7FFFh or (215 - 1) x t4MHZ. The minimum size of this integer is 8000h
                          or -215 x t4MHZ.
                          16-bit fractional portion of the two’s complement average of the accumulated TOF_DIFF
                TOF_DIFF_
     E6h                  measurements. This fractional portion is a binary representation of one t4MHz period quantized to a
                  AVGFrac
                          16-bit resolution. The maximum size of the fraction is FFFFh or (216 - 1)/ 216 x t4MHZ.
www.maximintegrated.com                                                                                      Maxim Integrated │ 76


MAX35104                                                                                          Gas Flow Meter SoC
Table 31. Conversion Results Registers Description (continued)
 READ-ONLY
                REGISTER                                                 DESCRIPTION
  ADDRESS
                           15-bit fixed-point integer value of the time taken to discharge the timing capacitor through the
                           temperature sensing element connected to the T1 device pin. This integer portion is a binary
     E7h            T1Int
                           representation of the number of t4MHz periods that contribute to the time results. The maximum size
                           of the integer is 7FFFh or (215 - 1) x t4MHZ.
                           16-bit fractional value of the time taken to charge the timing capacitor through the temperature
                           sensing element connected to the T1 device pin. This fractional portion is a binary representation
     E8h          T1Frac
                           of one t4MHz period quantized to a 16-bit resolution. The maximum size of the fraction is FFFFh or
                           (216 - 1)/ 216 x t4MHZ.
                           15-bit fixed-point integer value of the time taken to charge the timing capacitor through the
                           temperature sensing element connected to the T2 device pin. This integer portion is a binary
     EBh            T2Int
                           representation of the number of t4MHz periods that contribute to the time results. The maximum size
                           of the integer is 7FFFh or (215 - 1) x t4MHZ.
                           16-bit fractional value of the time taken to charge the timing capacitor through the temperature
                           sensing element connected to the T2 device pin. This fractional portion is a binary representation
     ECh          T2Frac
                           of one t4MHz period quantized to a 16-bit resolution. The maximum size of the fraction is FFFFh or
                           (216 - 1)/ 216 x t4MHZ.
                           The Temp Cycle Count is an 8-bit binary integer that indicates the number of valid error-free cycles
                           that either of the EVTMG1 or EVTMG3 commands has executed. It also represents the number of
                           Temperature cycles that have been totaled for the purpose of averaging, which affects the results
                           provided in the Tx_AVGFrac and Tx_AVGInt registers. It is incremented every time an error-free
                           Temperature command is executed by either the EVTMG1 or EVTMG3 sequence. Because of
                           this internal error checking, once the complete number of cycles defined by the Temperature
                           Measurements bits in the Event Timing 2 register has been completed and the Temp_EVTMG bit
                   Temp_   has been set in the Interrupt Status register causing the INT device pin to be asserted (if enabled),
     EFh           Cycle_  the Temp Cycle Count may not be equal to the setting of the Temperature Measurements bits in the
                   Count   Event Timing 2 register.
                              Bit15         Bit 14        Bit 13       Bit 12        Bit 11       Bit 10       Bit 9        Bit 8
                                 X             X             X            X            X            X            X            X
                               Bit 7         Bit 6         Bit 5        Bit 4        Bit 3        Bit 2        Bit 1        Bit 0
                               MSB                                     Temp Cycle Count                                     LSB
                           15-bit fixed-point integer value of the average of the T1 port measurements. It is computed as:
     F0h         T1_AVGInt
                           This integer portion is a binary representation of the number of t4MHz periods that contribute to the
                           time results. The maximum size of the integer is 7FFFh or (215 - 1) x t4MHZ.
                           16-bit fractional portion of the average of the T1 port measurements. This fractional portion is a binary
                  T1_AVG
     F1h                   representation of one t4MHz period quantized to a 16-bit resolution. The maximum size of the fraction
                    Frac
                           is FFFFh or (216 - 1)/ 216 x t4MHZ.
www.maximintegrated.com                                                                                        Maxim Integrated │ 77


MAX35104                                                                                           Gas Flow Meter SoC
Table 31. Conversion Results Registers Description (continued)
 READ-ONLY
                REGISTER                                                   DESCRIPTION
  ADDRESS
                             15-bit fixed-point integer value of the average of the T2 port measurements. It is computed as:
     F4h         T2_AVGInt
                             This integer portion is a binary representation of the number of t4MHz periods that contribute to the
                             time results. The maximum size of the integer is 7FFFh or (215 - 1) x t4MHZ.
                             16-bit fractional portion of the average of the T2 port measurements. This fractional portion is a binary
                  T2_AVG
     F5h                     representation of one t4MHz period quantized to a 16-bit resolution. The maximum size of the fraction
                    Frac
                             is FFFFh or (216 - 1)/ 216 x t4MHZ.
                             15-bit fixed-point integer value of the time taken to measure the period of the 32.768kHz crystal
                 Calibration oscillator during execution of the Calibrate command. This integer portion is a binary representation
     F8h
                     Int     of the number of t4MHz periods that contribute to the time results. The maximum size of the integer is
                             7FFFh or (215 - 1) x t4MHZ.
                             16-bit fractional value of the time taken to measure the period of the 32.768kHz crystal oscillator
                 Calibration during execution of the Calibrate command. This fractional portion is a binary representation of
     F9h
                    Frac     one t4MHz period quantized to a 16-bit resolution. The maximum size of the fraction is FFFFh or
                             (216 - 1)/ 216 x t4MHZ.
     FAh                     Reserved
     FBh                     Reserved
     FCh                     Reserved
     FDh                     Reserved
www.maximintegrated.com                                                                                         Maxim Integrated │ 78


MAX35104                                                                              Gas Flow Meter SoC
Ordering Information                                 Package Information
       PART            TEMP RANGE        PIN-PACKAGE For the latest package outline information and land patterns
                                                     (footprints), go to www.maximintegrated.com/packages. Note
 MAX35104ETL+        -40°C to +85°C      40 TQFN-EP* that a “+”, “#”, or “-” in the package code indicates RoHS status
 MAX35104ETL+T       -40°C to +85°C      40 TQFN-EP* only. Package drawings may show a different suffix character, but
                                                     the drawing pertains to the package regardless of RoHS status.
+Denotes a lead(Pb)-free/RoHS-compliant package.
T = Tape and reel.                                      PACKAGE           PACKAGE         OUTLINE          LAND
                                                           TYPE               CODE           NO.       PATTERN NO.
*EP = Exposed pad.
                                                       40 TQFN-EP           T4055+2       21-0140         90-0016
Chip Information
PROCESS: CMOS
www.maximintegrated.com                                                                          Maxim Integrated │ 79


MAX35104                                                                                                                    Gas Flow Meter SoC
Revision History
  REVISION           REVISION                                                                                                                       PAGES
                                                                             DESCRIPTION
   NUMBER               DATE                                                                                                                     CHANGED
        0                3/16        Initial release                                                                                                    —
        1                6/17        Corrected measurement range and clarified notes about measurement accuracy                                      1, 35
        2                7/17        Updated ESD specification                                                                                          2
        3               12/17        Corrected register address for T2, removed references to T3 and T4                                           71, 77, 78
For pricing, delivery, and ordering information, please contact Maxim Direct at 1-888-629-4642, or visit Maxim Integrated’s website at www.maximintegrated.com.
Maxim Integrated cannot assume responsibility for use of any circuitry other than circuitry entirely embodied in a Maxim Integrated product. No circuit patent licenses
are implied. Maxim Integrated reserves the right to change the circuitry and specifications without notice at any time. The parametric values (min and max limits)
shown in the Electrical Characteristics table are guaranteed. Other parametric values quoted in this data sheet are provided for guidance.
Maxim Integrated and the Maxim Integrated logo are trademarks of Maxim Integrated Products, Inc.                 © 2017 Maxim Integrated Products, Inc. │ 80


Mouser Electronics
Authorized Distributor
Click to View Pricing, Inventory, Delivery & Lifecycle Information:
Maxim Integrated:
 MAX35104ETL+ MAX35104ETL+T
